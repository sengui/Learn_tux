<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>

<!-- LOCALIZATION RELATED INFORMATION -->
<meta name="LOC_PROJ_ID" content="WLPF8.1" />
<meta name="LOC_OWNER" content="BEAJ" />
<meta name="LOC_STATUS" content="READY!" />
<meta name="LOC_COMMENT" content="LOC_COMMENT" />
<meta name="LOC_US_REV" content="1" />
<meta name="LOC_US_CHANGE" content="41263" />
<meta name="LOC_US_SRCFILE" content="//depot/tuxedo/tux11gr1/qgd/fm/qcblpgm.fm" />
<!-- LOCALIZATION RELATED INFORMATION -->

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta name="GENERATOR" content="Quadralay WebWorks AutoMap 2003 Platinum Edition for FrameMaker 8.6.6577.0" />
    <meta name="TEMPLATEBASE" content="BEA_WFP_Template_V1.04" />
    <meta name="LASTUPDATED" content="11/28/11 08:26:30" />
    <link rel="StyleSheet" href="/global_resources/edocs.css" type="text/css" media="all" />

<title>Oracle Tuxedo /Q COBOL Language Programming</title>

<!-- BEA scripts begin -->

<script language="Javascript" src="/global_resources/js/banner.js" type="text/javascript"></script>
<!-- This script outputs the banner required for edocs documentation. -->

<script language="Javascript" src="floatwin.js" type="text/javascript"></script>
<!-- This script opens a new small floating window and puts TOC<i>&lt;name&gt;</i>.html and IX<i>&lt;name&gt;</i>.html files in it and sets a generic popup window code to enable the display of some viewlets in the WebLogic Platform Tour. -->

<script language="Javascript1.1" src="/global_resources/js/footer.js" type="text/javascript"></script>
<!-- This script outputs the footer with the correct copyright date and link to copyright page.-->

<script language="Javascript1.1" src="/global_resources/js/googlesearch4.js" type="text/javascript"></script>
<!-- This script outputs the google search form. -->

<script language="Javascript1.1" src="/global_resources/js/note.js" type="text/javascript"></script>
<!-- This script outputs a note such as a BETA note. -->

<script language="JavaScript1.1" src="/global_resources/js/search.js" type="text/javascript"></script>
<!-- This script is not for online documents. It is only used by the QuestAgent Java Applet for CD search indexes. -->

<!-- BEA scripts end -->

  </head>

  <body>


<script language="Javascript1.1" type="text/javascript">
GoogleURL();
</script><noscript>This script outputs the google search URL required for search on edocs documentation.</noscript>

<script language="Javascript1.1" type="text/javascript">
Banner();
</script><noscript>This script outputs the banner required for edocs documentation.</noscript>

<script language="Javascript1.1" type="text/javascript">
GoogleSearchCollection();
</script><noscript>This script outputs the google search parameters required for search on edocs documentation.</noscript>

<!-- page title -->
<h1 class="booktitle">Using the ATMI /Q Component
</h1>
<!-- page title end -->

    <table id="SummaryNotReq1" width="100%" border="0" align="left" cellpadding="2%" cellspacing="0">
      <tr> 
        <td>
&nbsp;&nbsp;&nbsp;&nbsp;
<a accesskey="4" href="qpgm.html"><img id="LongDescNotReq1" src="/global_resources/images/doc_nav_prev.gif" border="0" alt="Previous" /></a>&nbsp;
<a accesskey="5" href="qsimp.html"><img id="LongDescNotReq2" src="/global_resources/images/doc_nav_next.gif" border="0" alt="Next" /></a>&nbsp;
<img id="LongDescNotReq3" src="/global_resources/images/doc_nav_dots.gif" border="0" alt="" />&nbsp;
<a accesskey="1" href="javascript:OpenWindowToc();" onmouseover="window.status='Table of Contents'; return true" onfocus="window.status='Table of Contents'; return true" onmouseout="window.status=''; return true" onblur="window.status=''; return true" title="Open TOC in new window">      <img id="LongDescNotReq4" src="/global_resources/images/doc_nav_contents.gif" alt="Open TOC in new window" border="0" /></a>&nbsp;
&nbsp;
<a href="../pdf/qgd.pdf" target="pdf"><img id="LongDescNotReq5" src="/global_resources/images/doc_nav_pdf.gif" width="59" height="44" alt="View as PDF - New Window" title="View as PDF - New Window" border="0" /></a>&nbsp;
<a href="http://www.adobe.com/products/acrobat/alternate.html" target="_blank"><img id="LongDescNotReq6" src="/global_resources/images/get_reader.gif" width="52" height="44" alt="Get Adobe Reader - New Window" title="Get Adobe Reader - New Window" border="0" /></a>
<a name="link_group_0"></a>
	</td>
      </tr>
    </table>

<a name="skipnav" title="Content starts here"><img src="/global_resources/images/_.gif" alt="Content starts here" border="0" height="1" width="1" /></a>



<h1 class="pChapHead"><a name="wp1020475"> </a>
Oracle Tuxedo /Q COBOL Language Programming
</h1>
<p class="pBody"><a name="wp1019089"> </a>
This topic includes the following sections:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1012581"> </a><a href="qcblpgm.html#wp1012746">Introduction</a></li>
<li><a name="wp1013201"> </a><a href="qcblpgm.html#wp1003609">Prerequisite Knowledge</a></li>
<li><a name="wp1013283"> </a><a href="qcblpgm.html#wp1003614">Where Requests Can Originate</a></li>
<li><a name="wp1013320"> </a><a href="qcblpgm.html#wp1003623">Emphasis on the Default Case</a></li>
<li><a name="wp1013357"> </a><a href="qcblpgm.html#wp1003635">Enqueuing Messages</a></li>
<li><a name="wp1013386"> </a><a href="qcblpgm.html#wp1003979">Dequeuing Messages</a></li>
<li><a name="wp1013415"> </a><a href="qcblpgm.html#wp1004300">Sequential Processing of Messages</a></li>
</ul></div>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1012746"> </a>
Introduction
</h2><p class="pBody"><a name="wp1012747"> </a>
This topic provides information about using the ATMI COBOL language functions for enqueuing and dequeuing messages: <a href="../rf3cbl/rf3cbl.html">TPENQUEUE(3cbl)</a> and <a href="../rf3cbl/rf3cbl.html">TPDEQUEUE(3cbl)</a>, plus some ancillary functions.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1003609"> </a>
Prerequisite Knowledge
</h2><p class="pBody"><a name="wp1003610"> </a>
The Oracle Tuxedo programmer coding client or server programs for the queued message facility should be familiar with the COBOL language binding to the Oracle Tuxedo ATMI. General guidance on Oracle Tuxedo programming is available in <em class="cEmphasis">Programming Oracle Tuxedo ATMI Applications Using COBOL</em>. Detailed pages on all the ATMI functions are in the <em class="cEmphasis">Oracle Tuxedo ATMI COBOL Function Reference</em>.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1003614"> </a>
Where Requests Can Originate
</h2><p class="pBody"><a name="wp1003615"> </a>
The calls used to place a message on an Oracle Tuxedo /Q queue can originate from any client or server process associated with the application. The list includes: 
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1004461"> </a>Clients or servers on the same machine as the queue space or on another machine on the network</li>
<li><a name="wp1004472"> </a>Conversational programs, although you cannot have a conversational connection with a queue (or with the <a href="../rf5/rf5.html">TMQUEUE(5)</a> server)</li>
<li><a name="wp1004477"> </a>Workstation clients via a surrogate process on the native side; the administrative interface is also entirely on the native side</li>
</ul></div>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1003623"> </a>
Emphasis on the Default Case
</h2><p class="pBody"><a name="wp1003624"> </a>
The discussion of Oracle Tuxedo /Q programming in this topic primarily reflects the client-side portion of the figure <a href="qoview.html#wp1006699">Queued Service Invocation</a>. The figure shows how a client (or a process acting in the role of a client) queues a message by calling <a href="../rf3cbl/rf3cbl.html">TPENQUEUE(3cbl)</a> and specifying a queue space made available through a <a href="../rf5/rf5.html">TMQUEUE(5)</a> server. The client later retrieves a reply via a <a href="../rf3cbl/rf3cbl.html">TPDEQUEUE(3cbl)</a> call to <code class="cCode">TMQUEUE</code>.
</p>
<p class="pBody"><a name="wp1003628"> </a>
The figure shows the queued message being dequeued by the server <a href="../rf5/rf5.html">TMQFORWARD(5)</a> and sent to an application server for processing (via <a href="../rf3cbl/rf3cbl.html">TPCALL(3cbl)</a>). When a reply to <code class="cCode">TPCALL</code> is received, <code class="cCode">TMQFORWARD</code> enqueues the reply message. Because <code class="cCode">TMQFORWARD</code> provides an interface between the queue space and existing application services, further application coding is not required. For that reason, this topic concentrates on the client-to-queue space side.
</p>
<p class="pBody"><a name="wp1003634"> </a>
Some examples of customization are given after the discussion of the basic model.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1003635"> </a>
Enqueuing Messages
</h2><p class="pBody"><a name="wp1003636"> </a>
The syntax for <code class="cCode">TPENQUEUE()</code> is as follows:
</p>
<a name="wp1003637"> </a><div class="pPreformatted"><pre>01 <span style="font-style: italic">TPQUEDEF-REC</span>.<br />   COPY TPQUEDEF.<br />01 <span style="font-style: italic">TPTYPE-REC</span>.<br />   COPY TPTYPE.<br />01 <span style="font-style: italic">DATA-REC</span>.<br />   COPY User Data.<br />01 <span style="font-style: italic">TPSTATUS-REC</span>.<br />   COPY TPSTATUS.<br />CALL &quot;TPENQUEUE&quot; USING <span style="font-style: italic">TPQUEDEF-REC</span> <span style="font-style: italic">TPTYPE-REC</span> <span style="font-style: italic">DATA-REC</span> <span style="font-style: italic">TPSTATUS-REC</span>.</pre></div><p class="pBody"><a name="wp1003646"> </a>
When a <code class="cCode">TPENQUEUE()</code> call is issued it tells the system to store a message on the queue identified in <code class="cCode">QNAME</code> in <code class="cCodeEmphasis">TPQUEDEF-REC</code> in the space identified in <code class="cCode">QSPACE-NAME</code> in <code class="cCodeEmphasis">TPQUEDEF-REC</code>. The message is in <code class="cCodeEmphasis">DATA-REC</code>, and <code class="cCode">LEN</code> in <code class="cCodeEmphasis">TPTYPE-REC</code> has the length of the message. By the use of settings in <code class="cCodeEmphasis">TPQUEDEF-REC</code>, the system is informed how the call to <code class="cCode">TPENQUEUE()</code> is to be handled. Further information about the handling of the enqueued message and replies is provided in the <code class="cCodeEmphasis">TPQUEDEF-REC</code> structure.
</p>
<h3 class="pHeading2"><a name="wp1003652"> </a>
TPENQUEUE() Arguments
</h3>
<p class="pBody"><a name="wp1003653"> </a>
There are some important arguments to control the operation of <a href="../rf3cbl/rf3cbl.html">TPENQUEUE(3cbl)</a>. Lets look at some of them.
</p>
<h4 class="pHeading3"><a name="wp1003655"> </a>
TPENQUEUE(): The QSPACE-NAME in TPQUEDEF-REC Argument
</h4>
<p class="pBody"><a name="wp1003656"> </a>
<code class="cCode">QSPACE-NAME</code> identifies a queue space previously created by the administrator. When a server is defined in the <code class="cCode">SERVERS</code> section of the configuration file, the service names it offers are aliases for the actual queue space name (which is specified as part of the <code class="cCode">OPENINFO</code> parameter in the <code class="cCode">GROUPS</code> section). For example, when your application uses the server <code class="cCode">TMQUEUE</code>, the value pointed at by <code class="cCode">QSPACE-NAME</code> is the name of a service advertised by <code class="cCode">TMQUEUE</code>. If no service aliases are defined, the name of the default service is the same as the server name, <code class="cCode">TMQUEUE</code>. In this case the configuration file might include the following:
</p>
<a name="wp1007391"> </a><div class="pPreformatted"><pre>TMQUEUE<br />        SRVGRP = QUE1  SRVID = 1<br />        GRACE = 0  RESTART = Y CONV = N<br />        CLOPT = &quot;-A&quot;<br />or<br />        CLOPT = &quot;-s TMQUEUE&quot;</pre></div><p class="pBody"><a name="wp1003669"> </a>
The entry for server group <code class="cCode">QUE1</code> has an <code class="cCode">OPENINFO</code> parameter that specifies the resource manager, the pathname of the device and the queue space name. The <code class="cCode">QSPACE-NAME</code> argument in a client program then looks like this:
</p>
<a name="wp1003672"> </a><div class="pPreformatted"><pre> 01  TPQUEDEF-REC.<br />     COPY TPQUEDEF.<br /> 01  TPTYPE-REC.<br />     COPY TPTYPE.<br /> 01  TPSTATUS-REC.<br />     COPY TPSTATUS.<br /> 01  USER-DATA-REC  PIC X(100).<br />*<br />*<br />*<br /> MOVE LOW-VALUES TO TPQUEDEF-REC.<br /> MOVE &quot;TMQUEUE&quot; TO QSPACE-NAME IN TPQUEDEF-REC.<br /> MOVE &quot;STRING&quot; TO QNAME IN TPQUEDEF-REC.<br /> SET TPTRAN IN TPQUEDEF-REC TO TRUE.<br /> SET TPBLOCK IN TPQUEDEF-REC TO TRUE.<br /> SET TPTIME IN TPQUEDEF-REC TO TRUE.<br /> SET TPSIGRSTRT IN TPQUEDEF-REC TO TRUE.<br /> MOVE LOW-VALUES TO TPTYPE-REC.<br /> MOVE &quot;STRING&quot; TO REC-TYPE IN TPTYPE-REC.<br /> MOVE LENGTH OF USER-DATA-REC TO LEN IN TPTYPE-REC.<br /> CALL &quot;TPENQUEUE&quot; USING<br />         TPQUEDEF-REC<br />         TPTYPE-REC<br />         USER-DATA-REC<br />         TPSTATUS-REC.</pre></div><p class="pBody"><a name="wp1003697"> </a>
The example shown on the <a href="../rf5/rf5.html">TMQUEUE(5)</a> reference page shows how alias service names can be included when the server is built and specified in the configuration file. The sample program in <a href="qsimp.html">A Sample Application</a>, also specifies an alias service name. 
</p>
<h4 class="pHeading3"><a name="wp1003700"> </a>
TPENQUEUE(): The QNAME in TPQUEDEF-REC Argument
</h4>
<p class="pBody"><a name="wp1003701"> </a>
When message queues are being used within a queue space to invoke services, they are named according to application services that process the requests. <code class="cCode">QNAME</code> contains such a value; an exception in which <code class="cCode">QNAME</code> is not an application service is described in <a href="qcblpgm.html#wp1004267">Procedure for Dequeuing Replies from Services Invoked Through TMQFORWARD</a>.
</p>
<h4 class="pHeading3"><a name="wp1003704"> </a>
TPENQUEUE(): The DATA-REC and LEN in TPTYPE-REC Arguments
</h4>
<p class="pBody"><a name="wp1003705"> </a>
<code class="cCodeEmphasis">DATA-REC</code> contains the message to be processed. <code class="cCode">LEN</code> in <code class="cCodeEmphasis">TPTYPE-REC</code> gives the length of the message. Some Oracle Tuxedo record types (<code class="cCode">VIEW</code>, for example) do not require <code class="cCode">LEN</code> to be specified; in such cases, the argument is ignored. If <code class="cCode">RECTYPE</code> in <code class="cCodeEmphasis">TPTYPE-REC</code> is <code class="cCode">SPACES</code>, <code class="cCodeEmphasis">DATA-REC</code> and <code class="cCode">LEN</code> are ignored and the message is enqueued with no data portion.
</p>
<h4 class="pHeading3"><a name="wp1003709"> </a>
TPENQUEUE(): The Settings in TPQUEDEF-REC
</h4>
<p class="pBody"><a name="wp1003710"> </a>
Settings in <code class="cCodeEmphasis">TPQUEDEF-REC</code> are used to tell the Oracle Tuxedo system how the <code class="cCode">TPENQUEUE()</code> call is handled; the following are valid settings: 
</p>
<h4 class="pDefTerm"><a name="wp1003712"> </a>
<code class="cCode">TPNOTRAN</code> 
</h4><div class="pDefPara"><a name="wp1014343"> </a>
If the caller is in transaction mode and this setting is used, the message is not enqueued within the caller&#8217;s transaction. A caller in transaction mode that sets this to true is still subject to the transaction timeout (and no other). If message enqueuing fails that was invoked with this setting, the caller&#8217;s transaction is not affected. Either <code class="cCode">TPNOTRAN</code> or <code class="cCode">TPTRAN</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1003715"> </a>
<code class="cCode">TPTRAN</code> 
</h4><div class="pDefPara"><a name="wp1003716"> </a>
If the caller is in transaction mode, this setting specifies that the enqueuing of the message is to be done within the same transaction. Either <code class="cCode">TPNOTRAN</code> or <code class="cCode">TPTRAN</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1003718"> </a>
<code class="cCode">TPNOBLOCK</code> 
</h4><div class="pDefPara"><a name="wp1014367"> </a>
The message is not enqueued if a blocking condition exists. If <code class="cCode">TPNOBLOCK</code> is set and a blocking condition exists such as the internal buffers into which the message is transferred are full, the call fails and <a href="../rf5/rf5.html">tperrno(5)</a> is set to <code class="cCode">TPEBLOCK</code>. If <code class="cCode">TPNOBLOCK</code> is set and a blocking condition exists because the target queue is opened <em class="cEmphasis">exclusively</em> by another application, the call fails, <code class="cCode">tperrno()</code> is set to <code class="cCode">TPEDIAGNOSTIC</code>, and the diagnostic field of the <code class="cCode">TPQCTL</code> structure is set to <code class="cCode">QMESHARE</code>. In the latter case, the other application, which is based on an Oracle product other than the Oracle Tuxedo system, opened the queue for exclusive read and/or write using the Queuing Services API (QSAPI). Either <code class="cCode">TPNOBLOCK</code> or <code class="cCode">TPBLOCK</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1003721"> </a>
<code class="cCode">TPBLOCK</code> 
</h4><div class="pDefPara"><a name="wp1003722"> </a>
When <code class="cCode">TPBLOCK</code> is set and a blocking condition exists, the caller blocks until the condition subsides or a timeout occurs (either transaction or blocking timeout). Either <code class="cCode">TPNOBLOCK</code> or <code class="cCode">TPBLOCK</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1003724"> </a>
<code class="cCode">TPNOTIME</code> 
</h4><div class="pDefPara"><a name="wp1003725"> </a>
This setting asks that the call be immune to blocking timeouts; transaction timeouts may still occur. Either <code class="cCode">TPNOTIME</code> or <code class="cCode">TPTIME</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1003727"> </a>
<code class="cCode">TPTIME</code> 
</h4><div class="pDefPara"><a name="wp1003728"> </a>
This setting asks that the call will receive blocking timeouts. Either <code class="cCode">TPNOTIME</code> or <code class="cCode">TPTIME</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1003730"> </a>
<code class="cCode">TPSIGRSTRT</code> 
</h4><div class="pDefPara"><a name="wp1003731"> </a>
This setting says that any underlying system calls that are interrupted by a signal should be reissued. Either <code class="cCode">TPSIGRSTRT</code> or <code class="cCode">TPNOSIGRSTRT</code> must be set. 
</div>
<h4 class="pDefTerm"><a name="wp1003733"> </a>
<code class="cCode">TPNOSIGRSTRT</code> 
</h4><div class="pDefPara"><a name="wp1003734"> </a>
This setting says that any underlying system calls that are interrupted by a signal should not be reissued. The call fails and sets <code class="cCode">TP-STATUS</code> to <code class="cCode">TPEGOTSIG</code>. Either <code class="cCode">TPSIGRSTRT</code> or <code class="cCode">TPNOSIGRSTRT</code> must be set.
</div>
<h3 class="pHeading2"><a name="wp1003737"> </a>
TPQUEDEF-REC Structure
</h3>
<p class="pBody"><a name="wp1009306"> </a>
The <code class="cCodeEmphasis">TPQUEDEF-REC</code> structure has members that are used by the application and by the Oracle Tuxedo system to pass parameters in both directions between application programs and the queued message facility. It is defined in the COBOL <code class="cCode">COPY</code> file. The client that calls <code class="cCodeEmphasis">TPQUEDEF-REC</code> uses settings to mark members the application wants the system to fill in. The structure is also used by <code class="cCode">TPDEQUEUE()</code>; some of the members do not come into play until the application calls that function. The complete structure is shown in <a href="qcblpgm.html#wp1009311">Listing&#160;4-1</a>.
</p>
<div class="pCodeTitle"><a name="wp1009311"> </a>
Listing&#160;4-1	   The TPQUEDEF-REC Structure
</div> <a name="wp1009457"> </a><div class="pPreformatted"><pre><code class="cCode">        05 TPBLOCK-FLAG         PIC S9(9) COMP-5.<br />                88 TPBLOCK              VALUE 0.<br />                88 TPNOBLOCK            VALUE 1.<br />        05 TPTRAN-FLAG  PIC S9(9) COMP-5.<br />                88 TPTRAN               VALUE 0.<br />                88 TPNOTRAN             VALUE 1.<br />        05 TPTIME-FLAG  PIC S9(9) COMP-5.<br />                88 TPTIME               VALUE 0.<br />                88 TPNOTIME             VALUE 1.<br />        05 TPSIGRSTRT-FLAG      PIC S9(9) COMP-5.<br />                88 TPNOSIGRSTRT         VALUE 0.<br />                88 TPSIGRSTRT           VALUE 1.<br />        05 TPNOCHANGE-FLAG      PIC S9(9) COMP-5.<br />                88 TPCHANGE             VALUE 0.<br />                88 TPNOCHANGE           VALUE 1.<br />        05 TPQUE-ORDER-FLAG     PIC S9(9) COMP-5.<br />                88 TPQDEFAULT           VALUE 0.<br />                88 TPQTOP               VALUE 1.<br />                88 TPQBEFOREMSGID       VALUE 2.<br />        05 TPQUE-TIME-FLAG      PIC S9(9) COMP-5.<br />                88 TPQNOTIME            VALUE 0.<br />                88 TPQTIME-ABS          VALUE 1.<br />                88 TPQTIME-REL          VALUE 2.<br />        05 TPQUE-PRIORITY-FLAG  PIC S9(9) COMP-5.<br />                88 TPQNOPRIORITY        VALUE 0.<br />                88 TPQPRIORITY          VALUE 1.<br />        05 TPQUE-CORRID-FLAG    PIC S9(9) COMP-5.<br />                88 TPQNOCORRID          VALUE 0.<br />                88 TPQCORRID            VALUE 1.<br />        05 TPQUE-REPLYQ-FLAG    PIC S9(9) COMP-5.<br />                88 TPQNOREPLYQ          VALUE 0.<br />                88 TPQREPLYQ            VALUE 1.<br />        05 TPQUE-FAILQ-FLAG     PIC S9(9) COMP-5.<br />                88 TPQNOFAILUREQ        VALUE 0.<br />                88 TPQFAILUREQ          VALUE 1.<br />        05 TPQUE-MSGID-FLAG     PIC S9(9) COMP-5.<br />                88 TPQNOMSGID           VALUE 0.<br />                88 TPQMSGID             VALUE 1.<br />        05 TPQUE-GETBY-FLAG     PIC S9(9) COMP-5.<br />                88 TPQGETNEXT           VALUE 0.<br />                88 TPQGETBYMSGIDOLD     VALUE 1.<br />                88 TPQGETBYCORRIDOLD    VALUE 2.<br />                88 TPQGETBYMSGID        VALUE 3.<br />                88 TPQGETBYCORRID       VALUE 4.<br />        05 TPQUE-WAIT-FLAG      PIC S9(9) COMP-5.<br />                88 TPQNOWAIT            VALUE 0.<br />                88 TPQWAIT              VALUE 1.<br />        05 TPQUE-DELIVERY-FLAG  PIC S9(9) COMP-5.<br />                88 TPQNODELIVERYQOS     VALUE 0.<br />                88 TPQDELIVERYQOS       VALUE 1.<br />        05 TPQUEQOS-DELIVERY-FLAG       PIC S9(9) COMP-5.<br />                88 TPQQOSDELIVERYDEFAULTPERSIST VALUE 0.<br />                88 TPQQOSDELIVERYPERSISTENT     VALUE 1.<br />                88 TPQQOSDELIVERYNONPERSISTENT  VALUE 2.<br />        05 TPQUE-REPLY-FLAG     PIC S9(9) COMP-5.<br />                88 TPQNOREPLYQOS                VALUE 0.<br />                88 TPQREPLYQOS                  VALUE 1.<br />        05 TPQUEQOS-REPLY-FLAG  PIC S9(9) COMP-5.<br />                88 TPQQOSREPLYDEFAULTPERSIST    VALUE 0.<br />                88 TPQQOSREPLYPERSISTENT        VALUE 1.<br />                88 TPQQOSREPLYNONPERSISTENT     VALUE 2.<br />        05 TPQUE-EXPTIME-FLAG   PIC S9(9) COMP-5.<br />                88 TPQNOEXPTIME         VALUE 0.<br />                88 TPQEXPTIME-ABS       VALUE 1.<br />                88 TPQEXPTIME-REL       VALUE 2.<br />                88 TPQEXPTIME-NONE      VALUE 3.<br />        05 TPQUE-PEEK-FLAG      PIC S9(9) COMP-5.<br />                88 TPQNOPEEK            VALUE 0.<br />                88 TPQPEEK              VALUE 1.<br />        05 DIAGNOSTIC           PIC S9(9) COMP-5.<br />                88 QMEINVAL             VALUE -1.<br />                88 QMEBADRMID           VALUE -2.<br />                88 QMENOTOPEN           VALUE -3.<br />                88 QMETRAN              VALUE -4.<br />                88 QMEBADMSGID          VALUE -5.<br />                88 QMESYSTEM            VALUE -6.<br />                88 QMEOS                VALUE -7.<br />                88 QMEABORTED           VALUE -8.<br />                88 QMEPROTO             VALUE -9.<br />                88 QMEBADQUEUE          VALUE -10.<br />                88 QMENOMSG             VALUE -11.<br />                88 QMEINUSE             VALUE -12.<br />                88 QMENOSPACE           VALUE -13.<br />                88 QMERELEASE           VALUE -14.<br />                88 QMEINVHANDLE         VALUE -15.<br />                88 QMESHARE             VALUE -16.<br />        05 DEQ-TIME             PIC 9(9) COMP-5.<br />        05 EXP-TIME             PIC 9(9) COMP-5.<br />        05 PRIORITY             PIC S9(9) COMP-5.<br />        05 MSGID                PIC X(32).<br />        05 CORRID               PIC X(32).<br />        05 QNAME                PIC X(127).<br />        05 QSPACE-NAME          PIC X(127).<br />        05 REPLYQUEUE           PIC X(127).<br />        05 FAILUREQUEUE         PIC X(127).<br />        05 CLIENTID OCCURS 4 TIMES PIC S9(9) COMP-5.<br />        05 APPL-RETURN-CODE     PIC S9(9) COMP-5.<br />        05 APPKEY               PIC S9(9) COMP-5.</code></pre></div><p class="pBody"><a name="wp1014815"> </a>
The following is a list of valid settings for the parameters controlling input information for <code class="cCode">TPENQUEUE</code>.
</p>
<h4 class="pDefTerm"><a name="wp1014985"> </a>
<code class="cCode">TPQTOP</code> 
</h4><div class="pDefPara"><a name="wp1014986"> </a>
Setting this value indicates that the queue ordering be overridden and the message placed at the top of the queue. This request may not be granted depending on whether or not the queue was configured to allow overriding the queue ordering. Set <code class="cCode">TPQDEFAULT</code> to use default queue ordering. <code class="cCode">TPQTOP</code>, <code class="cCode">TPQBEFOREMSGID</code>, or <code class="cCode">TPQDEFAULT</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1014987"> </a>
<code class="cCode">TPQBEFOREMSGID</code> 
</h4><div class="pDefPara"><a name="wp1014988"> </a>
Setting this value indicates that the queue ordering be overridden and the message placed in the queue before the message identified by <code class="cCode">MSGID</code>. This request may not be granted depending on whether or not the queue was configured to allow overriding the queue ordering. Set <code class="cCode">TPQDEFAULT</code> to use default queue ordering. <code class="cCode">TPQTOP</code>, <code class="cCode">TPQBEFOREMSGID</code>, or <code class="cCode">TPQDEFAULT</code> must be set.
</div>
<div class="pDefParaCont"><a name="wp1017185"> </a>
Note that the entire 32 bytes of the message identifier value are significant, so the value identified by <code class="cCode">MSGID</code> must be completely initialized (for example, padded with spaces).
</div>
<h4 class="pDefTerm"><a name="wp1014989"> </a>
<code class="cCode">TPQTIME-ABS</code> 
</h4><div class="pDefPara"><a name="wp1014990"> </a>
If this value is set, the message is made available after the time specified by <code class="cCode">DEQ-TIME</code>. <code class="cCode">DEQ-TIME</code> is an absolute time value as generated by <code class="cCode">time</code>(2) or <code class="cCode">mktime(3C)</code> (the number of seconds since 00:00:00 Universal Coordinated Time&#8212;UTC, January 1, 1970). Set <code class="cCode">TPQNOTIME</code> if neither an absolute or relative time value is set. <code class="cCode">TPQTIME-ABS</code>, <code class="cCode">TPQTIME-REL</code>, or <code class="cCode">TPQNOTIME</code> must be set. The absolute time is determined by the clock on the machine where the queue manager process resides.
</div>
<h4 class="pDefTerm"><a name="wp1014991"> </a>
<code class="cCode">TPQTIME-REL</code> 
</h4><div class="pDefPara"><a name="wp1014992"> </a>
If this value is set, the message is made available after a time relative to the completion of the enqueuing operation. <code class="cCode">DEQ-TIME</code> specifies the number of seconds to delay after the enqueuing completes before the submitted message should be available. Set <code class="cCode">TPQNOTIME</code> if neither an absolute or relative time value is set. <code class="cCode">TPQTIME-ABS</code>, <code class="cCode">TPQTIME-REL</code>, or <code class="cCode">TPQNOTIME</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1014993"> </a>
<code class="cCode">TPQPRIORITY</code> 
</h4><div class="pDefPara"><a name="wp1014994"> </a>
If this value is set, the priority at which the message should be enqueued is stored in <code class="cCode">PRIORITY</code>. The priority must be in the range 1 to 100, inclusive. The higher the number, the higher the priority (that is, a message with a higher number is dequeued before a message with a lower number). For queues not ordered by priority, this value is informational. If <code class="cCode">TPQNOPRIORITY</code> is set, the priority for the message is 50 by default.
</div>
<h4 class="pDefTerm"><a name="wp1014995"> </a>
<code class="cCode">TPQCORRID</code> 
</h4><div class="pDefPara"><a name="wp1014996"> </a>
If this value is set, the correlation identifier value specified in <code class="cCode">CORRID</code> is available when a message is dequeued with <code class="cCode">TPDEQUEUE()</code>. This identifier accompanies any reply or failure message that is queued so that an application can correlate a reply with a particular request. Set <code class="cCode">TPQNOCORRID</code> if a correlation identifier is not available.
</div>
<div class="pDefParaCont"><a name="wp1017305"> </a>
Note that the entire 32 bytes of the correlation identifier value are significant, so the value specified in <code class="cCode">CORRID</code> must be completely initialized (for example, padded with spaces).
</div>
<h4 class="pDefTerm"><a name="wp1014997"> </a>
<code class="cCode">TPQREPLYQ</code> 
</h4><div class="pDefPara"><a name="wp1014998"> </a>
If this value is set, a reply queue named in <code class="cCode">REPLYQUEUE</code> is associated with the queued message. Any reply to the message is queued to the named queue within the same queue space as the request message. Set <code class="cCode">TPQNOREPLYQ</code> if a reply queue name is not available.
</div>
<h4 class="pDefTerm"><a name="wp1014999"> </a>
<code class="cCode">TPQFAILUREQ</code> 
</h4><div class="pDefPara"><a name="wp1015000"> </a>
If this value is set, a failure queue named in <code class="cCode">FAILUREQUEUE</code> is associated with the queued message. If (1) the enqueued message is processed by <code class="cCode">TMQFORWARD()</code>, (2) <code class="cCode">TMQFORWARD</code> was started with the <code class="cCode">-d</code> option, and (3) the service fails and returns a non-NULL reply, a failure message consisting of the reply and its associated <code class="cCode">tpurcode</code> is enqueued to the named queue within the same queue space as the original request message. Set <code class="cCode">TPQNOFAILUREQ</code> if a failure queue name is not available.
</div>
<h4 class="pDefTerm"><a name="wp1015001"> </a>
<code class="cCode">TPQDELIVERYQOS<br />TPQREPLYQOS</code> 
</h4><div class="pDefPara"><a name="wp1015002"> </a>
If <code class="cCode">TPQDELIVERYQOS</code> is set, the flags specified by <code class="cCode">TPQUEQOS-DELIVERY-FLAG</code> control the quality of service for message delivery. One of the following mutually exclusive flags must be set: <code class="cCode">TPQQOSDELIVERYDEFAULTPERSIST</code>, <code class="cCode">TPQQOSDELIVERYPERSISTENT</code>, or <code class="cCode">TPQQOSDELIVERYNONPERSISTENT</code>. If <code class="cCode">TPQDELIVERYQOS</code> is not set, <code class="cCode">TPQNODELIVERYQOS</code> must be set. When <code class="cCode">TPQNODELIVERYQOS</code> is set, the default delivery policy of the target queue dictates the delivery quality of service for the message.
</div>
<div class="pDefParaCont"><a name="wp1015003"> </a>
If <code class="cCode">TPQREPLYQOS</code> is set, the flags specified by <code class="cCode">TPQUEQOS-REPLY-FLAG</code> control the quality of service for reply message delivery for any reply. One of the following mutually exclusive flags must be set: <code class="cCode">TPQQOSREPLYDEFAULTPERSIST</code>, <code class="cCode">TPQQOSREPLYPERSISTENT</code>, or <code class="cCode">TPQQOSREPLYNONPERSISTENT</code>. The <code class="cCode">TPQREPLYQOS</code> flag is used when a reply is returned from messages processed by <code class="cCode">TMQFORWARD</code>. Applications not using <code class="cCode">TMQFORWARD</code> to invoke services may use the <code class="cCode">TPQREPLYQOS</code> flag as a hint for their own reply mechanism.
<a name="wp1015004"> </a>
If <code class="cCode">TPQREPLYQOS</code> is not set, <code class="cCode">TPQNOREPLYQOS</code> must be set. When <code class="cCode">TPQNOREPLYQOS</code> is set, the default delivery policy of the <code class="cCode">REPLYQUEUE</code> queue dictates the delivery quality of service for any reply. Note that the default delivery policy is determined when the reply to a message is enqueued. That is, if the default delivery policy of the reply queue is modified between the time that the original message is enqueued and the reply to the message is enqueued, the policy used is the one in effect when the reply is finally enqueued.
<a name="wp1015005"> </a>
The valid <code class="cCode">TPQUEQOS-DELIVERY-FLAG</code> and <code class="cCode">TPQUEQOS-REPLY-FLAG</code> flags are:
</div>
<div class="pDefTerm2"><h4 class="pDefTerm2"><a name="wp1015006"> </a>
<code class="cCode">TPQQOSDELIVERYDEFAULTPERSIST<br />TPQQOSREPLYDEFAULTPERSIST</code> 
</h4></div>
<div class="pDefPara2"><a name="wp1015007"> </a>
These flags specify that the message is to be delivered using the default delivery policy specified on the target or reply queue.
</div><div class="pDefTerm2"><h4 class="pDefTerm2"><a name="wp1015008"> </a>
<code class="cCode">TPQQOSDELIVERYPERSISTENT<br />TPQQOSREPLYPERSISTENT</code> 
</h4></div>
<div class="pDefPara2"><a name="wp1015009"> </a>
These flags specify that the message is to be delivered in a persistent manner using the disk-based delivery method. When specified, these flags override the default delivery policy specified on the target or reply queue. 
</div><div class="pDefTerm2"><h4 class="pDefTerm2"><a name="wp1015010"> </a>
<code class="cCode">TPQQOSDELIVERYNONPERSISTENT<br />TPQQOSREPLYNONPERSISTENT</code> 
</h4></div>
<div class="pDefPara2"><a name="wp1015011"> </a>
These flags specify that the message is to be delivered in a non-persistent manner using the memory-based delivery method; the message is queued in memory until it is dequeued. When specified, these flags override the default delivery policy specified on the target or reply queue.
</div><div class="pDefPara2"><a name="wp1015012"> </a>
If the caller is transactional, non-persistent messages are enqueued within the caller&#8217;s transaction, however, non-persistent messages are lost if the system is shut down or crashes or the IPC shared memory for the queue space is removed.
</div><h4 class="pDefTerm"><a name="wp1015871"> </a>
<code class="cCode">TPQEXPTIME-ABS</code> 
</h4><div class="pDefPara"><a name="wp1015872"> </a>
If this value is set, the message has an absolute expiration time, which is the absolute time when the message will be removed from the queue.
<a name="wp1015873"> </a>
The absolute expiration time is determined by the clock on the machine where the queue manager process resides.
</div>
<div class="pDefParaCont"><a name="wp1015874"> </a>
The absolute expiration time is specified by the value stored in <code class="cCode">EXP-TIME</code>. <code class="cCode">EXP-TIME</code> must be set to an absolute time generated by <code class="cCode">time</code>(2) or <code class="cCode">mktime</code>(3C) (the number of seconds since 00:00:00 Universal Coordinated Time&#8212;UTC, January 1, 1970).
<a name="wp1015875"> </a>
If an absolute time is specified that is earlier than the time of the enqueue operation, the operation succeeds, but the message is not counted for the purpose of calculating thresholds. If the expiration time is before the message availability time, the message is not available for dequeuing unless either the availability or expiration time is changed so that the availability time is before the expiration time. In addition, these messages are removed from the queue at expiration time even if they were never available for dequeuing. If a message expires during a transaction, the expiration does not cause the transaction to fail. Messages that expire while being enqueued or dequeued within a transaction are removed from the queue when the transaction ends. There is no acknowledgment that the message has expired.
<a name="wp1015876"> </a>
One of the following must be set: <code class="cCode">TPQEXPTIME-ABS</code>, <code class="cCode">TPQEXPTIME-REL</code>, <code class="cCode">TPQEXPTIME-NONE</code>, or <code class="cCode">TPQNOEXPTIME</code>.
</div>
<h4 class="pDefTerm"><a name="wp1015877"> </a>
<code class="cCode">TPQEXPTIME-REL</code> 
</h4><div class="pDefPara"><a name="wp1015878"> </a>
If this value is set, the message has a relative expiration time, which is the number of seconds <em class="cEmphasis">after</em> the message arrives at the queue that the message is removed from the queue. The relative expiration time is specified by the value stored in <code class="cCode">EXP-TIME</code>.
</div>
<div class="pDefParaCont"><a name="wp1015879"> </a>
If the expiration time is before the message availability time, the message is not available for dequeuing unless either the availability or expiration time is changed so that the availability time is before the expiration time. In addition, these messages are removed from the queue at expiration time even if they were never available for dequeuing. The expiration of a message during a transaction does cause the transaction to fail. Messages that expire while being enqueued or dequeued within a transaction are removed from the queue when the transaction ends. There is no acknowledgment that the message has expired.
<a name="wp1015880"> </a>
One of the following must be set: <code class="cCode">TPQEXPTIME-ABS</code>, <code class="cCode">TPQEXPTIME-REL</code>, <code class="cCode">TPQEXPTIME-NONE</code>, or <code class="cCode">TPQNOEXPTIME</code>.
</div>
<h4 class="pDefTerm"><a name="wp1015017"> </a>
<code class="cCode">TPQEXPTIME-NONE</code> 
</h4><div class="pDefPara"><a name="wp1015018"> </a>
Setting this value indicates that the message should not expire. This flag overrides any default expiration policy associated with the target queue. You can remove a message by dequeuing it or by deleting it via an administrative interface. One of the following must be set: <code class="cCode">TPQEXPTIME-ABS</code>, <code class="cCode">TPQEXPTIME-REL</code>, <code class="cCode">TPQEXPTIME-NONE</code>, or <code class="cCode">TPQNOEXPTIME</code>.
</div>
<h4 class="pDefTerm"><a name="wp1015019"> </a>
<code class="cCode">TPQNOEXPTIME</code> 
</h4><div class="pDefPara"><a name="wp1015020"> </a>
Setting this value specifies that the default expiration time associated with the target queue applies to the message. One of the following must be set: <code class="cCode">TPQEXPTIME-ABS</code>, <code class="cCode">TPQEXPTIME-REL</code>, <code class="cCode">TPQEXPTIME-NONE</code>, or <code class="cCode">TPQNOEXPTIME</code>.
</div>
<p class="pBody"><a name="wp1014852"> </a>
Additionally, the<code class="cCode"> APPL-RETURN-CODE</code> member of <code class="cCodeEmphasis">TPQUEDEF-REC</code> can be set with a user-return code. This value is returned to the application that calls <code class="cCode">TPDEQUEUE()</code> to dequeue the message. 
</p>
<p class="pBody"><a name="wp1003860"> </a>
As output from <code class="cCode">TPENQUEUE()</code>, the following may be set in the <code class="cCodeEmphasis">TPQUEDEF-REC</code><code class="cCode"> </code>structure:
</p>
<a name="wp1003862"> </a><div class="pPreformatted"><pre><code class="cCode">05 DIAGNOSTIC           PIC S9(9) COMP-5.<br />05 MSGID                PIC X(32).</code></pre></div><p class="pBody"><a name="wp1017425"> </a>
The following is a valid setting in <code class="cCodeEmphasis">TPQUEDEF-REC</code> controlling output information from <code class="cCode">TPENQUEUE()</code>. If this setting is true when <code class="cCode">TPENQUEUE()</code> is called, the Oracle Tuxedo /Q server <a href="../rf5/rf5.html">TMQUEUE(5)</a> populates the associated element in the record with a message identifier. If this setting is not true when <code class="cCode">TPENQUEUE()</code> is called, <code class="cCode">TMQUEUE()</code> does <em class="cEmphasis">not</em> populate the associated element in the record with a message identifier.
</p>
<h4 class="pDefTerm"><a name="wp1017426"> </a>
<code class="cCode">TPQMSGID</code>
</h4><div class="pDefPara"><a name="wp1017427"> </a>
If this value is set and the call to <code class="cCode">TPENQUEUE()</code> is successful, the message identifier is stored in <code class="cCode">MSGID</code>. The entire 32 bytes of the message identifier value are significant, so the value stored in <code class="cCode">MSGID</code> is completely initialized (for example, padded with null characters). The actual padding character used for initialization varies between releases of the Oracle Tuxedo /Q component. If <code class="cCode">TPQNOMSGID</code> is set, the message identifier is not available.
</div>
<p class="pBody"><a name="wp1010624"> </a>
The remaining members of the control structure are not used on input to <code class="cCode">TPENQUEUE()</code>.
</p>
<p class="pBody"><a name="wp1003889"> </a>
If the call to <code class="cCode">TPENQUEUE()</code> fails and <code class="cCode">TP-STATUS</code> is set to <code class="cCode">TPEDIAGNOSTIC</code>, a value indicating the reason for failure is returned in <code class="cCode">DIAGNOSTIC</code>. The following are the possible values: 
</p>
<h4 class="pDefTerm"><a name="wp1010411"> </a>
[<code class="cCode">QMEINVAL</code>] 
</h4><div class="pDefPara"><a name="wp1003890"> </a>
An invalid setting value was specified. 
</div>
<h4 class="pDefTerm"><a name="wp1003891"> </a>
[<code class="cCode">QMEBADRMID</code>] 
</h4><div class="pDefPara"><a name="wp1003892"> </a>
An invalid resource manager identifier was specified. 
</div>
<h4 class="pDefTerm"><a name="wp1003893"> </a>
[<code class="cCode">QMENOTOPEN</code>] 
</h4><div class="pDefPara"><a name="wp1003894"> </a>
The resource manager is not currently open. 
</div>
<h4 class="pDefTerm"><a name="wp1003895"> </a>
[<code class="cCode">QMETRAN</code>] 
</h4><div class="pDefPara"><a name="wp1014065"> </a>
The call was not in transaction mode or was made with the <code class="cCode">TPNOTRAN</code> setting and an error occurred trying to start a transaction in which to enqueue the message. This diagnostic is not returned by a queue manager from Oracle Tuxedo release 7.1 or later.
</div>
<h4 class="pDefTerm"><a name="wp1003898"> </a>
[<code class="cCode">QMEBADMSGID</code>] 
</h4><div class="pDefPara"><a name="wp1003899"> </a>
An invalid message identifier was specified. 
</div>
<h4 class="pDefTerm"><a name="wp1003900"> </a>
[<code class="cCode">QMESYSTEM</code>] 
</h4><div class="pDefPara"><a name="wp1003901"> </a>
A system error has occurred. The exact nature of the error is written to a log file. 
</div>
<h4 class="pDefTerm"><a name="wp1003902"> </a>
[<code class="cCode">QMEOS</code>] 
</h4><div class="pDefPara"><a name="wp1003903"> </a>
An operating system error has occurred. 
</div>
<h4 class="pDefTerm"><a name="wp1008172"> </a>
[<code class="cCode">QMEABORTED</code>] 
</h4><div class="pDefPara"><a name="wp1008173"> </a>
The operation was aborted. If the aborted operation was being executed within a global transaction, the global transaction is marked rollback-only. Otherwise, the queue manager aborts the operation.
</div>
<h4 class="pDefTerm"><a name="wp1003906"> </a>
[<code class="cCode">QMEPROTO</code>] 
</h4><div class="pDefPara"><a name="wp1003907"> </a>
An enqueue was done when the transaction state was not active. 
</div>
<h4 class="pDefTerm"><a name="wp1003908"> </a>
[<code class="cCode">QMEBADQUEUE</code>] 
</h4><div class="pDefPara"><a name="wp1003909"> </a>
An invalid or deleted queue name was specified. 
</div>
<h4 class="pDefTerm"><a name="wp1015109"> </a>
[<code class="cCode">QMENOSPACE</code>] 
</h4><div class="pDefPara"><a name="wp1015110"> </a>
Due to an insufficient resource, such as no space on the queue, the message with its required quality of service (persistent or non-persistent storage) was not enqueued. <code class="cCode">QMENOSPACE</code> is returned when any of the following configured resources is exceeded: (1) the amount of disk (persistent) space allotted to the queue space, (2) the amount of memory (non-persistent) space allotted to the queue space, (3) the maximum number of simultaneously active transactions allowed for the queue space, (4) the maximum number of messages that the queue space can contain at any one time, (5) the maximum number of concurrent actions that the Queuing Services component can handle, or (6) the maximum number of authenticated users that may concurrently use the Queuing Services component.
</div>
<h4 class="pDefTerm"><a name="wp1014055"> </a>
[<code class="cCode">QMERELEASE</code>]
</h4><div class="pDefPara"><a name="wp1014056"> </a>
An attempt was made to enqueue a message to a queue manager that is from a version of the Oracle Tuxedo system that does not support a newer feature.
</div>
<h4 class="pDefTerm"><a name="wp1014028"> </a>
[<code class="cCode">QMESHARE</code>] 
</h4><div class="pDefPara"><a name="wp1014029"> </a>
When enqueuing a message from a specified queue, the specified queue is opened <em class="cEmphasis">exclusively</em> by another application. The other application is one based on an Oracle product other than the Oracle Tuxedo system that opened the queue for exclusive read and/or write using the Queuing Services API (QSAPI).
</div>
<h4 class="pHeading3"><a name="wp1003913"> </a>
Overriding the Queue Order
</h4>
<p class="pBody"><a name="wp1003914"> </a>
If the administrator, in creating a queue, allows <code class="cCode">TPENQUEUE()</code> calls to override the order of messages on the queue, you have two mutually exclusive ways to use the override capability. You can specify that the message is to be placed at the top of the queue by setting <code class="cCode">TPQTOP</code> or you can specify that it be placed ahead of a specific message by setting <code class="cCode">TPQBEFOREMSGID</code> and setting <code class="cCode">MSGID</code> to the ID of the message you wish to precede. This assumes that you saved the message-ID from a previous call in order to be able to use it here. Your administrator must tell you what the queue supports; it can be created to allow either or both of these overrides, or to allow neither. 
</p>
<h4 class="pHeading3"><a name="wp1003921"> </a>
Overriding the Queue Priority
</h4>
<p class="pBody"><a name="wp1003922"> </a>
You can set a value in <code class="cCode">PRIORITY</code> to specify the priority for the message. The value must be in the range 1 to 100; the higher the number, the higher the priority, unlike values specified with the UNIX <code class="cCode">nice</code> command. If <code class="cCode">PRIORITY</code> was not one of the queue ordering parameters, setting a priority here has no effect on the dequeuing order. The priority value is retained however, so that it can be inspected when the message is dequeued.
</p>
<h3 class="pHeading2"><a name="wp1003926"> </a>
Setting a Message Availability Time
</h3>
<p class="pBody"><a name="wp1003927"> </a>
You can specify in <code class="cCode">DEQ-TIME</code> either an absolute time or a time relative to the completion of the enqueuing operation at which the message is made available. You set either<code class="cCode"> TPQTIME-ABS </code>or <code class="cCode">TPQTIME-REL</code> to indicate how the value should be treated. A queue may be created with <code class="cCode">time</code> as a queue-ordering criterion, in which case messages are ordered by the message availability time.
</p>
<p class="pBody"><a name="wp1003931"> </a>
The following example shows how to enqueue a message with a relative time. The sample message will become available sixty seconds in the future. 
</p>
<a name="wp1003933"> </a><div class="pPreformatted"><pre><code class="cCode">  01  TPQUEDEF-REC.<br />      COPY TPQUEDEF.<br />  01  TPTYPE-REC.<br />      COPY TPTYPE.<br />  01  TPSTATUS-REC.<br />      COPY TPSTATUS.<br />  01  USER-DATA-REC  PIC X(100).<br />*<br />*<br />*<br />  MOVE LOW-VALUES TO TPQUEDEF-REC.<br />  MOVE &quot;QSPACE1&quot; TO QSPACE-NAME IN TPQUEDEF-REC.<br />  MOVE &quot;Q1&quot; TO QNAME IN TPQUEDEF-REC.<br />  SET TPTRAN IN TPQUEDEF-REC TO TRUE.<br />  SET TPBLOCK IN TPQUEDEF-REC TO TRUE.<br />  SET TPTIME IN TPQUEDEF-REC TO TRUE.<br />  SET TPSIGRSTRT IN TPQUEDEF-REC TO TRUE.<br />  SET TPQDEFAULT IN TPQUEDEF-REC TO TRUE.<br />  SET TPQTIME-REL IN TPQUEDEF-REC TO TRUE.<br />  MOVE 60 TO DEQ-TIME IN TPQUEDEF-REC.<br />  SET TPQNOPRIORITY IN TPQUEDEF-REC TO TRUE.<br />  SET TPQNOCORRID IN TPQUEDEF-REC TO TRUE.<br />  SET TPQNOREPLYQ IN TPQUEDEF-REC TO TRUE.<br />  SET TPQNOFAILUREQ IN TPQUEDEF-REC TO TRUE.<br />  SET TPQMSGID IN TPQUEDEF-REC TO TRUE.<br />  MOVE LOW-VALUES TO TPTYPE-REC.<br />  MOVE &quot;STRING&quot; TO REC-TYPE IN TPTYPE-REC.<br />  MOVE LENGTH OF USER-DATA-REC TO LEN IN TPTYPE-REC.<br />  CALL &quot;TPENQUEUE&quot; USING<br />          TPQUEDEF-REC<br />          TPTYPE-REC<br />          USER-DATA-REC<br />          TPSTATUS-REC.</code></pre></div><h3 class="pHeading2"><a name="wp1005055"> </a>
TPENQUEUE() and Transactions
</h3>
<p class="pBody"><a name="wp1003967"> </a>
If the caller of <code class="cCode">TPENQUEUE()</code> is in transaction mode and <code class="cCode">TPTRAN</code> is set, then the enqueuing is done within the caller&#39;s transaction. The caller knows for certain from the success or failure of <code class="cCode">TPENQUEUE()</code> whether the message was enqueued or not. If the call succeeds, the message is guaranteed to be on the queue. If the call fails, the transaction is rolled back, including the part where the message was placed on the queue. 
</p>
<p class="pBody"><a name="wp1005070"> </a>
If the caller of <code class="cCode">TPENQUEUE()</code> is not in transaction mode or if <code class="cCode">TPNOTRAN</code> is set, the message is enqueued outside of the caller&#8217;s transaction. If the call to <code class="cCode">TPENQUEUE()</code> returns success, the message is guaranteed to be on the queue. If the call to <code class="cCode">TPENQUEUE()</code> fails with a communication error or with a timeout, the caller is left in doubt about whether the failure occurred before or after the message was enqueued. 
</p>
<p class="pBody"><a name="wp1003978"> </a>
Note that specifying <code class="cCode">TPNOTRAN</code> while the caller is not in transaction mode has no meaning. 
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1003979"> </a>
Dequeuing Messages
</h2><p class="pBody"><a name="wp1003980"> </a>
The syntax for <code class="cCode">TPDEQUEUE()</code> is as follows:
</p>
<a name="wp1003981"> </a><div class="pPreformatted"><pre>01 <span style="font-style: italic">TPQUEDEF-REC</span>.<br />   COPY TPQUEDEF.<br />01 <span style="font-style: italic">TPTYPE-REC</span>.<br />   COPY TPTYPE.<br />01 <span style="font-style: italic">DATA-REC</span>.<br />   COPY User Data.<br />01 <span style="font-style: italic">TPSTATUS-REC</span>.<br />   COPY TPSTATUS.<br />CALL &quot;TPDEQUEUE&quot; USING <span style="font-style: italic">TPQUEDEF-REC</span> <span style="font-style: italic">TPTYPE-REC</span> <span style="font-style: italic">DATA-REC</span> <span style="font-style: italic">TPSTATUS-REC</span>.</pre></div><p class="pBody"><a name="wp1003991"> </a>
When this call is issued it tells the system to dequeue a message from the <code class="cCode">QNAME</code> in <code class="cCodeEmphasis">TPQUEDEF-REC</code> queue, in the queue space named <code class="cCode">QSPACE-NAME</code> in <code class="cCodeEmphasis">TPQUEDEF-REC</code>. The message is placed in <code class="cCodeEmphasis">DATA-REC</code>. <code class="cCode">LEN</code> in<code class="cCode"> </code><code class="cCodeEmphasis">TPTYPE-REC</code> is set to the length of the data. If <code class="cCode">LEN</code> is 0 on return from <code class="cCode">TPDEQUEUE()</code>, the message had no data portion. By the use of settings in <code class="cCodeEmphasis">TPQUEDEF-REC</code> the system is informed how the call to <code class="cCode">TPDEQUEUE()</code> is to be handled. 
</p>
<h3 class="pHeading2"><a name="wp1003996"> </a>
TPDEQUEUE() Arguments
</h3>
<p class="pBody"><a name="wp1003997"> </a>
There are some important arguments to control the operation of <a href="../rf3cbl/rf3cbl.html">TPDEQUEUE(3cbl)</a>. Let&#39;s look at some of them.
</p>
<h3 class="pHeading2"><a name="wp1003999"> </a>
TPDEQUEUE(): The QSPACE-NAME in TPQUEDEF-REC Argument
</h3>
<p class="pBody"><a name="wp1005139"> </a>
<code class="cCode">QSPACE-NAME</code> identifies a queue space previously created by the administrator. When the <code class="cCode">TMQUEUE</code> server is defined in the <code class="cCode">SERVERS</code> section of the configuration file, the service names it offers are aliases for the actual queue space name (which is specified as part of the <code class="cCode">OPENINFO</code> parameter in the <code class="cCode">GROUPS</code> section). For example, when your application uses the server <code class="cCode">TMQUEUE</code>, the value pointed at by <code class="cCode">QSPACE-NAME</code> is the name of a service advertised by <code class="cCode">TMQUEUE</code>. If no service aliases are defined, the name of the default service is the same as that of the server, <code class="cCode">TMQUEUE</code>. In this case the configuration file may include the following:
</p>
<a name="wp1004007"> </a><div class="pPreformatted"><pre>TMQUEUE<br />        SRVGRP = QUE1  SRVID = 1<br />        GRACE = 0  RESTART = Y CONV = N<br />        CLOPT = &quot;-A&quot;<br />or<br />        CLOPT = &quot;-s TMQUEUE&quot;</pre></div><p class="pBody"><a name="wp1004013"> </a>
The entry for server group <code class="cCode">QUE1</code> has an <code class="cCode">OPENINFO</code> parameter that specifies the resource manager, the pathname of the device, and the queue space name. The<code class="cCode"> QSPACE-NAME</code> argument in a client program then looks like the following: 
</p>
<a name="wp1004016"> </a><div class="pPreformatted"><pre>  01 TPQUEDEF-REC.<br />     COPY TPQUEDEF.<br />  01 TPTYPE-REC.<br />     COPY TPTYPE.<br />  01 TPSTATUS-REC.<br />     COPY TPSTATUS.<br />  01 USER-DATA-REC  PIC X(100).<br />*<br />*<br />*<br />  MOVE LOW-VALUES TO TPQUEDEF-REC.<br />  MOVE &quot;TMQUEUE&quot; TO QSPACE-NAME IN TPQUEDEF-REC.<br />  MOVE &quot;REPLYQ&quot; TO QNAME IN TPQUEDEF-REC.<br />  SET TPTRAN IN TPQUEDEF-REC TO TRUE.<br />  SET TPBLOCK IN TPQUEDEF-REC TO TRUE.<br />  SET TPTIME IN TPQUEDEF-REC TO TRUE.<br />  SET TPSIGRSTRT IN TPQUEDEF-REC TO TRUE.<br />  MOVE LOW-VALUES TO TPTYPE-REC.<br />  MOVE &quot;STRING&quot; TO REC-TYPE IN TPTYPE-REC.<br />  MOVE LENGTH OF USER-DATA-REC TO LEN IN TPTYPE-REC.<br />  CALL &quot;TPDEQUEUE&quot; USING<br />          TPQUEDEF-REC<br />          TPTYPE-REC<br />          USER-DATA-REC<br />          TPSTATUS-REC.</pre></div><p class="pBody"><a name="wp1004041"> </a>
The example shown on the <a href="../rf5/rf5.html">TMQUEUE(5)</a> reference page shows how alias service names can be included when the server is built and specified in the configuration file. The sample program in <a href="qsimp.html">A Sample Application</a>, also specifies an alias service name.
</p>
<h4 class="pHeading3"><a name="wp1004044"> </a>
TPDEQUEUE(): The QNAME in TPQUEDEF-REC Argument
</h4>
<p class="pBody"><a name="wp1004045"> </a>
Queue names in a queue space must be agreed upon by the applications that will access the queue space. This requirement is especially important for reply queues. If <code class="cCode">QNAME</code> refers to a reply queue, the administrator creates it (and often an error queue) in the same manner that he or she creates any other queue. <code class="cCodeEmphasis">QNAME</code> contains the name of the queue from which to retrieve a message or reply.
</p>
<h4 class="pHeading3"><a name="wp1004048"> </a>
TPDEQUEUE(): The DATA-REC and LEN in TPTYPE-REC Arguments
</h4>
<p class="pBody"><a name="wp1004049"> </a>
These arguments have a different flavor than they do on <code class="cCode">TPENQUEUE()</code>. <code class="cCodeEmphasis">DATA-REC</code> is where the system is to place the message being dequeued. 
</p>
<p class="pBody"><a name="wp1006401"> </a>
It is an error for <code class="cCode">LEN</code> to be 0 on input. When <code class="cCode">TPDEQUEUE()</code> returns, <code class="cCode">LEN</code> contains the length of the data retrieved. If it is 0, it means that the reply had no data portion. This can be a legitimate and successful reply in some applications; receiving even a 0 length reply can be used to show successful processing of the enqueued request. If you wish to know whether the record has changed from before the call to <code class="cCode">TPDEQUEUE()</code>, save the length prior to the call to <code class="cCode">TPDEQUEUE()</code> and compare it to <code class="cCode">LEN</code> after the call completes. If the reply is larger than <code class="cCode">LEN</code>, then <code class="cCodeEmphasis">DATA-REC</code> will contain only as many bytes as will fit. The remainder are discarded and <code class="cCode">TPDEQUEUE()</code> fails with <code class="cCode">TPTRUNCATE</code>. 
</p>
<h4 class="pHeading3"><a name="wp1004058"> </a>
TPDEQUEUE(): The Settings in TPQUEDEF-REC
</h4>
<p class="pBody"><a name="wp1004059"> </a>
Settings in <code class="cCodeEmphasis">TPQUEDEF-REC</code> are used to tell the Oracle Tuxedo system how the <code class="cCode">TPDEQUEUE()</code> call is handled; the following are valid settings: 
</p>
<h4 class="pDefTerm"><a name="wp1004061"> </a>
<code class="cCode">TPNOTRAN</code> 
</h4><div class="pDefPara"><a name="wp1004062"> </a>
If the caller is in transaction mode, this setting specifies that the message is to be dequeued outside of the caller&#8217;s transaction. Either <code class="cCode">TPNOTRAN</code> or <code class="cCode">TPTRAN</code> must be set. 
</div>
<h4 class="pDefTerm"><a name="wp1004064"> </a>
<code class="cCode">TPTRAN</code> 
</h4><div class="pDefPara"><a name="wp1004065"> </a>
If the caller is in transaction mode, this setting specifies that the message is to be dequeued within the same transaction. Either <code class="cCode">TPNOTRAN</code> or <code class="cCode">TPTRAN</code> must be set. 
</div>
<h4 class="pDefTerm"><a name="wp1015131"> </a>
<code class="cCode">TPNOBLOCK</code> 
</h4><div class="pDefPara"><a name="wp1015132"> </a>
The message is not dequeued if a blocking condition exists. If <code class="cCode">TPNOBLOCK</code> is set and a blocking condition exists such as the internal buffers into which the message is transferred are full, the call fails and <a href="../rf5/rf5.html">tperrno(5)</a> is set to <code class="cCode">TPEBLOCK</code>. If <code class="cCode">TPNOBLOCK</code> is set and a blocking condition exists because the target queue is opened <em class="cEmphasis">exclusively</em> by another application, the call fails, <code class="cCode">tperrno()</code> is set to <code class="cCode">TPEDIAGNOSTIC</code>, and the diagnostic field of the <code class="cCode">TPQCTL</code> structure is set to <code class="cCode">QMESHARE</code>. In the latter case, the other application, which is based on an Oracle product other than the Oracle Tuxedo system, opened the queue for exclusive read and/or write using the Queuing Services API (QSAPI). Either <code class="cCode">TPNOBLOCK</code> or <code class="cCode">TPBLOCK</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1015133"> </a>
<code class="cCode">TPBLOCK</code> 
</h4><div class="pDefPara"><a name="wp1015155"> </a>
When <code class="cCode">TPBLOCK</code> is set and a blocking condition exists, the caller blocks until the condition subsides or a timeout occurs (either transaction or blocking timeout). This blocking condition does not include blocking on the queue itself if the <code class="cCode">TPQWAIT</code> setting is specified. Either <code class="cCode">TPNOBLOCK</code> or <code class="cCode">TPBLOCK</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1015156"> </a>
<code class="cCode">TPNOTIME</code> 
</h4><div class="pDefPara"><a name="wp1015157"> </a>
Setting this value asks that the call be immune to blocking timeouts; transaction timeouts may still occur. Either <code class="cCode">TPNOTIME</code> or <code class="cCode">TPTIME</code> must be set. 
</div>
<h4 class="pDefTerm"><a name="wp1015158"> </a>
<code class="cCode">TPTIME</code> 
</h4><div class="pDefPara"><a name="wp1015159"> </a>
Setting this value asks that the call receive blocking timeouts. Either <code class="cCode">TPNOTIME</code> or <code class="cCode">TPTIME</code> must be set. 
</div>
<h4 class="pDefTerm"><a name="wp1015160"> </a>
<code class="cCode">TPNOCHANGE</code> 
</h4><div class="pDefPara"><a name="wp1004083"> </a>
If this value is set, the record type of <code class="cCodeEmphasis">DATA-REC</code> is not allowed to change. That is, the type and subtype of the received record must match the type and subtype of the record <code class="cCodeEmphasis">DATA-REC</code>. Either <code class="cCode">TPNOCHANGE</code> or <code class="cCode">TPCHANGE</code> must be set. 
</div>
<h4 class="pDefTerm"><a name="wp1004086"> </a>
<code class="cCode">TPCHANGE</code> 
</h4><div class="pDefPara"><a name="wp1004087"> </a>
By default, if a record is received that differs in type from the record <code class="cCodeEmphasis">DATA-REC</code>, <code class="cCodeEmphasis">DATA-REC</code>&#39;s record type changes to the received record&#39;s type so long as the receiver recognizes the incoming record type. That is, the type and sub-type of the received record must match the type and sub-type of the record <code class="cCodeEmphasis">DATA-REC</code>. Either <code class="cCode">TPNOCHANGE</code> or <code class="cCode">TPCHANGE</code> must be set. 
</div>
<h4 class="pDefTerm"><a name="wp1004092"> </a>
<code class="cCode">TPSIGRSTRT</code> 
</h4><div class="pDefPara"><a name="wp1004093"> </a>
Setting this value says that any underlying system calls that are interrupted by a signal should be reissued. Either <code class="cCode">TPSIGRSTRT</code> or <code class="cCode">TPNOSIGRSTRT</code> must be set.
</div>
<h4 class="pDefTerm"><a name="wp1004095"> </a>
<code class="cCode">TPNOSIGRSTRT</code> 
</h4><div class="pDefPara"><a name="wp1004096"> </a>
If this value is set and a signal is received, the call fails and sets <code class="cCode">TP-STATUS</code> to <code class="cCode">TPEGOTSIG</code>. Either <code class="cCode">TPSIGRSTRT</code> or <code class="cCode">TPNOSIGRSTRT</code> must be set.
</div>
<h3 class="pHeading2"><a name="wp1004098"> </a>
TPQUEDEF-REC Structure
</h3>
<p class="pBody"><a name="wp1010862"> </a>
The first argument to <code class="cCode">TPDEQUEUE()</code> is the structure <code class="cCodeEmphasis">TPQUEDEF-REC</code>. The <code class="cCodeEmphasis">TPQUEDEF-REC</code><code class="cCode"> </code>structure has members that are used by the application and by the Oracle Tuxedo system to pass parameters in both directions between application programs and the queued message facility. The client that calls <code class="cCode">TPDEQUEUE()</code> uses settings to mark members the application wants the system to fill in. As described earlier, the structure is also used by <code class="cCode">TPENQUEUE()</code>; some of the members only apply to that function. The entire structure is shown in <a href="qcblpgm.html#wp1009311">The TPQUEDEF-REC Structure</a>.
</p>
<p class="pBody"><a name="wp1004104"> </a>
As input to <code class="cCode">TPDEQUEUE()</code>, the following elements may be set in the <code class="cCode">TPQUEDEF</code> structure:
</p>
<a name="wp1004105"> </a><div class="pPreformatted"><pre>05 MSGID                PIC X(32).<br />05 CORRID               PIC X(32).</pre></div><p class="pBody"><a name="wp1011176"> </a>
The following is a list of valid settings in <code class="cCodeEmphasis">TPQUEDEF-REC</code> that control input for <code class="cCode">TPDEQUEUE()</code>:
</p>
<h4 class="pDefTerm"><a name="wp1011177"> </a>
<code class="cCode">TPQGETNEXT</code> 
</h4><div class="pDefPara"><a name="wp1011178"> </a>
Setting this value requests that the next message on the queue be dequeued, using the default queue order. One of the following must be set: <code class="cCode">TPQGETNEXT</code>, <code class="cCode">TPQGETBYMSGID</code>, or <code class="cCode">TPQGETBYCORRID</code>.
</div>
<h4 class="pDefTerm"><a name="wp1011179"> </a>
<code class="cCode">TPQGETBYMSGID</code> 
</h4><div class="pDefPara"><a name="wp1017520"> </a>
Setting this value requests that the message identified by <code class="cCode">MSGID</code> be dequeued. The message identifier is returned by a prior call to <code class="cCode">TPENQUEUE()</code>. Note that the message identifier is not valid if the message has moved from one queue to another. Note also that the entire 32 bytes of the message identifier value are significant, so the value identified by <code class="cCode">MSGID</code> must be completely initialized (for example, padded with spaces).
</div>
<div class="pDefParaCont"><a name="wp1017521"> </a>
One of the following must be set: <code class="cCode">TPQGETNEXT</code>, <code class="cCode">TPQGETBYMSGID</code>, or <code class="cCode">TPQGETBYCORRID</code>.
</div>
<h4 class="pDefTerm"><a name="wp1011181"> </a>
<code class="cCode">TPQGETBYCORRID</code> 
</h4><div class="pDefPara"><a name="wp1017546"> </a>
Setting this value requests that the message identified by <code class="cCode">CORRID</code> be dequeued. The correlation identifier is specified by the application when enqueuing the message with <code class="cCode">TPENQUEUE()</code>. Note that the entire 32 bytes of the correlation identifier value are significant, so the value identified by <code class="cCode">CORRID</code> must be completely initialized (for example, padded with spaces).
</div>
<div class="pDefParaCont"><a name="wp1017547"> </a>
One of the following must be set: <code class="cCode">TPQGETNEXT</code>, <code class="cCode">TPQGETBYMSGID</code>, or <code class="cCode">TPQGETBYCORRID</code>.
</div>
<h4 class="pDefTerm"><a name="wp1011183"> </a>
<code class="cCode">TPQWAIT</code> 
</h4><div class="pDefPara"><a name="wp1011184"> </a>
Setting this value indicates that an error should not be returned if the queue is empty. Instead, the process should wait until a message is available. Set <code class="cCode">TPQNOWAIT</code> to not wait until a message is available. If <code class="cCode">TPQWAIT</code> is set in conjunction with <code class="cCode">TPQGETBYMSGID</code> or <code class="cCode">TPQGETBYCORRID</code>, it indicates that an error should not be returned if no message with the specified message identifier or correlation identifier is present in the queue. Instead, the process should wait until a message meeting the criteria is available. The process is still subject to the caller&#8217;s transaction timeout, or, when not in transaction mode, the process is still subject to the timeout specified on the <code class="cCode">TMQUEUE</code> process by the<code class="cCode"> -t</code> option.
</div>
<div class="pDefParaCont"><a name="wp1016631"> </a>
If a message matching the desired criteria is not immediately available and the configured action resources are exhausted, <code class="cCode">TPDEQUEUE</code> fails, <code class="cCode">TP-STATUS</code> is set to <code class="cCode">TPEDIAGNOSTIC</code>, and <code class="cCode">DIAGNOSTIC</code> is set to <code class="cCode">QMESYSTEM</code>.
<a name="wp1018261"> </a>
Note that each <code class="cCode">TPDEQUEUE()</code> request specifying the <code class="cCode">TPQWAIT</code> control parameter requires that a queue manager (<code class="cCode">TMQUEUE</code>) action object be available if a message satisfying the condition is not immediately available. If one is not available, the <code class="cCode">TPDEQUEUE()</code> request fails. The number of available queue manager actions are specified when a queue space is created or modified. When a waiting dequeue request completes, the associated action object associated is made available for another request.
</div>
<h4 class="pDefTerm"><a name="wp1018262"> </a>
<code class="cCode">TPQPEEK</code> 
</h4><div class="pDefPara"><a name="wp1011187"> </a>
If <code class="cCode">TPQPEEK</code> is set, the specified message is read but not removed from the queue. The <code class="cCode">TPNOTRAN</code> flag must be set. It is not possible to read messages enqueued or dequeued within a transaction before the transaction completes.
</div>
<div class="pDefParaCont"><a name="wp1014164"> </a>
When a thread is non-destructively dequeuing a message using <code class="cCode">TPQPEEK</code>, the message may not be seen by other non-blocking dequeuers for the brief time the system is processing the non-destructive dequeue request. This includes dequeuers using specific selection criteria (such as message identifier and correlation identifier) that are looking for the message currently being non-destructively dequeued.
</div>
<p class="pBody"><a name="wp1011188"> </a>
On output from <code class="cCode">TPDEQUEUE()</code>, the following elements may be set in <code class="cCodeEmphasis">TPQUEDEF-REC</code>:
</p>
<a name="wp1011189"> </a><div class="pPreformatted"><pre>05 PRIORITY     PIC S9(9) COMP-5. <br />05 MSGID        PIC X(32). <br />05 CORRID       PIC X(32). <br />05 TPQUEQOS-DELIVERY-FLAG    PIC S9(9) COMP-5. <br />05 TPQUEQOS-REPLY-FLAG       PIC S9(9) COMP-5. <br />05 REPLYQUEUE                PIC X(127). <br />05 FAILUREQUEUE              PIC X(127). <br />05 DIAGNOSTIC                PIC S9(9) COMP-5. <br />05 CLIENTID OCCURS 4 TIMES   PIC S9(9) COMP-5 <br />05 APPL-RETURN-CODE          PIC S9(9) COMP-5. <br />05 APPKEY                    PIC S9(9) COMP-5.</pre></div><p class="pBody"><a name="wp1016682"> </a>
The following is a list of valid settings in <code class="cCodeEmphasis">TPQUEDEF-REC</code> controlling output information from <code class="cCode">TPDEQUEUE()</code>. For any of these settings, if the setting is true when <code class="cCode">TPDEQUEUE()</code> is called, the associated element in the record is populated with the value provided when the message was queued, and the setting remains true. If the value is not available (that is, no value was provided when the message was queued) or the setting is not true when <code class="cCode">TPDEQUEUE()</code> is called, <code class="cCode">TPDEQUEUE()</code> completes with the setting not true.
</p>
<h4 class="pDefTerm"><a name="wp1016683"> </a>
<code class="cCode">TPQPRIORITY</code> 
</h4><div class="pDefPara"><a name="wp1016684"> </a>
If this value is set, the call to <code class="cCode">TPDEQUEUE()</code> is successful, and the message was queued with an explicit priority, then the priority is stored in <code class="cCode">PRIORITY</code>. The priority is in the range 1 to 100, inclusive, and the higher the number, the higher the priority (that is, a message with a higher number is dequeued before a message with a lower number). If <code class="cCode">TPQNOPRIORITY</code> is set, the priority is not available.
</div>
<div class="pDefParaCont"><a name="wp1016685"> </a>
Note that if no priority was explicitly specified when the message was queued, the priority for the message is 50.
</div>
<h4 class="pDefTerm"><a name="wp1016686"> </a>
<code class="cCode">TPQMSGID</code> 
</h4><div class="pDefPara"><a name="wp1016687"> </a>
If this value is set and the call to <code class="cCode">TPDEQUEUE()</code> is successful, the message identifier is stored in <code class="cCode">MSGID</code>. The entire 32 bytes of the message identifier value are significant. If <code class="cCode">TPQNOMSGID</code> is set, the message identifier is not available.
</div>
<h4 class="pDefTerm"><a name="wp1016688"> </a>
<code class="cCode">TPQCORRID</code> 
</h4><div class="pDefPara"><a name="wp1017714"> </a>
If this value is set, the call to <code class="cCode">TPDEQUEUE()</code> is successful, and the message was queued with a correlation identifier, then the correlation identifier is stored in <code class="cCode">CORRID</code>. The entire 32 bytes of the correlation identifier value are significant. Any Oracle Tuxedo /Q provided reply to a message has the correlation identifier of the original message. If <code class="cCode">TPQNOCORRID</code> is set, the correlation identifier is not available.
</div>
<h4 class="pDefTerm"><a name="wp1016690"> </a>
<code class="cCode">TPQDELIVERYQOS</code>
</h4><div class="pDefPara"><a name="wp1016691"> </a>
If this value is set, the call to <code class="cCode">TPDEQUEUE()</code> is successful, and the message was queued with a delivery quality of service, then the flag&#8212;<code class="cCode">TPQQOSDELIVERYDEFAULTPERSIST</code>, <code class="cCode">TPQQOSDELIVERYPERSISTENT</code>, or <code class="cCode">TPQQOSDELIVERYNONPERSISTENT</code>&#8212;specified by <code class="cCode">TPQUEQOS-DELIVERY-FLAG</code> indicates the delivery quality of service. If <code class="cCode">TPQNODELIVERYQOS</code> is set, the delivery quality of service is not available.
</div>
<div class="pDefParaCont"><a name="wp1016692"> </a>
Note that if no delivery quality of service was explicitly specified when the message was queued, the default delivery policy of the target queue dictates the delivery quality of service for the message.
</div>
<h4 class="pDefTerm"><a name="wp1016693"> </a>
<code class="cCode">TPQREPLYQOS</code>
</h4><div class="pDefPara"><a name="wp1016694"> </a>
If this value is set, the call to <code class="cCode">TPDEQUEUE()</code> is successful, and the message was queued with a reply quality of service, then the flag&#8212;<code class="cCode">TPQQOSREPLYDEFAULTPERSIST</code>, <code class="cCode">TPQQOSREPLYPERSISTENT</code>, or <code class="cCode">TPQQOSREPLYNONPERSISTENT</code>&#8212;specified by <code class="cCode">TPQUEQOS-REPLY-FLAG</code> indicates the reply quality of service. If <code class="cCode">TPQNOREPLYQOS</code> is set, the reply quality of service is not available.
</div>
<div class="pDefParaCont"><a name="wp1016695"> </a>
Note that if no reply quality of service was explicitly specified when the message was queued, the default delivery policy of the <code class="cCode">REPLYQUEUE</code> queue dictates the delivery quality of service for any reply. The default delivery policy is determined when the reply to a message is enqueued. That is, if the default delivery policy of the reply queue is modified between the time that the original message is enqueued and the reply to the message is enqueued, the policy used is the one in effect when the reply is finally enqueued.
</div>
<h4 class="pDefTerm"><a name="wp1016696"> </a>
<code class="cCode">TPQREPLYQ</code> 
</h4><div class="pDefPara"><a name="wp1016697"> </a>
If this value is set, the call to <code class="cCode">TPDEQUEUE()</code> is successful, and the message was queued with a reply queue, then the name of the reply queue is stored in <code class="cCode">REPLYQUEUE</code>. Any reply to the message should go to the named reply queue within the same queue space as the request message. If <code class="cCode">TPQNOREPLYQ</code> is set, the reply queue is not available.
</div>
<h4 class="pDefTerm"><a name="wp1016698"> </a>
<code class="cCode">TPQFAILUREQ</code> 
</h4><div class="pDefPara"><a name="wp1016699"> </a>
If this value is set, the call to <code class="cCode">TPDEQUEUE()</code> is successful, and the message was queued with a failure queue, then the name of the failure queue is stored in <code class="cCode">FAILUREQUEUE</code>. Any failure message should go to the named failure queue within the same queue space as the request message. If <code class="cCode">TPQNOFAILUREQ</code> is set, the failure queue is not available.
</div>
<p class="pBody"><a name="wp1016700"> </a>
The remaining settings in <code class="cCodeEmphasis">TPQUEDEF-REC</code> are set to the following values when <code class="cCode">TPDEQUEUE()</code> is called: <code class="cCode">TPQNOTOP</code>, <code class="cCode">TPQNOBEFOREMSGID</code>, <code class="cCode">TPQNOTIME_ABS</code>, <code class="cCode">TPQNOTIME_REL</code>, <code class="cCode">TPQNOEXPTIME_ABS</code>, <code class="cCode">TPQNOEXPTIME_REL</code>, and <code class="cCode">TPQNOEXPTIME_NONE</code>.
</p>
<p class="pBody"><a name="wp1006413"> </a>
If the call to <code class="cCode">TPDEQUEUE()</code> fails and <code class="cCode">TP-STATUS</code> is set to <code class="cCode">TPEDIAGNOSTIC</code>, a value indicating the reason for failure is returned in <code class="cCode">DIAGNOSTIC</code>. The valid settings for <code class="cCode">DIAGNOSTIC</code> include those for <code class="cCode">TPENQUEUE()</code> described in <a href="qcblpgm.html#wp1003737">TPQUEDEF-REC Structure</a> (except for <code class="cCode">QMENOSPACE</code> and <code class="cCode">QMERELEASE</code>) and the following additional codes.
</p>
<h4 class="pDefTerm"><a name="wp1015246"> </a>
[<code class="cCode">QMENOMSG</code>] 
</h4><div class="pDefPara"><a name="wp1015247"> </a>
No message was available for dequeuing. Note that it is possible that the message exists on the queue and another application process has read the message from the queue. In this case, the message may be put back on the queue if that other process rolls back the transaction.
</div>
<h4 class="pDefTerm"><a name="wp1015248"> </a>
[<code class="cCode">QMEINUSE</code>]
</h4><div class="pDefPara"><a name="wp1015249"> </a>
When dequeuing a message by message identifier or correlation identifier, the specified message is in use by another transaction. Otherwise all messages currently on the queue are in use by other transactions. This diagnostic is not returned by a queue manager from Oracle Tuxedo release 7.1 or later.
</div>
<h3 class="pHeading2"><a name="wp1004200"> </a>
Using TPQWAIT
</h3>
<p class="pBody"><a name="wp1016290"> </a>
When <code class="cCode">TPDEQUEUE()</code> is called with flags set to include <code class="cCode">TPQWAIT</code>, if a message is not immediately available, the <code class="cCode">TMQUEUE</code> server waits for the arrival, on the queue, of a message that matches the <code class="cCode">TPDEQUEUE()</code> request before <code class="cCode">TPDEQUEUE()</code> returns control to the caller. The <code class="cCode">TMQUEUE</code> process sets the waiting request aside and processes requests from other processes while waiting to satisfy the first request. If <code class="cCode">TPQGETBYMSGID</code> and/or <code class="cCode">TPQGETBYCORRID</code> are also specified, the server waits until a message with the indicated message identifier and/or correlation identifier becomes available on the queue. If neither of these flags is set, the server waits until any message is put onto the queue. The amount of time it waits is controlled by the caller&#8217;s transaction timeout, if the call is in transaction mode, or by the <code class="cCode">-t</code> option in the <code class="cCode">CLOPT</code> parameter of the <code class="cCode">TMQUEUE</code> server, if the call is not in transaction mode.
</p>
<p class="pBody"><a name="wp1012011"> </a>
The <code class="cCode">TMQUEUE</code> server can handle a number of waiting <code class="cCode">TPDEQUEUE()</code> requests at the same time, as long as action resources are available to handle the request. If there are not enough action resources configured for the queue space, <code class="cCode">TPDEQUEUE()</code> fails. If this happens on your system, increase the number of action resources for the queue space.
</p>
<h3 class="pHeading2"><a name="wp1004209"> </a>
Error Handling When Using TMQFORWARD Services
</h3>
<p class="pBody"><a name="wp1004210"> </a>
In considering how best to handle errors when dequeuing it is helpful to differentiate between two types of errors:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1008346"> </a>Errors encountered by <a href="../rf5/rf5.html">TMQFORWARD(5)</a> as it attempts to dequeue a message to forward to the requested service</li>
<li><a name="wp1008352"> </a>Errors that occur in the service that processes the request</li>
</ul></div>
<p class="pBody"><a name="wp1004215"> </a>
By default, if a message is dequeued within a transaction and the transaction is rolled back, then the message ends up back on the queue and can be dequeued and executed again. It may be desirable to delay for a short period before retrying to dequeue and execute the message, allowing the transient problem to clear (for example, allowing for locks in a database to be released by another transaction). Normally, a limit on the number of retries is also useful to ensure that an application flaw doesn&#39;t cause significant waste of resources. When a queue is configured by the administrator, both a retry count and a delay period (in seconds) can be specified. A retry count of 0 implies that no retries are done. After the retry count is reached, the message is moved to an error queue that is configured by the administrator for the queue space. If the error queue is not configured, then messages that have reached the retry count are simply deleted. Messages on the error queue must be handled by the administrator who must work out a way of notifying the originator that meets the requirements of the application. The message handling method chosen should be mostly transparent to the originating program that put the message on the queue. There is a virtual guarantee that once a message is successfully enqueued it will be processed according to the parameters of <code class="cCode">TPENQUEUE()</code> and the attributes of the queue. Notification that a message has been moved to the error queue should be a rare occurrence in a system that has properly tuned its queue parameters. 
</p>
<p class="pBody"><a name="wp1005547"> </a>
A failure queue (normally, different from the queue space error queue) may be associated with each queued message. This queue is specified on the enqueuing call as the place to put any failure messages. The failure message for a particular request can be identified by an application-generated correlation identifier that is associated with the message when it is enqueued.
</p>
<p class="pBody"><a name="wp1004235"> </a>
The default behavior of retrying until success (or a predefined limit) is quite appropriate when the failure is caused by a transient problem that is later resolved, allowing the message to be handled appropriately. 
</p>
<p class="pBody"><a name="wp1004238"> </a>
There are cases where the problem is not transient. For example, the queued message may request operating on an account that does not exist (and the application is such that it won&#39;t come into existence within a reasonable time period if at all). In this case, it is desirable not to waste any resources by trying again. If the application programmer or administrator determines that failures for a particular operation are never transient, then it is simply a matter of setting the retry count to zero, although this will require a mechanism to constantly clear the queue space error queue of these messages (for example, a background client that reads the queue periodically). More likely, it is the case that some problems will be transient (for example, database lock contention) and some problems will be permanent (for example, the account doesn&#39;t exist) for the same service. 
</p>
<p class="pBody"><a name="wp1004247"> </a>
In the case that the message is processed (dequeued and passed to the application via a <code class="cCode">TPCALL</code>) by <code class="cCode">TMQFORWARD</code>, there is no mechanism in the information returned by <code class="cCode">TPCALL</code> to indicate whether a <code class="cCode">TPESVCFAIL</code> error is caused by a transient or permanent problem. 
</p>
<p class="pBody"><a name="wp1015499"> </a>
As in the case where the application is handling the dequeuing, a simple solution is to return success for the service, that is, <code class="cCode">TPRETURN</code> with <code class="cCode">TPSUCCESS</code>, even though the operation failed. This allows the transaction to be committed and the message removed from the queue. If reply messages are being used, the information in the buffer returned from the service can indicate that the operation failed and the message will be enqueued on the reply queue. The <code class="cCode">APPL-CODE</code> in the <code class="cCodeEmphasis">TPSVCRET-REC</code> argument of <code class="cCode">TPRETURN</code> can also be used to return application specific information. 
</p>
<p class="pBody"><a name="wp1004257"> </a>
In the case where the service fails and the transaction must be rolled back, it is not clear whether or not <code class="cCode">TMQFORWARD</code> should execute a second transaction to remove the message from the queue without further processing. By default, <code class="cCode">TMQFORWARD</code> will not delete a message for a service that fails. <code class="cCode">TMQFORWARD</code>&#39;s transaction is rolled back and the message is restored to the queue. A command-line option may be specified for <code class="cCode">TMQFORWARD</code> that indicates that a message should be deleted from the queue if the service fails and a reply message is sent back with length greater than 0. The message is deleted in a second transaction. The queue must be configured with a delay time and retry count for this to work. If the message is associated with a failure queue, the reply data is enqueued to the failure queue in the same transaction as the one in which the message is deleted from the queue. 
</p>
<h3 class="pHeading2"><a name="wp1004267"> </a>
Procedure for Dequeuing Replies from Services Invoked Through TMQFORWARD
</h3>
<p class="pBody"><a name="wp1004268"> </a>
If your application expects to receive replies to queued messages, the following is a procedure you may want to follow: 
</p>
<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1004271"> </a>As a preliminary step, the queue space must include a reply queue and a failure queue. The application must also agree on the content of the correlation identifier. The service should be coded to return <code class="cCode">TPSUCCESS</code> on a logical failure and return an explanatory code in the <code class="cCode">APPL-CODE</code> in the <code class="cCodeEmphasis">TPSVCRET-REC</code> argument of <code class="cCode">TPRETURN</code>. </li>
<li><a name="wp1007184"> </a>When you call <code class="cCode">TPENQUEUE()</code> to put the message on the queue, set the following: </li>
<a name="wp1007185"> </a><div class="pPreformattedRelative"><pre>TPQCORRID      TPQREPLYQ<br />TPQFAILUREQ    TPQMSGID</pre></div><p class="pBodyRelative"><a name="wp1007186"> </a>
(Fill in the values for <code class="cCode">CORRID</code>, <code class="cCode">REPLYQUEUE</code> and <code class="cCode">FAILUREQUEUE</code> before issuing the call. On return from the call, save <code class="cCode">CORRID</code>.)
</p>
<li><a name="wp1006078"> </a>When you call <code class="cCode">TPDEQUEUE()</code> to check for a reply, specify the reply queue in <code class="cCode">QNAME</code> and set the following: </li>
<a name="wp1006475"> </a><div class="pPreformattedRelative"><pre>TPQCORRID       TPQREPLYQ<br />TPQFAILUREQ     TPQMSGID<br />TPQGETBYCORRID</pre></div><p class="pBodyRelative"><a name="wp1004287"> </a>
(Use the saved correlation identifier to populate <code class="cCode">CORRID</code> before issuing the call. If the call to <code class="cCode">TPDEQUEUE()</code> fails and sets <code class="cCode">TP-STATUS</code> to <code class="cCode">TPEDIAGNOSTIC</code>, then further information is available in the <code class="cCode">DIAGNOSTIC</code> settings. If you receive the error code <code class="cCode">QMENOMSG</code>, it means that no message was available for dequeuing.)
</p>
<li><a name="wp1004292"> </a>Set up another call to <code class="cCode">TPDEQUEUE()</code>. This time have <code class="cCode">QNAME</code> point to the name of the failure queue and set the following: </li>
<a name="wp1004294"> </a><div class="pPreformattedRelative"><pre>TPQCORRID       TPQREPLYQ<br />TPQFAILUREQ     TPQMSGID<br />TPQGETBYCORRID</pre></div><p class="pBodyRelative"><a name="wp1004297"> </a>
Populate <code class="cCode">TPQCORRID</code> with the correlation identifier. When the call returns, check <code class="cCode">LEN</code> to see if data has been received and check <code class="cCode">APPL-RETURN-CODE</code> to see if the service has returned a user return code. 
</p>
</ol></div>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1004300"> </a>
Sequential Processing of Messages
</h2><p class="pBody"><a name="wp1004301"> </a>
Sequential processing of messages can be achieved by having one service enqueue a message for the next service in the chain before its transaction is committed. The originating process can track the progress of the sequence with a series of <code class="cCode">TPDEQUEUE()</code> calls to the <code class="cCode">reply_queue</code>, if each member uses the same correlation-ID and returns a 0 length reply. 
</p>
<p class="pBody"><a name="wp1004305"> </a>
Alternatively, word of the successful completion of the entire sequence can be returned to the originator by using unsolicited notification. To make sure that the last transaction in the sequence ended with a <code class="cCode">TPCOMMIT</code>, a job step can be added that calls <code class="cCode">TPNOTIFY</code> using the client identifier that is carried in the <code class="cCodeEmphasis">TPQUEDEF-REC</code> structure. The originating client must have called <code class="cCode">TPSETUNSOL</code> to name the unsolicited message handler being used.
</p>
<h3 class="pHeading2"><a name="wp1004310"> </a>
Using Queues for Peer-to-Peer Communication
</h3>
<p class="pBody"><a name="wp1004311"> </a>
In all of the foregoing discussion of enqueuing and dequeuing messages there has been an implicit assumption that queues were being used as an alternative form of request/response processing. A message does not have to be a service request. The queued message facility can transfer data from one process to another as effectively as a service request. This style of communication between applications or clients is called peer-to-peer communication.
</p>
<p class="pBody"><a name="wp1005697"> </a>
If it suits your application to use Oracle Tuxedo /Q for this purpose, have the administrator create a separate queue and code your own receiving program for dequeuing <em class="cEmphasis">messages</em> from that queue.
</p>
 
<br/>
    <table id="SummaryNotReq2" width="100%" border="0" cellpadding="0" cellspacing="0">
      <tr> 
        <td>
&nbsp;
<a href="qcblpgm.html"><img id="LongDescNotReq7" src="/global_resources/images/backtop.gif" width="90" height="25" alt="Back to Top" title="Back to Top" border="0" /></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a accesskey="4" href="qpgm.html"><img id="LongDescNotReq8" src="/global_resources/images/prevtop.gif" border="0" alt="Previous" /></a>&nbsp;
<a accesskey="5" href="qsimp.html"><img id="LongDescNotReq9" src="/global_resources/images/nexttop.gif" border="0" alt="Next" /></a>
<script language="Javascript1.1" type="text/javascript">
Copyright();
</script>
<noscript><a href="http://edocs.bea.com/copyright.html">&copy; BEA Systems</a></noscript>
        </td>
      </tr>
    </table>

<!-- WebAnalytics BEGIN -->

<!--#include virtual="/global_resources/edocs_wt.html"-->
      
<!-- WebAnalytics END -->

  </body>
</html>
