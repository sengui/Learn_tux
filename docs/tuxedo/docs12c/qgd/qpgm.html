<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>

<!-- LOCALIZATION RELATED INFORMATION -->
<meta name="LOC_PROJ_ID" content="WLPF8.1" />
<meta name="LOC_OWNER" content="BEAJ" />
<meta name="LOC_STATUS" content="READY!" />
<meta name="LOC_COMMENT" content="LOC_COMMENT" />
<meta name="LOC_US_REV" content="1" />
<meta name="LOC_US_CHANGE" content="41263" />
<meta name="LOC_US_SRCFILE" content="//depot/tuxedo/tux11gr1/qgd/fm/qpgm.fm" />
<!-- LOCALIZATION RELATED INFORMATION -->

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta name="GENERATOR" content="Quadralay WebWorks AutoMap 2003 Platinum Edition for FrameMaker 8.6.6577.0" />
    <meta name="TEMPLATEBASE" content="BEA_WFP_Template_V1.04" />
    <meta name="LASTUPDATED" content="11/28/11 08:26:29" />
    <link rel="StyleSheet" href="/global_resources/edocs.css" type="text/css" media="all" />

<title>Oracle Tuxedo /Q C Language Programming</title>

<!-- BEA scripts begin -->

<script language="Javascript" src="/global_resources/js/banner.js" type="text/javascript"></script>
<!-- This script outputs the banner required for edocs documentation. -->

<script language="Javascript" src="floatwin.js" type="text/javascript"></script>
<!-- This script opens a new small floating window and puts TOC<i>&lt;name&gt;</i>.html and IX<i>&lt;name&gt;</i>.html files in it and sets a generic popup window code to enable the display of some viewlets in the WebLogic Platform Tour. -->

<script language="Javascript1.1" src="/global_resources/js/footer.js" type="text/javascript"></script>
<!-- This script outputs the footer with the correct copyright date and link to copyright page.-->

<script language="Javascript1.1" src="/global_resources/js/googlesearch4.js" type="text/javascript"></script>
<!-- This script outputs the google search form. -->

<script language="Javascript1.1" src="/global_resources/js/note.js" type="text/javascript"></script>
<!-- This script outputs a note such as a BETA note. -->

<script language="JavaScript1.1" src="/global_resources/js/search.js" type="text/javascript"></script>
<!-- This script is not for online documents. It is only used by the QuestAgent Java Applet for CD search indexes. -->

<!-- BEA scripts end -->

  </head>

  <body>


<script language="Javascript1.1" type="text/javascript">
GoogleURL();
</script><noscript>This script outputs the google search URL required for search on edocs documentation.</noscript>

<script language="Javascript1.1" type="text/javascript">
Banner();
</script><noscript>This script outputs the banner required for edocs documentation.</noscript>

<script language="Javascript1.1" type="text/javascript">
GoogleSearchCollection();
</script><noscript>This script outputs the google search parameters required for search on edocs documentation.</noscript>

<!-- page title -->
<h1 class="booktitle">Using the ATMI /Q Component
</h1>
<!-- page title end -->

    <table id="SummaryNotReq1" width="100%" border="0" align="left" cellpadding="2%" cellspacing="0">
      <tr> 
        <td>
&nbsp;&nbsp;&nbsp;&nbsp;
<a accesskey="4" href="qadm.html"><img id="LongDescNotReq1" src="/global_resources/images/doc_nav_prev.gif" border="0" alt="Previous" /></a>&nbsp;
<a accesskey="5" href="qcblpgm.html"><img id="LongDescNotReq2" src="/global_resources/images/doc_nav_next.gif" border="0" alt="Next" /></a>&nbsp;
<img id="LongDescNotReq3" src="/global_resources/images/doc_nav_dots.gif" border="0" alt="" />&nbsp;
<a accesskey="1" href="javascript:OpenWindowToc();" onmouseover="window.status='Table of Contents'; return true" onfocus="window.status='Table of Contents'; return true" onmouseout="window.status=''; return true" onblur="window.status=''; return true" title="Open TOC in new window">      <img id="LongDescNotReq4" src="/global_resources/images/doc_nav_contents.gif" alt="Open TOC in new window" border="0" /></a>&nbsp;
&nbsp;
<a href="../pdf/qgd.pdf" target="pdf"><img id="LongDescNotReq5" src="/global_resources/images/doc_nav_pdf.gif" width="59" height="44" alt="View as PDF - New Window" title="View as PDF - New Window" border="0" /></a>&nbsp;
<a href="http://www.adobe.com/products/acrobat/alternate.html" target="_blank"><img id="LongDescNotReq6" src="/global_resources/images/get_reader.gif" width="52" height="44" alt="Get Adobe Reader - New Window" title="Get Adobe Reader - New Window" border="0" /></a>
<a name="link_group_0"></a>
	</td>
      </tr>
    </table>

<a name="skipnav" title="Content starts here"><img src="/global_resources/images/_.gif" alt="Content starts here" border="0" height="1" width="1" /></a>



<h1 class="pChapHead"><a name="wp1020675"> </a>
Oracle Tuxedo /Q C Language Programming
</h1>
<p class="pBody"><a name="wp1018802"> </a>
This topic includes the following sections:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1010543"> </a><a href="qpgm.html#wp1010512">Introduction</a></li>
<li><a name="wp1010974"> </a><a href="qpgm.html#wp1003609">Prerequisite Knowledge</a></li>
<li><a name="wp1011037"> </a><a href="qpgm.html#wp1003614">Where Requests Can Originate</a></li>
<li><a name="wp1011106"> </a><a href="qpgm.html#wp1003623">Emphasis on the Default Case</a></li>
<li><a name="wp1011175"> </a><a href="qpgm.html#wp1003636">Enqueuing Messages</a></li>
<li><a name="wp1011326"> </a><a href="qpgm.html#wp1003884">Dequeuing Messages</a></li>
<li><a name="wp1011388"> </a><a href="qpgm.html#wp1004117">Sequential Processing of Messages</a></li>
</ul></div>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1010512"> </a>
Introduction
</h2><p class="pBody"><a name="wp1003607"> </a>
This topic deals with the use of the ATMI C language functions for enqueuing and dequeuing messages: <a href="../rf3c/rf3c.html">tpenqueue(3c)</a> and <a href="../rf3c/rf3c.html">tpdequeue(3c)</a>, plus some ancillary functions.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1003609"> </a>
Prerequisite Knowledge
</h2><p class="pBody"><a name="wp1003610"> </a>
The Oracle Tuxedo programmer coding client or server programs for the queued message facility should be familiar with the C language binding to the Oracle Tuxedo ATMI. General guidance on Oracle Tuxedo programming is available in <em class="cEmphasis">Programming Oracle Tuxedo ATMI Applications Using C</em>. Detailed pages on all the ATMI functions are in the <em class="cEmphasis">Oracle Tuxedo ATMI C Function Reference</em>.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1003614"> </a>
Where Requests Can Originate
</h2><p class="pBody"><a name="wp1003615"> </a>
The calls used to place a message on an Oracle Tuxedo /Q queue can originate from any client or server process associated with the application. The list includes:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1003617"> </a>Clients or servers on the same machine as the queue space or on another machine on the network.</li>
<li><a name="wp1004257"> </a>Conversational programs, although you cannot have a conversational connection with a queue (or with the <a href="../rf5/rf5.html">TMQUEUE(5)</a> server).</li>
<li><a name="wp1004262"> </a>Workstation clients via a surrogate process on the server side; the administrative interface is also entirely on the server side.</li>
</ul></div>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1003623"> </a>
Emphasis on the Default Case
</h2><p class="pBody"><a name="wp1003624"> </a>
The coverage of Oracle Tuxedo /Q programming in this topic primarily reflects the left-hand portion of the figure <a href="qoview.html#wp1006699">Queued Service Invocation</a>. In the figure, a client (or a process acting in the role of a client) queues a message by calling <a href="../rf3c/rf3c.html">tpenqueue(3c)</a> and specifying a queue space made available through a <a href="../rf5/rf5.html">TMQUEUE(5)</a> server. The client later retrieves a reply via a <a href="../rf3c/rf3c.html">tpdequeue(3c)</a> call to <code class="cCode">TMQUEUE</code>.
</p>
<p class="pBody"><a name="wp1003628"> </a>
The figure <a href="qoview.html#wp1006699">Queued Service Invocation</a> shows the queued message being dequeued by the server <a href="../rf5/rf5.html">TMQFORWARD(5)</a> and sent to an application server for processing (via <a href="../rf3c/rf3c.html">tpcall(3c)</a>). When a reply to the <code class="cCode">tpcall()</code> is received, <code class="cCode">TMQFORWARD</code> enqueues the reply message. Because a major goal of <code class="cCode">TMQFORWARD</code> is to provide an interface between the queue space and existing application services, it does not require further application coding. For that reason, this topic concentrates on the client-to-queue space side.
</p>
<p class="pBody"><a name="wp1003634"> </a>
A brief example of the use of the queued message facility is distributed with the software and is described in <a href="qsimp.html">A Sample Application</a>.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1003636"> </a>
Enqueuing Messages
</h2><p class="pBody"><a name="wp1003637"> </a>
The syntax for <code class="cCode">tpenqueue()</code> is as follows:
</p>
<a name="wp1003638"> </a><div class="pPreformatted"><pre>#include &lt;atmi.h&gt;<br />int tpenqueue(char *<code class="cCodeEmphasis">qspace</code>, char *<code class="cCodeEmphasis">qname</code>, TPQCTL *<code class="cCodeEmphasis">ctl</code>,<br />     char *<code class="cCodeEmphasis">data</code>, long <code class="cCodeEmphasis">len</code>, long <code class="cCodeEmphasis">flags</code>)</pre></div><p class="pBody"><a name="wp1003641"> </a>
When a <code class="cCode">tpenqueue()</code> call is issued, it tells the system to store a message on the queue identified in <code class="cCodeEmphasis">qname</code> in the space identified in <code class="cCodeEmphasis">qspace</code>. The message is in the buffer pointed to by <code class="cCodeEmphasis">data</code> and has a length of <code class="cCodeEmphasis">len</code>. By the use of bit settings in <code class="cCodeEmphasis">flags</code>, the system is informed how the call to <code class="cCode">tpenqueue()</code> is to be handled. Further information about the handling of the enqueued message and replies is provided in the <code class="cCode">TMQCTL</code> structure pointed to by <code class="cCodeEmphasis">ctl</code>.
</p>
<h3 class="pHeading2"><a name="wp1003646"> </a>
tpenqueue(3c) Arguments
</h3>
<p class="pBody"><a name="wp1003647"> </a>
There are some important arguments to control the operation of <a href="../rf3c/rf3c.html">tpenqueue(3c)</a>. Let&#8217;s look at some of them.
</p>
<h4 class="pHeading3"><a name="wp1003649"> </a>
tpenqueue(): The qspace Argument
</h4>
<p class="pBody"><a name="wp1003650"> </a>
<code class="cCodeEmphasis">qspace</code> identifies a queue space previously created by the administrator. When a server is defined in the <code class="cCode">SERVERS</code> section of the configuration file, the service names it offers are aliases for the actual queue space name (which is specified as part of the <code class="cCode">OPENINFO</code> parameter in the <code class="cCode">GROUPS</code> section). For example, when your application uses the server <code class="cCode">TMQUEUE</code>, the value pointed at by the <code class="cCodeEmphasis">qspace</code> argument is the name of a service advertised by <code class="cCode">TMQUEUE</code>. If no service aliases are defined, the default service is the same as the server name, <code class="cCode">TMQUEUE</code>. In this case the configuration file might include: 
</p>
<a name="wp1003657"> </a><div class="pPreformatted"><pre>TMQUEUE<br />        SRVGRP = QUE1  SRVID = 1<br />        GRACE = 0  RESTART = Y CONV = N<br />        CLOPT = &quot;-A&quot;</pre></div><p class="pBody"><a name="wp1018815"> </a>
or
</p>
<a name="wp1018843"> </a><div class="pPreformatted"><pre>	CLOPT = &quot;-s TMQUEUE&quot;</pre></div><p class="pBody"><a name="wp1003663"> </a>
The entry for server group <code class="cCode">QUE1</code> has an <code class="cCode">OPENINFO</code> parameter that specifies the resource manager, the pathname of the device and the queue space name. The <code class="cCode">qspace</code> argument in a client program then looks like this: 
</p>
<a name="wp1003666"> </a><div class="pPreformatted"><pre>if (tpenqueue(&quot;TMQUEUE&quot;, &quot;STRING&quot;, (TPQCTL *)&amp;qctl,<br />        (char *)reqstr, 0,0) == -1) {<br />        Error checking<br />}</pre></div><p class="pBody"><a name="wp1003670"> </a>
The example shown on the <a href="../rf5/rf5.html">TMQUEUE(5)</a> reference page shows how alias service names can be included when the server is built and specified in the configuration file. The sample program in <a href="qsimp.html">A Sample Application</a>, also specifies an alias service name.
</p>
<h4 class="pHeading3"><a name="wp1003673"> </a>
tpenqueue(): The qname Argument
</h4>
<p class="pBody"><a name="wp1003674"> </a>
Within a queue space, when queues are being used to invoke services, message queues are named according to the application services available to process requests. <code class="cCodeEmphasis">qname</code> is a pointer to such an application service. Otherwise, <code class="cCode">qname</code> is simply the name of the location where the message is to be stored until it is dequeued by an application (either the same application that enqueued it or another one).
</p>
<h4 class="pHeading3"><a name="wp1004321"> </a>
tpenqueue(): The data and len Arguments
</h4>
<p class="pBody"><a name="wp1003678"> </a>
<code class="cCodeEmphasis">data</code> points to a buffer that contains the message to be processed. The buffer must be one that was allocated with a call to <a href="../rf3c/rf3c.html">tpalloc(3c)</a>. <code class="cCodeEmphasis">len</code> gives the length of the message. Some Oracle Tuxedo buffer types (such as FML) do not require that the length of the message be specified; in such cases, the <code class="cCodeEmphasis">len</code> argument is ignored. <code class="cCodeEmphasis">data</code> can be NULL; when it is, <code class="cCodeEmphasis">len</code> is ignored and the message is enqueued with no data portion.
</p>
<h4 class="pHeading3"><a name="wp1003683"> </a>
tpenqueue(): The flags Arguments
</h4>
<p class="pBody"><a name="wp1003684"> </a>
<code class="cCodeEmphasis">flags</code> values are used to tell the Oracle Tuxedo system how the <code class="cCode">tpenqueue()</code> call is handled; the following are valid flags: 
</p>
<h4 class="pDefTerm"><a name="wp1003686"> </a>
<code class="cCode">TPNOTRAN</code> 
</h4><div class="pDefPara"><a name="wp1013833"> </a>
If the caller is in transaction mode and this flag is set, the message is not queued within the caller&#8217;s transaction. A caller in transaction mode that sets this flag is still subject to the transaction timeout (and no other) when queuing the message. If message queuing fails, the caller&#8217;s transaction is not affected.
</div>
<h4 class="pDefTerm"><a name="wp1003689"> </a>
<code class="cCode">TPNOBLOCK</code> 
</h4><div class="pDefPara"><a name="wp1011841"> </a>
The message is not enqueued if a blocking condition exists. If this flag is set and a blocking condition exists such as the internal buffers into which the message is transferred are full, the call fails and <a href="../rf5/rf5.html">tperrno(5)</a> is set to <code class="cCode">TPEBLOCK</code>. If this flag is set and a blocking condition exists because the target queue is opened <em class="cEmphasis">exclusively</em> by another application, the call fails, <code class="cCode">tperrno()</code> is set to <code class="cCode">TPEDIAGNOSTIC</code>, and the diagnostic field of the <code class="cCode">TPQCTL</code> structure is set to <code class="cCode">QMESHARE</code>. In the latter case, the other application, which is based on an Oracle product other than the Oracle Tuxedo system, opened the queue for exclusive read and/or write using the Queuing Services API (QSAPI).
</div>
<div class="pDefParaCont"><a name="wp1011842"> </a>
When <code class="cCode">TPNOBLOCK</code> is not set and a blocking condition exists, the caller blocks until the condition subsides or a timeout occurs (either transaction or blocking timeout). If a timeout occurs, the call fails and <code class="cCode">tperrno()</code> is set to <code class="cCode">TPETIME</code>.
</div>
<h4 class="pDefTerm"><a name="wp1013053"> </a>
<code class="cCode">TPNOTIME</code> 
</h4><div class="pDefPara"><a name="wp1013054"> </a>
Setting this flag signifies that the caller is willing to block indefinitely and wants to be immune to blocking timeouts. Transaction timeouts may still occur.
</div>
<h4 class="pDefTerm"><a name="wp1003696"> </a>
<code class="cCode">TPSIGRSTRT</code> 
</h4><div class="pDefPara"><a name="wp1003697"> </a>
Setting this flag indicates that any underlying system calls that are interrupted by a signal should be reissued. When this flag is not set and a signal interrupts a system call, the call fails and sets <a href="../rf5/rf5.html">tperrno(5)</a> to <code class="cCode">TPGOTSIG</code>.
</div>
<h3 class="pHeading2"><a name="wp1003700"> </a>
TPQCTL Structure
</h3>
<p class="pBody"><a name="wp1003701"> </a>
The third argument to <code class="cCode">tpenqueue()</code> is a pointer to a structure of type <code class="cCode">TPQCTL</code>. The <code class="cCode">TPQCTL</code> structure has members that are used by the application and by the Oracle Tuxedo system to pass parameters in both directions between application programs and the queued message facility. The client that calls <code class="cCode">tpenqueue()</code> sets flags to mark fields the application wants the system to fill in. The structure is also used by <code class="cCode">tpdequeue()</code>; some of the fields do not come into play until the application calls that function. The complete structure is shown in <a href="qpgm.html#wp1003707">Listing&#160;3-1</a>.
</p>
<div class="pCodeTitle"><a name="wp1003707"> </a>
Listing&#160;3-1	   The tpqctl_t Structure
</div> <a name="wp1007564"> </a><div class="pPreformatted"><pre>#define TMQNAMELEN 127 <br />#define TMMSGIDLEN 32 <br />#define TMCORRIDLEN 32<br /><br />struct tpqctl_t {            /* control parameters to queue primitives */ <br />     long flags;             /* indicates which of the values are set */ <br />     long deq_time;          /* absolute/relative time for dequeuing */ <br />     long priority;          /* enqueue priority */ <br />     long diagnostic;        /* indicates reason for failure */ <br />     char msgid[TMMSGIDLEN];      /* ID of message before which to queue */ <br />     char corrid[TMCORRIDLEN];    /* correlation ID used to identify message */ <br />     char replyqueue[TMQNAMELEN+1];   /* queue name for reply message */ <br />     char failurequeue[TMQNAMELEN+1]; /* queue name for failure message */ <br />     CLIENTID cltid;         /* client identifier for originating client */ <br />     long urcode;            /* application user-return code */ <br />     long appkey;            /* application authentication client key */ <br />     long delivery_qos;      /* delivery quality of service */ <br />     long reply_qos;         /* reply message quality of service */ <br />     long exp_time;          /* expiration time */ <br />}; <br />typedef struct tpqctl_t TPQCTL;</pre></div><p class="pBody"><a name="wp1006253"> </a>
The following is a list of valid bits for the <code class="cCodeEmphasis">flags</code> parameter controlling input information for <code class="cCode">tpenqueue()</code>. 
</p>
<h4 class="pDefTerm"><a name="wp1003727"> </a>
<code class="cCode">TPNOFLAGS</code> 
</h4><div class="pDefPara"><a name="wp1003728"> </a>
No flags or values are set. No information is taken from the control structure. Leaving fields of the structure not set is equivalent to a setting of <code class="cCode">TPNOFLAGS</code>. 
</div>
<h4 class="pDefTerm"><a name="wp1003730"> </a>
<code class="cCode">TPQTOP</code> 
</h4><div class="pDefPara"><a name="wp1003731"> </a>
Setting this flag indicates that the queue ordering be overridden and the message placed at the top of the queue. This request may not be granted depending on whether or not the queue was configured to allow overriding the queue ordering to put a message at the top of the queue. <code class="cCode">TPQTOP</code> and <code class="cCode">TPQBEFOREMSGID</code> are mutually exclusive flags
</div>
<h4 class="pDefTerm"><a name="wp1003735"> </a>
<code class="cCode">TPQBEFOREMSGID</code>
</h4><div class="pDefPara"><a name="wp1003736"> </a>
Setting this flag indicates that the queue ordering be overridden and the message placed in the queue before the message identified by <code class="cCodeEmphasis">ctl-&gt;msgid</code>. This request may not be granted depending on whether or not the queue was configured to allow overriding the queue ordering. <code class="cCode">TPQTOP</code> and <code class="cCode">TPQBEFOREMSGID</code> are mutually exclusive flags. Note that the entire 32 bytes of the message identifier value are significant, so the value identified by <code class="cCodeEmphasis">ctl-&gt;msgid</code> must be completely initialized (for example, padded with NULL characters).
</div>
<h4 class="pDefTerm"><a name="wp1003742"> </a>
<code class="cCode">TPQTIME_ABS</code> 
</h4><div class="pDefPara"><a name="wp1003743"> </a>
If this flag is set, the message is made available after the time specified by <code class="cCodeEmphasis">ctl-&gt;deq_time</code>. The <code class="cCodeEmphasis">deq_time</code> is an absolute time value as generated by <code class="cCode">time(2)</code> or <code class="cCode">mktime(3C)</code>, if they are available to your application, or <a href="../rf3c/rf3c.html">gp_mktime(3c)</a>, provided with the Oracle Tuxedo system. The value set in <code class="cCodeEmphasis">ctl-&gt;deq_time</code> is the number of seconds since 00:00:00 Universal Coordinated Time&#8212;UTC, January 1,1970. The absolute time is set based on the clock on the machine where the queue manager process resides. <code class="cCode">TPQTIME_ABS</code> and <code class="cCode">TPQTIME_REL</code> are mutually exclusive flags.
</div>
<h4 class="pDefTerm"><a name="wp1003749"> </a>
<code class="cCode">TPQTIME_REL</code> 
</h4><div class="pDefPara"><a name="wp1003750"> </a>
If this flag is set, the message is made available after a time relative to the completion of the enqueuing operation. <code class="cCodeEmphasis">ctl-&gt;deq_time</code> specifies the number of seconds to delay after the enqueuing completes before the submitted message should be available. <code class="cCode">TPQTIME_ABS</code> and <code class="cCode">TPQTIME_REL</code> are mutually exclusive flags.
</div>
<h4 class="pDefTerm"><a name="wp1003755"> </a>
<code class="cCode">TPQPRIORITY</code> 
</h4><div class="pDefPara"><a name="wp1003756"> </a>
If this flag is set, the priority at which the request should be enqueued is stored in <code class="cCodeEmphasis">ctl-&gt;priority</code>. The priority must be in the range 1 to 100, inclusive. The higher the number, the higher the priority, that is, a message with a higher number is dequeued before a message with a lower number from queues ordered by priority. For queues not ordered by priority, the value is informational.
</div>
<div class="pDefParaCont"><a name="wp1011926"> </a>
If this flag is not set, the priority for the message is 50 by default.
</div>
<h4 class="pDefTerm"><a name="wp1003758"> </a>
<code class="cCode">TPQCORRID</code> 
</h4><div class="pDefPara"><a name="wp1003759"> </a>
If this flag is set, the correlation identifier value specified in <code class="cCodeEmphasis">ctl-&gt;corrid</code> is available when a request is dequeued with <a href="../rf3c/rf3c.html">tpdequeue(3c)</a>. This identifier accompanies any reply or failure message that is queued so an application can correlate a reply with a particular request. Note that the entire 32 bytes of the correlation identifier value are significant, so the value specified in <code class="cCodeEmphasis">ctl-&gt;corrid</code> must be completely initialized (for example, padded with NULL characters).
</div>
<h4 class="pDefTerm"><a name="wp1003764"> </a>
<code class="cCode">TPQREPLYQ</code> 
</h4><div class="pDefPara"><a name="wp1003765"> </a>
If this flag is set, a reply queue named in <code class="cCodeEmphasis">ctl-&gt;replyqueue</code> is associated with the queued message. Any reply to the message is queued to the named queue within the same queue space as the request message. This string must be NULL-terminated (maximum 127 characters in length). If a reply is generated for the service and a reply queue is not specified or the reply queue does not exist, the reply is dropped. 
</div>
<h4 class="pDefTerm"><a name="wp1003770"> </a>
<code class="cCode">TPQFAILUREQ</code> 
</h4><div class="pDefPara"><a name="wp1013167"> </a>
If this flag is set, a failure queue named in the <code class="cCodeEmphasis">ctl-&gt;failurequeue</code> is associated with the queued message. If (1) the enqueued message is processed by <code class="cCode">TMQFORWARD()</code>, (2) <code class="cCode">TMQFORWARD</code> was started with the <code class="cCode">-d</code> option, and (3) the service fails and returns a non-NULL reply, a failure message consisting of the reply and its associated <code class="cCode">tpurcode</code> is enqueued to the named queue within the same queue space as the original request message. This string must be NULL-terminated (maximum 127 characters in length).
</div>
<h4 class="pDefTerm"><a name="wp1007017"> </a>
<code class="cCode">TPQDELIVERYQOS</code>, <code class="cCode">TPQREPLYQOS</code> 
</h4><div class="pDefPara"><a name="wp1011930"> </a>
If the <code class="cCode">TPQDELIVERYQOS</code> flag is set, the flags specified by <code class="cCodeEmphasis">ctl-&gt;delivery_qos</code> control the quality of service for delivery of the message. In this case, one of three mutually exclusive flags&#8212; <code class="cCode">TPQQOSDEFAULTPERSIST</code>, <code class="cCode">TPQQOSPERSISTENT</code>, or <code class="cCode">TPQQOSNONPERSISTENT</code>&#8212;must be set in <code class="cCodeEmphasis">ctl-&gt;delivery_qos</code>. If <code class="cCode">TPQDELIVERYQOS</code> is not set, the default delivery policy of the target queue dictates the delivery quality of service for the message.
</div>
<div class="pDefParaCont"><a name="wp1011931"> </a>
If the <code class="cCode">TPQREPLYQOS</code> flag is set, the flags specified by <code class="cCodeEmphasis">ctl-&gt;reply_qos</code> control the quality of service for any reply to the message. In this case, one of three mutually exclusive flags&#8212;<code class="cCode">TPQQOSDEFAULTPERSIST</code>, <code class="cCode">TPQQOSPERSISTENT</code>, or <code class="cCode">TPQQOSNONPERSISTENT</code>&#8212;must be set in <code class="cCodeEmphasis">ctl-&gt;reply_qos</code>. The <code class="cCode">TPQREPLYQOS</code> flag is used when a reply is returned from messages processed by <code class="cCode">TMQFORWARD</code>. Applications not using <code class="cCode">TMQFORWARD</code> to invoke services may use the <code class="cCode">TPQREPLYQOS</code> flag as a hint for their own reply mechanism.
<a name="wp1012903"> </a>
If TPQREPLYQOS is not set, the default delivery policy of the <code class="cCodeEmphasis">ctl-&gt;replyqueue</code> queue dictates the delivery quality of service for any reply. Note that the default delivery policy is determined when the reply to a message is enqueued. That is, if the default delivery policy of the reply queue is modified between the time that the original message is enqueued and the reply to the message is enqueued, the policy used is the one in effect when the reply is finally enqueued.
<a name="wp1012949"> </a>
The following is the list of valid flags for <code class="cCodeEmphasis">ctl-&gt;delivery_qos</code> and <code class="cCodeEmphasis">ctl-&gt;reply_qos</code>:
</div>
<div class="pDefTerm2"><h4 class="pDefTerm2"><a name="wp1012950"> </a>
<code class="cCode">TPQQOSDEFAULTPERSIST</code>
</h4></div>
<div class="pDefPara2"><a name="wp1012951"> </a>
This flag specifies that the message is to be delivered using the default delivery policy specified on the target queue.
</div><div class="pDefTerm2"><h4 class="pDefTerm2"><a name="wp1012952"> </a>
<code class="cCode">TPQQOSPERSISTENT</code>
</h4></div>
<div class="pDefPara2"><a name="wp1012953"> </a>
This flag specifies that the message is to be delivered in a persistent manner using the disk-based delivery method. When specified, this flag overrides the default delivery policy specified on the target queue.
</div><div class="pDefTerm2"><h4 class="pDefTerm2"><a name="wp1012954"> </a>
<code class="cCode">TPQQOSNONPERSISTENT</code>
</h4></div>
<div class="pDefPara2"><a name="wp1012955"> </a>
This flag specifies that the message is to be delivered in a non-persistent manner using the memory-based delivery method. Specifically, the message is queued in memory until it is dequeued. When specified, this flag overrides the default delivery policy specified on the target queue. If the caller is transactional, non-persistent messages are enqueued within the caller&#8217;s transaction, however, non-persistent messages are lost if the system is shut down, crashes, or the IPC shared memory for the queue space is removed.
</div><h4 class="pDefTerm"><a name="wp1015074"> </a>
<code class="cCode">TPQEXPTIME_ABS</code>
</h4><div class="pDefPara"><a name="wp1015075"> </a>
If this flag is set, the message has an absolute expiration time, which is the absolute time when the message will be removed from the queue.
<a name="wp1015076"> </a>
The absolute expiration time is determined by the clock on the machine where the queue manager process resides.
</div>
<div class="pDefParaCont"><a name="wp1015077"> </a>
The absolute expiration time is indicated by the value stored in <code class="cCodeEmphasis">ctl-&gt;exp_time</code>. The value of <code class="cCodeEmphasis">ctl-&gt;exp_time</code> must be set to an absolute time value generated by <code class="cCode">time(2)</code>, <code class="cCode">mktime(3C)</code>, or <a href="../rf3c/rf3c.html">gp_mktime(3c)</a> (the number of seconds since 00:00:00 Universal Coordinated Time&#8212;UTC, January 1, 1970).
<a name="wp1015078"> </a>
If an absolute time is specified that is earlier than the time of the enqueue operation, the operation succeeds, but the message is not counted for the purpose of calculating thresholds. If the expiration time is before the message availability time, the message is not available for dequeuing unless either the availability or expiration time is changed so that the availability time is before the expiration time. In addition, these messages are removed from the queue at expiration time even if they were never available for dequeuing. If a message expires while it is within a transaction, the expiration does not cause the transaction to fail. Messages that expire while being enqueued or dequeued within a transaction are removed from the queue when the transaction ends. There is no notification that the message has expired.
<a name="wp1015079"> </a>
<code class="cCode">TPQEXPTIME_ABS</code>, <code class="cCode">TPQEXPTIME_REL</code>, and <code class="cCode">TPQEXPTIME_NONE</code> are mutually exclusive flags. If none of these flags is set, the default expiration time associated with the target queue is applied to the message.
</div>
<h4 class="pDefTerm"><a name="wp1015080"> </a>
<code class="cCode">TPQEXPTIME_REL</code>
</h4><div class="pDefPara"><a name="wp1015081"> </a>
If this flag is set, the message has a relative expiration time, which is the number of seconds <em class="cEmphasis">after</em> the message arrives at the queue that the message is removed from the queue. The relative expiration time is indicated by the value stored in <code class="cCodeEmphasis">ctl-&gt;exp_time</code>.
</div>
<div class="pDefParaCont"><a name="wp1015082"> </a>
If the expiration time is before the message availability time, the message is not available for dequeuing unless either the availability or expiration time is changed so that the availability time is before the expiration time. In addition, these messages are removed from the queue at expiration time even if they were never available for dequeuing. The expiration of a message during a transaction, does not cause the transaction to fail. Messages that expire while being enqueued or dequeued within a transaction are removed from the queue when the transaction ends. There is no acknowledgment that the message has expired.
<a name="wp1015083"> </a>
<code class="cCode">TPQEXPTIME_ABS</code>, <code class="cCode">TPQEXPTIME_REL</code>, and <code class="cCode">TPQEXPTIME_NONE</code> are mutually exclusive flags. If none of these flags is set, the default expiration time associated with the target queue is applied to the message.
</div>
<h4 class="pDefTerm"><a name="wp1007023"> </a>
<code class="cCode">TPQEXPTIME_NONE</code>
</h4><div class="pDefPara"><a name="wp1007024"> </a>
Setting this flag indicates that the message should not expire, even if the default policy of the queue includes an expiration time.
</div>
<div class="pDefParaCont"><a name="wp1014113"> </a>
<code class="cCode">TPQEXPTIME_ABS</code>, <code class="cCode">TPQEXPTIME_REL</code>, and <code class="cCode">TPQEXPTIME_NONE</code> are mutually exclusive flags. If none of these flags is set, the default expiration time associated with the target queue is applied to the message.
</div>
<p class="pBody"><a name="wp1008406"> </a>
Additionally, the <code class="cCodeEmphasis">urcode</code> field of <code class="cCode">TPQCTL</code> can be set with a user-return code. This value will be returned to the application that calls <a href="../rf3c/rf3c.html">tpdequeue(3c)</a> to dequeue the message. 
</p>
<p class="pBody"><a name="wp1008407"> </a>
On output from <code class="cCode">tpenqueue()</code>, the following fields may be set in the <code class="cCode">TPQCTL</code> structure: 
</p>
<a name="wp1008408"> </a><div class="pPreformatted"><pre>long flags;            /* indicates which of the values are set */<br />char msgid[32];        /* ID of enqueued message */<br />long diagnostic;       /* indicates reason for failure */</pre></div><p class="pBody"><a name="wp1016653"> </a>
The following is a valid bit for the <code class="cCodeEmphasis">flags</code> parameter controlling output information from <code class="cCode">tpenqueue()</code>. If this flag is turned on when <code class="cCode">tpenqueue()</code> is called, the /Q server <a href="../rf5/rf5.html">TMQUEUE(5)</a> populates the associated element in the structure with a message identifier. If this flag is turned off when <code class="cCode">tpenqueue()</code> is called, <code class="cCode">TMQUEUE()</code> does <em class="cEmphasis">not</em> populate the associated element in the structure with a message identifier.
</p>
<h4 class="pDefTerm"><a name="wp1016654"> </a>
<code class="cCode">TPQMSGID</code> 
</h4><div class="pDefPara"><a name="wp1016655"> </a>
If this flag is set and the call to <code class="cCode">tpenqueue()</code> is successful, the message identifier is stored in <code class="cCodeEmphasis">ctl-&gt;msgid</code>. The entire 32 bytes of the message identifier value are significant, so the value stored in <code class="cCodeEmphasis">ctl-&gt;msgid</code> is completely initialized (for example, padded with null characters). The actual padding character used for initialization varies between releases of the Oracle Tuxedo /Q component.
</div>
<p class="pBody"><a name="wp1008459"> </a>
The remaining members of the control structure are not used on input to <code class="cCode">tpenqueue()</code>. 
</p>
<p class="pBody"><a name="wp1008453"> </a>
If the call to <code class="cCode">tpenqueue()</code> fails and <a href="../rf5/rf5.html">tperrno(5)</a> is set to <code class="cCode">TPEDIAGNOSTIC</code>, a value indicating the reason for failure is returned in <code class="cCodeEmphasis">ctl-&gt;diagnostic</code>. The possible values are: 
</p>
<h4 class="pDefTerm"><a name="wp1003791"> </a>
[<code class="cCode">QMEINVAL</code>]
</h4><div class="pDefPara"><a name="wp1003792"> </a>
An invalid flag value was specified.
</div>
<h4 class="pDefTerm"><a name="wp1003793"> </a>
[<code class="cCode">QMEBADRMID</code>] 
</h4><div class="pDefPara"><a name="wp1003794"> </a>
An invalid resource manager identifier was specified.
</div>
<h4 class="pDefTerm"><a name="wp1003795"> </a>
[<code class="cCode">QMENOTOPEN</code>] 
</h4><div class="pDefPara"><a name="wp1003796"> </a>
The resource manager is not currently open.
</div>
<h4 class="pDefTerm"><a name="wp1003797"> </a>
[<code class="cCode">QMETRAN</code>] 
</h4><div class="pDefPara"><a name="wp1003798"> </a>
The call was made in transaction mode or was made with the <code class="cCode">TPNOTRAN</code> flag set and an error occurred trying to start a transaction in which to enqueue the message. This diagnostic is not returned by queue managers from Oracle Tuxedo release 7.1 or later.
</div>
<h4 class="pDefTerm"><a name="wp1003800"> </a>
[<code class="cCode">QMEBADMSGID</code>] 
</h4><div class="pDefPara"><a name="wp1003801"> </a>
An invalid message identifier was specified.
</div>
<h4 class="pDefTerm"><a name="wp1003802"> </a>
[<code class="cCode">QMESYSTEM</code>] 
</h4><div class="pDefPara"><a name="wp1003803"> </a>
A system error occurred. The exact nature of the error is written to a log file.
</div>
<h4 class="pDefTerm"><a name="wp1003806"> </a>
[<code class="cCode">QMEOS</code>] 
</h4><div class="pDefPara"><a name="wp1008618"> </a>
An operating system error occurred.
</div>
<h4 class="pDefTerm"><a name="wp1008605"> </a>
[<code class="cCode">QMEABORTED</code>] 
</h4><div class="pDefPara"><a name="wp1003807"> </a>
The operation was aborted. If the aborted operation was being executed within a global transaction, the global transaction is marked rollback-only. Otherwise, the queue manager aborts the operation.
</div>
<h4 class="pDefTerm"><a name="wp1003808"> </a>
[<code class="cCode">QMEPROTO</code>] 
</h4><div class="pDefPara"><a name="wp1003809"> </a>
An enqueue was done when the transaction state was not active.
</div>
<h4 class="pDefTerm"><a name="wp1003810"> </a>
[<code class="cCode">QMEBADQUEUE</code>] 
</h4><div class="pDefPara"><a name="wp1003811"> </a>
An invalid or deleted queue name was specified.
</div>
<h4 class="pDefTerm"><a name="wp1003812"> </a>
[<code class="cCode">QMENOSPACE</code>] 
</h4><div class="pDefPara"><a name="wp1014220"> </a>
Due to an insufficient resource, such as no space on the queue, the message with its required quality of service (persistent or non-persistent storage) was not enqueued. <code class="cCode">QMENOSPACE</code> is returned when any of the following configured resources is exceeded: (1) the amount of disk (persistent) space allotted to the queue space, (2) the amount of memory (non-persistent) space allotted to the queue space, (3) the maximum number of simultaneously active transactions allowed for the queue space, (4) the maximum number of messages that the queue space can contain at any one time, (5) the maximum number of concurrent actions that the Queuing Services component can handle, or (6) the maximum number of authenticated users that may concurrently use the Queuing Services component.
</div>
<h4 class="pDefTerm"><a name="wp1012540"> </a>
[<code class="cCode">QMERELEASE</code>] 
</h4><div class="pDefPara"><a name="wp1012541"> </a>
An attempt was made to enqueue a message to a queue manager that is from a version of the Oracle Tuxedo system that does not support a newer feature.
</div>
<h4 class="pDefTerm"><a name="wp1012977"> </a>
[<code class="cCode">QMESHARE</code>] 
</h4><div class="pDefPara"><a name="wp1012978"> </a>
When enqueuing a message from a specified queue, the specified queue is opened <em class="cEmphasis">exclusively</em> by another application. The other application is one based on an Oracle product other than the Oracle Tuxedo system that opened the queue for exclusive read and/or write using the Queuing Services API (QSAPI).
</div>
<h4 class="pHeading3"><a name="wp1003815"> </a>
Overriding the Queue Order
</h4>
<p class="pBody"><a name="wp1003816"> </a>
If the administrator, in creating a queue, allows <code class="cCode">tpenqueue()</code> calls to override the order of messages on the queue, you have two mutually exclusive ways to use that capability. You can specify that the message is to be placed at the top of the queue by setting <code class="cCodeEmphasis">flags</code> to include <code class="cCode">TPQTOP</code> or you can specify that it be placed ahead of a specific message by setting <code class="cCodeEmphasis">flags</code> to include <code class="cCode">TPQBEFOREMSGID</code> and setting <code class="cCodeEmphasis">ctl-&gt;msgid</code> to the ID of the message you wish to precede. This assumes that you saved the message-ID from a previous call in order to be able to use it here. Your administrator must tell you what the queue supports; it can be created to allow either or both of these overrides, or to allow neither.
</p>
<h4 class="pHeading3"><a name="wp1003823"> </a>
Overriding the Queue Priority
</h4>
<p class="pBody"><a name="wp1003824"> </a>
You can set a value in <code class="cCodeEmphasis">ctl-&gt;priority</code> to specify the priority of the message. The value must be in the range 1 to 100; the higher the number the higher the priority. If <code class="cCode">priority</code> was not one of the queue ordering parameters, setting a priority here has no effect on the dequeuing order, however the priority value is retained so that the value can be inspected when the message is dequeued.
</p>
<h3 class="pHeading2"><a name="wp1003828"> </a>
Setting a Message Availability Time
</h3>
<p class="pBody"><a name="wp1003829"> </a>
You can specify in <code class="cCodeEmphasis">deq_time</code> either an absolute time or a time relative to the completion of the enqueuing operation for the message to be made available. You set <code class="cCodeEmphasis">flags</code> to include either <code class="cCode">TPQTIME_ABS</code> or <code class="cCode">TPQTIME_REL</code> to indicate how the value should be treated. A queue may be created with <code class="cCode">time</code> as a queue ordering criterion, in which case the messages are ordered by the message availability time.
</p>
<p class="pBody"><a name="wp1003833"> </a>
Oracle Tuxedo /Q provides a function, <a href="../rf3c/rf3c.html">gp_mktime(3c)</a>, that is used to convert a date and time provided in a <code class="cCode">tm</code> structure to the number of seconds since January 1, 1970. The <code class="cCode">time</code>(2) and <code class="cCode">mktime</code>(3C) functions may also be used instead of <code class="cCode">gp_mktime</code>(3c). The value is returned in <code class="cCode">time_t</code>, a <code class="cCode">typedef&#39;d</code> long. To set an absolute time for the message to be dequeued (we are using 12:00 noon, December 9, 2001), do the following. 
</p>
<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1003838"> </a>Place the values for the date you want to use in the <code class="cCode">tm</code> structure.</li>
<a name="wp1006175"> </a><div class="pPreformattedRelative"><pre>#include &lt;stdio.h&gt;<br />#include &lt;time.h&gt;<br />static char *const wday[] = {<br />         &quot;Sunday&quot;, &quot;Monday&quot;, &quot;Tuesday&quot;, &quot;Wednesday&quot;,<br />         &quot;Thursday&quot;, &quot;Friday&quot;, &quot;Saturday&quot;, &quot;-unknown-&quot;<br />};<br />struct tm time_str;<br />/*...*/<br />time_str.tm_year = 2001 - 1900;<br />time_str.tm_mon = 12 - 1;<br />time_str.tm_mday = 9;<br />time_str.tm_hour = 12;<br />time_str.tm_min = 0;<br />time_str.tm_sec = 1;<br />time_str.tm_isdst = -1;</pre></div><li><a name="wp1005288"> </a>Call <code class="cCode">gp_mktime</code> to produce a value for <code class="cCode">deq_time</code> and set the <code class="cCodeEmphasis">flags</code> to indicate that an absolute time is being provided. </li>
<a name="wp1003857"> </a><div class="pPreformattedRelative"><pre>#include &lt;atmi.h&gt;<br />TPQCTL qctl;<br />if ((qctl-&gt;deq_time = (long)gp_mktime(&amp;time_str)) == -1) {<br />        /* check for errors */<br />}<br />qctl-&gt;flags = TPQTIME_ABS</pre></div><li><a name="wp1006565"> </a>Call <code class="cCode">tpenqueue()</code>.</li>
<a name="wp1006566"> </a><div class="pPreformattedRelative"><pre>if (tpenqueue(qspace, qname, qctl, *data,*len,*flags) == -1) {<br />       /* check for errors */<br />}</pre></div></ol></div>
<p class="pBody"><a name="wp1003868"> </a>
If you want to specify a relative time for dequeuing, for example, <code class="cCodeEmphasis">nnn</code> seconds after the completion of the enqueuing operation, place the number of seconds in <code class="cCode">deq_time</code> and set <code class="cCode">flags</code> to include <code class="cCode">TPQTIME_REL</code>.
</p>
<h3 class="pHeading2"><a name="wp1003871"> </a>
tpenqueue() and Transactions
</h3>
<p class="pBody"><a name="wp1003872"> </a>
If a caller of <code class="cCode">tpenqueue()</code> is in transaction mode and <code class="cCode">TPNOTRAN</code> is not set, then the enqueuing is done within the caller&#39;s transaction. The caller knows for certain from the success or failure of <code class="cCode">tpenqueue()</code> whether the message was enqueued or not. If the call succeeds, the message is guaranteed to be on the queue. If the call fails, the transaction is rolled back, including the part where the message was placed on the queue. 
</p>
<p class="pBody"><a name="wp1003878"> </a>
If a caller of <code class="cCode">tpenqueue()</code> is not in transaction mode or if <code class="cCode">TPNOTRAN</code> is set, the message is enqueued outside of the caller&#8217;s transaction. If the call to <code class="cCode">tpenqueue()</code> returns success, the message is guaranteed to be on the queue. If the call to <code class="cCode">tpenqueue()</code> fails with a communication error or with a timeout, the caller is left in doubt about whether the failure occurred before or after the message was enqueued.
</p>
<p class="pBody"><a name="wp1003883"> </a>
Note that specifying <code class="cCode">TPNOTRAN</code> while the caller is not in transaction mode has no meaning.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1003884"> </a>
Dequeuing Messages
</h2><p class="pBody"><a name="wp1003885"> </a>
The syntax for <code class="cCode">tpdequeue()</code> is as follows:
</p>
<a name="wp1003886"> </a><div class="pPreformatted"><pre>#include &lt;atmi.h&gt;<br />int tpdequeue(char *qspace, char *qname, TPQCTL *ctl, \<br />        char **data, long *len, long flags)</pre></div><p class="pBody"><a name="wp1003889"> </a>
When this call is issued it tells the system to dequeue a message from the <code class="cCodeEmphasis">qname</code> queue in the queue space named <code class="cCodeEmphasis">qspace</code>. The message is placed in a buffer (originally allocated by <a href="../rf3c/rf3c.html">tpalloc(3c)</a>) at the address pointed to by *<code class="cCodeEmphasis">data</code>. <code class="cCodeEmphasis">len</code> points to the length of the data. If <code class="cCodeEmphasis">len</code> is 0 on return from <code class="cCode">tpdequeue()</code>, the message had no data portion. By the use of bit settings in <code class="cCodeEmphasis">flags</code>, the system is informed how the call to <code class="cCode">tpdequeue()</code> is to be handled. The <code class="cCode">TPQCTL</code> structure pointed to by <code class="cCodeEmphasis">ctl</code> carries further information about how the call should be handled.
</p>
<h3 class="pHeading2"><a name="wp1003895"> </a>
tpdequeue(3c) Arguments
</h3>
<p class="pBody"><a name="wp1003896"> </a>
There are some important arguments to control the operation of <a href="../rf3c/rf3c.html">tpdequeue(3c)</a>. Let&#39;s look at some of them.
</p>
<h4 class="pHeading3"><a name="wp1003898"> </a>
tpdequeue(): The qspace Argument
</h4>
<p class="pBody"><a name="wp1003899"> </a>
<code class="cCodeEmphasis">qspace</code> identifies a queue space previously created by the administrator. When the <code class="cCode">TMQUEUE</code> server is defined in the <code class="cCode">SERVERS</code> section of the configuration file, the service names it offers are aliases for the actual queue space name (which is specified as part of the <code class="cCode">OPENINFO</code> parameter in the <code class="cCode">GROUPS</code> section). For example, when your application uses the server <code class="cCode">TMQUEUE</code>, the value pointed at by the <code class="cCodeEmphasis">qspace</code> argument is the name of a service advertised by <code class="cCode">TMQUEUE</code>. If no service aliases are defined, the default service is the same as the server name, <code class="cCode">TMQUEUE</code>. In this case the configuration file may include: 
</p>
<a name="wp1003906"> </a><div class="pPreformatted"><pre>TMQUEUE<br />        SRVGRP = QUE1  SRVID = 1<br />        GRACE = 0  RESTART = Y CONV = N<br />        CLOPT = &quot;-A&quot;<br />or<br />        CLOPT = &quot;-s TMQUEUE&quot;</pre></div><p class="pBody"><a name="wp1003912"> </a>
The entry for server group <code class="cCode">QUE1</code> has an <code class="cCode">OPENINFO</code> parameter that specifies the resource manager, the pathname of the device and the queue space name. The <code class="cCodeEmphasis">qspace</code> argument in a client program then looks like this: 
</p>
<a name="wp1003915"> </a><div class="pPreformatted"><pre>if (tpdequeue(&quot;TMQUEUE&quot;, &quot;REPLYQ&quot;, (TPQCTL *)&amp;qctl,<br />        (char **)&amp;reqstr, &amp;len,TPNOTIME) == -1) {<br />        Error checking<br />}</pre></div><p class="pBody"><a name="wp1003919"> </a>
The example shown on the <a href="../rf5/rf5.html">TMQUEUE(5)</a> reference page shows how alias service names can be included when the server is built and specified in the configuration file. The sample program in <a href="qsimp.html">A Sample Application</a>, also specifies an alias service/queue space name.
</p>
<h4 class="pHeading3"><a name="wp1004529"> </a>
tpdequeue(): The qname Argument
</h4>
<p class="pBody"><a name="wp1003923"> </a>
Queue names in a queue space must be agreed upon by the applications that will access the queue space. This is especially important for reply queues. If <code class="cCode">qname</code> refers to a reply queue, the administrator creates it (and often an error queue) in the same manner that he or she creates any other queue. <code class="cCodeEmphasis">qname</code> is a pointer to the name of the queue from which to retrieve the message or reply.
</p>
<h4 class="pHeading3"><a name="wp1003926"> </a>
tpdequeue(): The data and len Arguments
</h4>
<p class="pBody"><a name="wp1003927"> </a>
These arguments have slightly different meanings than their counterparts in <code class="cCode">tpenqueue()</code>. *<code class="cCodeEmphasis">data</code> points to the address of a buffer where the system is to place the message being dequeued. When <code class="cCode">tpdequeue()</code> is called, it is an error for its value to be NULL.
</p>
<p class="pBody"><a name="wp1003930"> </a>
When <code class="cCode">tpdequeue()</code> returns, <code class="cCodeEmphasis">len</code> points to a value of type <code class="cCode">long</code> that carries information about the length of the data retrieved. If it is 0, it means that the reply had no data portion. This can be a legitimate and successful reply in some applications; receiving even a 0 length reply can be used to show successful processing of the enqueued request. If you wish to know whether the buffer has changed from before the call to <code class="cCode">tpdequeue()</code>, save the length prior to the call to <code class="cCode">tpdequeue()</code> and compare it to <code class="cCodeEmphasis">len</code> after the call completes.
</p>
<h4 class="pHeading3"><a name="wp1003935"> </a>
tpdequeue(): The flags Arguments
</h4>
<p class="pBody"><a name="wp1003936"> </a>
<code class="cCodeEmphasis">flags</code> values are used to tell the Oracle Tuxedo system how the <code class="cCode">tpdequeue()</code> call is handled; the following are valid flags: 
</p>
<h4 class="pDefTerm"><a name="wp1003938"> </a>
<code class="cCode">TPNOTRAN</code> 
</h4><div class="pDefPara"><a name="wp1014382"> </a>
If the caller is in transaction mode and this flag is set, the message is not dequeued within the caller&#8217;s transaction. A caller in transaction mode that sets this flag is still subject to the transaction timeout (and no other) when dequeuing the message. If message dequeuing fails, the caller&#8217;s transaction is not affected.
</div>
<h4 class="pDefTerm"><a name="wp1003941"> </a>
<code class="cCode">TPNOBLOCK</code> 
</h4><div class="pDefPara"><a name="wp1014390"> </a>
The message is not dequeued if a blocking condition exists. If this flag is set and a blocking condition exists such as the internal buffers into which the message is transferred are full, the call fails and <a href="../rf5/rf5.html">tperrno(5)</a> is set to <code class="cCode">TPEBLOCK</code>. If this flag is set and a blocking condition exists because the target queue is opened <em class="cEmphasis">exclusively</em> by another application, the call fails, <code class="cCode">tperrno()</code> is set to <code class="cCode">TPEDIAGNOSTIC</code>, and the diagnostic field of the <code class="cCode">TPQCTL</code> structure is set to <code class="cCode">QMESHARE</code>. In the latter case, the other application, which is based on an Oracle product other than the Oracle Tuxedo system, opened the queue for exclusive read and/or write using the Queuing Services API (QSAPI).
</div>
<div class="pDefParaCont"><a name="wp1014391"> </a>
When <code class="cCode">TPNOBLOCK</code> is not set and a blocking condition exists, the caller blocks until the condition subsides or a timeout occurs (either transaction or blocking timeout). This blocking condition does not include blocking on the queue itself if the <code class="cCode">TPQWAIT</code> option in <code class="cCodeEmphasis">flags</code> (of the <code class="cCode">TPQCTL</code> structure) is specified.
</div>
<h4 class="pDefTerm"><a name="wp1014392"> </a>
<code class="cCode">TPNOTIME</code> 
</h4><div class="pDefPara"><a name="wp1014393"> </a>
Setting this flag signifies that the caller is willing to block indefinitely and wants to be immune to blocking timeouts. Transaction timeouts may still occur.
</div>
<h4 class="pDefTerm"><a name="wp1003949"> </a>
<code class="cCode">TPNOCHANGE</code> 
</h4><div class="pDefPara"><a name="wp1003950"> </a>
When this flag is set, the type of the buffer pointed to by *<code class="cCodeEmphasis">data</code> is not allowed to change. By default, if a buffer is received that differs in type from the buffer pointed to by *<code class="cCodeEmphasis">data</code>, then *<code class="cCodeEmphasis">data</code>&#39;s buffer type changes to the received buffer&#39;s type so long as the receiver recognizes the incoming buffer type. That is, the type and subtype of the received buffer must match the type and subtype of the buffer pointed to by *<code class="cCodeEmphasis">data</code>.
</div>
<h4 class="pDefTerm"><a name="wp1003955"> </a>
<code class="cCode">TPSIGRSTRT</code> 
</h4><div class="pDefPara"><a name="wp1003956"> </a>
Setting this flag indicates that any underlying system calls that are interrupted by a signal should be reissued. When this flag is not set and a signal interrupts a system call, the call fails and sets <a href="../rf5/rf5.html">tperrno(5)</a> to <code class="cCode">TPGOTSIG</code>.
</div>
<h3 class="pHeading2"><a name="wp1008799"> </a>
TPQCTL Structure
</h3>
<p class="pBody"><a name="wp1008797"> </a>
The third argument to <code class="cCode">tpdequeue()</code> is a pointer to a structure of type <code class="cCode">TPQCTL</code>. The <code class="cCode">TPQCTL</code> structure has members that are used by the application and by the Oracle Tuxedo system to pass parameters in both directions between application programs and the queued message facility. The client that calls <code class="cCode">tpdequeue()</code> sets flags to mark fields for which the system should supply values. As described earlier, the structure is also used by <code class="cCode">tpenqueue()</code>; some of the members apply only to that function. The entire structure is shown in <a href="qpgm.html#wp1003707">The tpqctl_t Structure</a>.
</p>
<p class="pBody"><a name="wp1003965"> </a>
As input to <code class="cCode">tpdequeue()</code>, the following fields may be set in the <code class="cCode">TPQCTL</code> structure:
</p>
<a name="wp1005714"> </a><div class="pPreformatted"><pre>long flags;       /* indicates which of the values are set */<br />char msgid[32];   /* id of message to dequeue */<br />char corrid[32];  /* correlation identifier of message to dequeue */</pre></div><p class="pBody"><a name="wp1005715"> </a>
The following are valid flags on input to <code class="cCode">tpdequeue()</code>:
</p>
<h4 class="pDefTerm"><a name="wp1003972"> </a>
<code class="cCode">TPNOFLAGS</code> 
</h4><div class="pDefPara"><a name="wp1003973"> </a>
No flags are set. No information is taken from the control structure. 
</div>
<h4 class="pDefTerm"><a name="wp1003974"> </a>
<code class="cCode">TPQGETBYMSGID</code> 
</h4><div class="pDefPara"><a name="wp1003975"> </a>
Setting this flag requests that the message with the message identifier specified by <code class="cCodeEmphasis">ctl-&gt;msgid</code> be dequeued. The message identifier is determined through a prior call to <code class="cCode">tpenqueue()</code>. Note that the message identifier changes if the message is moved from one queue to another. Note also that the entire 32 bytes of the message identifier value are significant, so the value specified by <code class="cCodeEmphasis">ctl-&gt;msgid</code> must be completely initialized (for example, padded with null characters).
</div>
<h4 class="pDefTerm"><a name="wp1003978"> </a>
<code class="cCode">TPQGETBYCORRID</code> 
</h4><div class="pDefPara"><a name="wp1003979"> </a>
Setting this flag requests that the message with the correlation identifier specified by <code class="cCodeEmphasis">ctl-&gt;corrid</code> be dequeued. The correlation identifier is specified by the application when enqueuing the message with <code class="cCode">tpenqueue()</code>. Note that the entire 32 bytes of the correlation identifier value are significant, so the value specified by <code class="cCodeEmphasis">ctl-&gt;corrid</code> must be completely initialized (for example, padded with null characters).
</div>
<h4 class="pDefTerm"><a name="wp1003983"> </a>
<code class="cCode">TPQWAIT</code> 
</h4><div class="pDefPara"><a name="wp1003984"> </a>
Setting this flag indicates that an error should not be returned if the queue is empty. Instead, the process should wait until a message is available. If <code class="cCode">TPQWAIT</code> is set in conjunction with <code class="cCode">TPQGETBYMSGID</code> or <code class="cCode">TPQGETBYCORRID</code>, it indicates that an error should not be returned if no message with the specified message identifier or correlation identifier is present in the queue. Instead, the process should wait until a message meeting the criteria is available. The process is still subject to the caller&#8217;s transaction timeout, or, when not in transaction mode, the process is still subject to the timeout specified for the <code class="cCode">TMQUEUE</code> process by the<code class="cCode"> -t</code> option.
</div>
<div class="pDefParaCont"><a name="wp1014565"> </a>
If a message matching the desired criteria is not immediately available and the configured action resources are exhausted, <code class="cCode">tpdequeue()</code> returns -1, <code class="cCode">tperrno()</code> is set to <code class="cCode">TPEDIAGNOSTIC</code>, and the diagnostic field of the <code class="cCode">TPQCTL</code> structure is set to <code class="cCode">QMESYSTEM</code>.
<a name="wp1015567"> </a>
Note that each <code class="cCode">tpdequeue()</code> request specifying the <code class="cCode">TPQWAIT</code> control parameter requires that a queue manager (<code class="cCode">TMQUEUE</code>) action object be available if a message satisfying the condition is not immediately available. If an action object is not available, the <code class="cCode">tpdequeue()</code> request fails. The number of available queue manager actions are specified when a queue space is created or modified. When a waiting dequeue request completes, the associated action object associated is made available for another request.
</div>
<h4 class="pDefTerm"><a name="wp1007468"> </a>
<code class="cCode">TPQPEEK</code>
</h4><div class="pDefPara"><a name="wp1007469"> </a>
If this flag is set, the specified message is read but is not removed from the queue. The <code class="cCode">TPNOTRAN</code> flag must also be set.
</div>
<div class="pDefParaCont"><a name="wp1015993"> </a>
When a thread is non-destructively dequeuing a message using <code class="cCode">TPQPEEK</code>, the message may not be seen by other non-blocking dequeuers for the brief time the system is processing the non-destructive dequeue request. This includes dequeuers using specific selection criteria (such as message identifier and correlation identifier) that are looking for the message currently being non-destructively dequeued.
</div>
<p class="pBody"><a name="wp1015995"> </a>
The following is a list of valid bits for the <code class="cCodeEmphasis">flags</code> parameter controlling output information from <code class="cCode">tpdequeue()</code>. For any of these bits, if the flag bit is turned on when <code class="cCode">tpdequeue()</code> is called, the associated field in the structure (see <a href="qpgm.html#wp1003707">The tpqctl_t Structure</a>) is populated with the value provided when the message was queued, and the bit remains set. If a value is not available (that is, no value was provided when the message was queued) or the bit is not set when <code class="cCode">tpdequeue()</code> is called, <code class="cCode">tpdequeue()</code> completes with the flag turned off.
</p>
<h4 class="pDefTerm"><a name="wp1015635"> </a>
<code class="cCode">TPQPRIORITY</code> 
</h4><div class="pDefPara"><a name="wp1015636"> </a>
If this flag is set, the call to <code class="cCode">tpdequeue()</code> is successful, and the message was queued with an explicit priority, then the priority is stored in <code class="cCodeEmphasis">ctl-&gt;priority</code>. The priority is in the range 1 to 100, inclusive, and the higher the number, the higher the priority (that is, a message with a higher number is dequeued before a message with a lower number). For queues not ordered by priority, the value is informational.
</div>
<div class="pDefParaCont"><a name="wp1015637"> </a>
If no priority was explicitly specified when the message was queued and the call to <code class="cCode">tpdequeue()</code> is successful, the priority for the message is 50.
</div>
<h4 class="pDefTerm"><a name="wp1015638"> </a>
<code class="cCode">TPQMSGID</code> 
</h4><div class="pDefPara"><a name="wp1015639"> </a>
If this flag is set and the call to <code class="cCode">tpdequeue()</code> is successful, the message identifier is stored in <code class="cCodeEmphasis">ctl-&gt;msgid</code>. The entire 32 bytes of the message identifier value are significant.
</div>
<h4 class="pDefTerm"><a name="wp1015640"> </a>
<code class="cCode">TPQCORRID</code> 
</h4><div class="pDefPara"><a name="wp1015641"> </a>
If this flag is set, the call to <code class="cCode">tpdequeue()</code> is successful, and the message was queued with a correlation identifier, then the correlation identifier is stored in <code class="cCodeEmphasis">ctl-&gt;corrid</code>. The entire 32 bytes of the correlation identifier value are significant. Any Oracle Tuxedo /Q provided reply to a message has the correlation identifier of the original request message.
</div>
<h4 class="pDefTerm"><a name="wp1015642"> </a>
<code class="cCode">TPQDELIVERYQOS</code>
</h4><div class="pDefPara"><a name="wp1015643"> </a>
If this flag is set, the call to <code class="cCode">tpdequeue()</code> is successful, and the message was queued with a delivery quality of service, then the flag&#8212;<code class="cCode">TPQQOSDEFAULTPERSIST</code>, <code class="cCode">TPQQOSPERSISTENT</code>, or <code class="cCode">TPQQOSNONPERSISTENT</code>&#8212;is stored in <code class="cCodeEmphasis">ctl-&gt;delivery_qos</code>. If no delivery quality of service was explicitly specified when the message was queued, the default delivery policy of the target queue dictates the delivery quality of service for the message.
</div>
<h4 class="pDefTerm"><a name="wp1015644"> </a>
<code class="cCode">TPQREPLYQOS</code>
</h4><div class="pDefPara"><a name="wp1015645"> </a>
If this flag is set, the call to <code class="cCode">tpdequeue()</code> is successful, and the message was queued with a reply quality of service, then the flag&#8212;<code class="cCode">TPQQOSDEFAULTPERSIST</code>, <code class="cCode">TPQQOSPERSISTENT</code>, or <code class="cCode">TPQQOSNONPERSISTENT</code>&#8212;is stored in <code class="cCodeEmphasis">ctl-&gt;reply_qos</code>. If no reply quality of service was explicitly specified when the message was queued, the default delivery policy of the <code class="cCodeEmphasis">ctl-&gt;replyqueue</code> queue dictates the delivery quality of service for any reply.
</div>
<div class="pDefParaCont"><a name="wp1015646"> </a>
Note that the default delivery policy is determined when the reply to a message is enqueued. That is, if the default delivery policy of the reply queue is modified between the time that the original message is enqueued and the reply to the message is enqueued, the policy used is the one in effect when the reply is finally enqueued.
</div>
<h4 class="pDefTerm"><a name="wp1015647"> </a>
<code class="cCode">TPQREPLYQ</code> 
</h4><div class="pDefPara"><a name="wp1015648"> </a>
If this flag is set, the call to <code class="cCode">tpdequeue()</code> is successful, and the message was queued with a reply queue, then the name of the reply queue is stored in <code class="cCodeEmphasis">ctl-&gt;replyqueue</code>. Any reply to the message should go to the named reply queue within the same queue space as the request message.
</div>
<h4 class="pDefTerm"><a name="wp1015649"> </a>
<code class="cCode">TPQFAILUREQ</code> 
</h4><div class="pDefPara"><a name="wp1016036"> </a>
If this flag is set, the call to <code class="cCode">tpdequeue()</code> is successful, and the message was queued with a failure queue, then the name of the failure queue is stored in <code class="cCodeEmphasis">ctl-&gt;failurequeue</code>. Any failure message should go to the named failure queue within the same queue space as the request message.
</div>
<p class="pBody"><a name="wp1016037"> </a>
The following remaining bits for the <code class="cCodeEmphasis">flags</code> parameter are cleared (set to zero) when <code class="cCode">tpdequeue()</code> is called: <code class="cCode">TPQTOP</code>, <code class="cCode">TPQBEFOREMSGID</code>, <code class="cCode">TPQTIME_ABS</code>, <code class="cCode">TPQTIME_REL</code>, <code class="cCode">TPQEXPTIME_ABS</code>, <code class="cCode">TPQEXPTIME_REL</code>, and <code class="cCode">TPQEXPTIME_NONE</code>. These bits are valid bits for the <code class="cCodeEmphasis">flags</code> parameter controlling input information for <code class="cCode">tpenqueue()</code>.
</p>
<p class="pBody"><a name="wp1007070"> </a>
If the call to <code class="cCode">tpdequeue()</code> failed and <a href="../rf5/rf5.html">tperrno(5)</a> is set to <code class="cCode">TPEDIAGNOSTIC</code>, a value indicating the reason for failure is returned in <code class="cCodeEmphasis">ctl-&gt;diagnostic</code>. The valid codes for <code class="cCodeEmphasis">ctl-&gt;diagnostic</code> include those for <code class="cCode">tpenqueue()</code> described in <a href="qpgm.html#wp1003700">TPQCTL Structure</a> (except for <code class="cCode">QMENOSPACE</code> and <code class="cCode">QMERELEASE</code>) and the following additional codes.
</p>
<h4 class="pDefTerm"><a name="wp1004011"> </a>
[<code class="cCode">QMENOMSG</code>] 
</h4><div class="pDefPara"><a name="wp1004012"> </a>
No message was available for dequeuing. Note that it is possible that the message exists on the queue and another application process has read the message from the queue. In this case, the message may be put back on the queue if that other process rolls back the transaction.
</div>
<h4 class="pDefTerm"><a name="wp1004013"> </a>
[<code class="cCode">QMEINUSE</code>] 
</h4><div class="pDefPara"><a name="wp1014665"> </a>
When dequeuing a message by message identifier or correlation identifier, the specified message is in use by another transaction. Otherwise, all messages currently on the queue are in use by other transactions. This diagnostic is not returned by queue managers from Oracle Tuxedo release 7.1 or later.
</div>
<h3 class="pHeading2"><a name="wp1009337"> </a>
Using TPQWAIT
</h3>
<p class="pBody"><a name="wp1009751"> </a>
When <code class="cCode">tpdequeue()</code> is called with <code class="cCodeEmphasis">flags</code> (of the <code class="cCode">TPQCTL</code> structure) set to include <code class="cCode">TPQWAIT</code>, if a message is not immediately available, the <code class="cCode">TMQUEUE</code> server waits for the arrival, on the queue, of a message that matches the <code class="cCode">tpdequeue()</code> request before <code class="cCode">tpdequeue()</code> returns control to the caller. The <code class="cCode">TMQUEUE</code> process sets the waiting request aside and processes requests from other processes while waiting to satisfy the first request. If <code class="cCode">TPQGETBYMSGID</code> and/or <code class="cCode">TPQGETBYCORRID</code> are also specified, the server waits until a message with the indicated message identifier and/or correlation identifier becomes available on the queue. If neither of these flags is set, the server waits until any message is put onto the queue. The amount of time it waits is controlled by the caller&#8217;s transaction timeout, if the call is in transaction mode, or by the <code class="cCode">-t</code> option in the <code class="cCode">CLOPT</code> parameter of the <code class="cCode">TMQUEUE</code> server, if the call is not in transaction mode.
</p>
<p class="pBody"><a name="wp1009339"> </a>
The <code class="cCode">TMQUEUE</code> server can handle a number of waiting <code class="cCode">tpdequeue()</code> requests at the same time, as long as action resources are available to handle the request. If there are not enough action resources configured for the queue space, <code class="cCode">tpdequeue()</code> fails. If this happens on your system, increase the number of action resources for the queue space.
</p>
<h3 class="pHeading2"><a name="wp1009434"> </a>
Error Handling When Using TMQFORWARD Services
</h3>
<p class="pBody"><a name="wp1004027"> </a>
In considering how best to handle errors when dequeuing it is helpful to differentiate between two types of errors: 
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1007161"> </a>Errors encountered by <a href="../rf5/rf5.html">TMQFORWARD(5)</a> as it attempts to dequeue a message to forward to the requested service</li>
<li><a name="wp1007162"> </a>Errors that occur in the service that processes the request</li>
</ul></div>
<p class="pBody"><a name="wp1004031"> </a>
By default, if a message is dequeued within a transaction and the transaction is rolled back, then (if the <code class="cCode">retry</code> parameter is greater than 0) the message ends up back on the queue and can be dequeued and executed again. It may be desirable to delay for a short period before retrying to dequeue and execute the message, allowing the transient problem to clear (for example, allowing for locks in a database to be released by another transaction). Normally, a limit on the number of retries is also useful to ensure that an application flaw doesn&#39;t cause significant waste of resources. When a queue is configured by the administrator, both a retry count and a delay period (in seconds) can be specified. A retry count of 0 implies that no retries are done. After the retry count is reached, the message is moved to an error queue that is configured by the administrator for the queue space. If the error queue is not configured, then messages that have reached the retry count are simply deleted. Messages on the error queue must be handled by the administrator who must work out a way of notifying the originator that meets the requirements of the application. The message handling method chosen should be mostly transparent to the originating program that put the message on the queue. There is a virtual guarantee that once a message is successfully enqueued it will be processed according to the parameters of <code class="cCode">tpenqueue()</code> and the attributes of the queue. Notification that a message has been moved to the error queue should be a rare occurrence in a system that has properly tuned its queue parameters. 
</p>
<p class="pBody"><a name="wp1004048"> </a>
A failure queue (normally, different from the queue space error queue) may be associated with each queued message. This queue is specified on the enqueuing call as the place to put any failure messages. The failure message for a particular request can be identified by an application-generated correlation identifier that is associated with the message when it is enqueued. 
</p>
<p class="pBody"><a name="wp1006240"> </a>
The default behavior of retrying until success (or a predefined limit) is quite appropriate when the failure is caused by a transient problem that is later resolved, allowing the message to be handled appropriately. 
</p>
<p class="pBody"><a name="wp1004055"> </a>
There are cases where the problem is not transient. For example, the queued message may request operating on an account that does not exist (and the application is such that it won&#39;t come into existence within a reasonable time period if at all). In this case, it is desirable not to waste any resources by trying again. If the application programmer or administrator determines that failures for a particular operation are never transient, then it is simply a matter of setting the retry count to zero, although this will require a mechanism to constantly clear the queue space error queue of these messages (for example, a background client that reads the queue periodically). More likely, it is the case that some problems will be transient (for example, database lock contention) and some problems will be permanent (for example, the account doesn&#39;t exist) for the same service. 
</p>
<p class="pBody"><a name="wp1004064"> </a>
In the case that the message is processed (dequeued and passed to the application via a <code class="cCode">tpcall()</code>) by <code class="cCode">TMQFORWARD</code>, there is no mechanism in the information returned by <code class="cCode">tpcall()</code> to indicate whether a <code class="cCode">TPESVCFAIL</code> error is caused by a transient or permanent problem. 
</p>
<p class="pBody"><a name="wp1004708"> </a>
As in the case where the application is handling the dequeuing, a simple solution is to return success for the service, that is, <code class="cCode">tpreturn</code> with <code class="cCode">TPSUCCESS</code>, even though the operation failed. This allows the transaction to be committed and the message removed from the queue. If reply messages are being used, the information in the buffer returned from the service can indicate that the operation failed and the message will be enqueued on the reply queue. The <code class="cCodeEmphasis">rcode</code> argument of <code class="cCode">tpreturn</code> can also be used to return application specific information. 
</p>
<p class="pBody"><a name="wp1004073"> </a>
In the case where the service fails and the transaction must be rolled back, it is not clear whether or not <code class="cCode">TMQFORWARD</code> should execute a second transaction to remove the message from the queue without further processing. By default, <code class="cCode">TMQFORWARD</code> will not delete a message for a service that fails. <code class="cCode">TMQFORWARD&#39;s</code> transaction is rolled back and the message is restored to the queue. A command-line option may be specified for <code class="cCode">TMQFORWARD</code> that indicates that a message should be deleted from the queue if the service fails and a reply message is sent back with length greater than 0. The message is deleted in a second transaction. The queue must be configured with a delay time and retry count for this to work. If the message is associated with a failure queue, the reply data will be enqueued to the failure queue in the same transaction as the one in which the message is deleted from the queue.
</p>
<h3 class="pHeading2"><a name="wp1004083"> </a>
Procedure for Dequeuing Replies from Services Invoked Through TMQFORWARD
</h3>
<p class="pBody"><a name="wp1004084"> </a>
If your application expects to receive replies to queued messages, the following is a procedure you may want to follow:
</p>
<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1004087"> </a>As a preliminary step, the queue space must include a reply queue and a failure queue. The application must also agree on the content of the correlation identifier. The service should be coded to return <code class="cCode">TPSUCCESS</code> on a logical failure and return an explanatory code in the <code class="cCodeEmphasis">rcode</code> argument of <code class="cCode">tpreturn</code>. </li>
<li><a name="wp1005398"> </a>When you call <code class="cCode">tpenqueue()</code> to put the message on the queue, set <code class="cCode">flags</code> to turn on the bits for the following flags: </li>
<a name="wp1004094"> </a><div class="pPreformattedRelative"><pre><code class="cCode">TPQCORRID     TPQREPLYQ<br />TPQFAILUREQ   TPQMSGID</code></pre></div><p class="pBodyRelative"><a name="wp1004096"> </a>
Fill in the values for <code class="cCode">corrid</code>, <code class="cCode">replyqueue</code> and <code class="cCode">failurequeue</code> before issuing the call. On return from the call, save <code class="cCode">corrid</code>.
</p>
<li><a name="wp1004099"> </a>When you call <code class="cCode">tpdequeue()</code> to check for a reply, specify the reply queue in the <code class="cCodeEmphasis">qname</code> argument and set <code class="cCode">flags</code> to turn on the bits for the following flags: </li>
<a name="wp1004101"> </a><div class="pPreformattedRelative"><pre><code class="cCode">TPQCORRID       TPQREPLYQ<br />TPQFAILUREQ     TPQMSGID<br />TPQGETCORRID</code></pre></div><p class="pBodyRelative"><a name="wp1004104"> </a>
Use the saved correlation identifier to populate <code class="cCode">corrid</code> before issuing the call. If the call to <code class="cCode">tpdequeue()</code> fails and sets <a href="../rf5/rf5.html">tperrno(5)</a> to <code class="cCode">TPEDIAGNOSTIC</code>, then further information is available in <code class="cCode">diagnostic</code>. If you receive the error code <code class="cCode">QMENOMSG</code>, it means that no message was available for dequeuing.
</p>
<li><a name="wp1004109"> </a>Set up another call to <code class="cCode">tpdequeue()</code>. This time have <code class="cCodeEmphasis">qname</code> point to the name of the failure queue and set <code class="cCode">flags</code> to turn on the bits for the following flags: </li>
<a name="wp1004111"> </a><div class="pPreformattedRelative"><pre><code class="cCode">TPQCORRID       TPQREPLYQ<br />TPQFAILUREQ     TPQMSGID<br />TPQGETBYCORRID</code></pre></div><p class="pBodyRelative"><a name="wp1004114"> </a>
Populate <code class="cCode">corrid</code> with the correlation identifier. When the call returns, check <code class="cCodeEmphasis">len</code> to see if data has been received and check <code class="cCode">urcode</code> to see if the service has returned a user return code.
</p>
</ol></div>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1004117"> </a>
Sequential Processing of Messages
</h2><p class="pBody"><a name="wp1004118"> </a>
Sequential processing of messages can be achieved by having one service enqueue a message for the next service in the chain before its transaction is committed. The originating process can track the progress of the sequence with a series of <code class="cCode">tpdequeue()</code> calls to the <code class="cCode">reply_queue</code>, if each member uses the same correlation-ID and returns a 0 length reply.
</p>
<p class="pBody"><a name="wp1004122"> </a>
Alternatively, word of the successful completion of the entire sequence can be returned to the originator by using unsolicited notification. To make sure that the last transaction in the sequence ended with a <code class="cCode">tpcommit</code>, a job step can be added that calls <code class="cCode">tpnotify</code> using the client identifier that is carried in the <code class="cCode">TPQCTL</code> structure returned from <code class="cCode">tpdequeue()</code> or in the <code class="cCode">TPSVCINFO</code> structure passed to the service. The originating client must have called <code class="cCode">tpsetunsol</code> to name the unsolicited message handler being used.
</p>
<h3 class="pHeading2"><a name="wp1004128"> </a>
Using Queues for Peer-to-Peer Communication
</h3>
<p class="pBody"><a name="wp1004129"> </a>
In all of the foregoing discussion of enqueuing and dequeuing messages there has been an implicit assumption that queues were being used as an alternative form of request/response processing. A message does not have to be a service request. The queued message facility can transfer data from one process to another as effectively as a service request. This style of communication between applications or clients is called peer-to-peer communication.
</p>
<p class="pBody"><a name="wp1006241"> </a>
If it suits your application to use Oracle Tuxedo /Q for this purpose, have the administrator create a separate queue and code your own receiving program for dequeuing <em class="cEmphasis">messages</em> from that queue.
</p>
 
<br/>
    <table id="SummaryNotReq2" width="100%" border="0" cellpadding="0" cellspacing="0">
      <tr> 
        <td>
&nbsp;
<a href="qpgm.html"><img id="LongDescNotReq7" src="/global_resources/images/backtop.gif" width="90" height="25" alt="Back to Top" title="Back to Top" border="0" /></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a accesskey="4" href="qadm.html"><img id="LongDescNotReq8" src="/global_resources/images/prevtop.gif" border="0" alt="Previous" /></a>&nbsp;
<a accesskey="5" href="qcblpgm.html"><img id="LongDescNotReq9" src="/global_resources/images/nexttop.gif" border="0" alt="Next" /></a>
<script language="Javascript1.1" type="text/javascript">
Copyright();
</script>
<noscript><a href="http://edocs.bea.com/copyright.html">&copy; BEA Systems</a></noscript>
        </td>
      </tr>
    </table>

<!-- WebAnalytics BEGIN -->

<!--#include virtual="/global_resources/edocs_wt.html"-->
      
<!-- WebAnalytics END -->

  </body>
</html>
