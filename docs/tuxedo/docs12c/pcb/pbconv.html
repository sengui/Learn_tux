<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>

<!-- LOCALIZATION RELATED INFORMATION -->
<meta name="LOC_PROJ_ID" content="WLPF8.1" />
<meta name="LOC_OWNER" content="BEAJ" />
<meta name="LOC_STATUS" content="READY!" />
<meta name="LOC_COMMENT" content="LOC_COMMENT" />
<meta name="LOC_US_REV" content="1" />
<meta name="LOC_US_CHANGE" content="41263" />
<meta name="LOC_US_SRCFILE" content="//depot/tuxedo/tux11gr1/pcb/fm/pbconv.fm" />
<!-- LOCALIZATION RELATED INFORMATION -->

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta name="GENERATOR" content="Quadralay WebWorks AutoMap 2003 Platinum Edition for FrameMaker 8.6.6577.0" />
    <meta name="TEMPLATEBASE" content="BEA_WFP_Template_V1.04" />
    <meta name="LASTUPDATED" content="11/28/11 08:23:25" />
    <link rel="StyleSheet" href="/global_resources/edocs.css" type="text/css" media="all" />

<title>Writing Conversational Clients and Servers</title>

<!-- BEA scripts begin -->

<script language="Javascript" src="/global_resources/js/banner.js" type="text/javascript"></script>
<!-- This script outputs the banner required for edocs documentation. -->

<script language="Javascript" src="floatwin.js" type="text/javascript"></script>
<!-- This script opens a new small floating window and puts TOC<i>&lt;name&gt;</i>.html and IX<i>&lt;name&gt;</i>.html files in it and sets a generic popup window code to enable the display of some viewlets in the WebLogic Platform Tour. -->

<script language="Javascript1.1" src="/global_resources/js/footer.js" type="text/javascript"></script>
<!-- This script outputs the footer with the correct copyright date and link to copyright page.-->

<script language="Javascript1.1" src="/global_resources/js/googlesearch4.js" type="text/javascript"></script>
<!-- This script outputs the google search form. -->

<script language="Javascript1.1" src="/global_resources/js/note.js" type="text/javascript"></script>
<!-- This script outputs a note such as a BETA note. -->

<script language="JavaScript1.1" src="/global_resources/js/search.js" type="text/javascript"></script>
<!-- This script is not for online documents. It is only used by the QuestAgent Java Applet for CD search indexes. -->

<!-- BEA scripts end -->

  </head>

  <body>


<script language="Javascript1.1" type="text/javascript">
GoogleURL();
</script><noscript>This script outputs the google search URL required for search on edocs documentation.</noscript>

<script language="Javascript1.1" type="text/javascript">
Banner();
</script><noscript>This script outputs the banner required for edocs documentation.</noscript>

<script language="Javascript1.1" type="text/javascript">
GoogleSearchCollection();
</script><noscript>This script outputs the google search parameters required for search on edocs documentation.</noscript>

<!-- page title -->
<h1 class="booktitle">Programming an Oracle Tuxedo Application Using COBOL
</h1>
<!-- page title end -->

    <table id="SummaryNotReq1" width="100%" border="0" align="left" cellpadding="2%" cellspacing="0">
      <tr> 
        <td>
&nbsp;&nbsp;&nbsp;&nbsp;
<a accesskey="4" href="pbreq.html"><img id="LongDescNotReq1" src="/global_resources/images/doc_nav_prev.gif" border="0" alt="Previous" /></a>&nbsp;
<a accesskey="5" href="pbevb.html"><img id="LongDescNotReq2" src="/global_resources/images/doc_nav_next.gif" border="0" alt="Next" /></a>&nbsp;
<img id="LongDescNotReq3" src="/global_resources/images/doc_nav_dots.gif" border="0" alt="" />&nbsp;
<a accesskey="1" href="javascript:OpenWindowToc();" onmouseover="window.status='Table of Contents'; return true" onfocus="window.status='Table of Contents'; return true" onmouseout="window.status=''; return true" onblur="window.status=''; return true" title="Open TOC in new window">      <img id="LongDescNotReq4" src="/global_resources/images/doc_nav_contents.gif" alt="Open TOC in new window" border="0" /></a>&nbsp;
&nbsp;
<a href="../pdf/pcb.pdf" target="pdf"><img id="LongDescNotReq5" src="/global_resources/images/doc_nav_pdf.gif" width="59" height="44" alt="View as PDF - New Window" title="View as PDF - New Window" border="0" /></a>&nbsp;
<a href="http://www.adobe.com/products/acrobat/alternate.html" target="_blank"><img id="LongDescNotReq6" src="/global_resources/images/get_reader.gif" width="52" height="44" alt="Get Adobe Reader - New Window" title="Get Adobe Reader - New Window" border="0" /></a>
<a name="link_group_0"></a>
	</td>
      </tr>
    </table>

<a name="skipnav" title="Content starts here"><img src="/global_resources/images/_.gif" alt="Content starts here" border="0" height="1" width="1" /></a>



<h1 class="pChapHead"><a name="wp1127433"> </a>
Writing Conversational Clients and Servers
</h1>
<p class="pBody"><a name="wp1114252"> </a>
This topic includes the following sections:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1062503"> </a><a href="pbconv.html#wp1062529">Overview of Conversational Communication</a></li>
<li><a name="wp1062507"> </a><a href="pbconv.html#wp1062557">Joining an Application</a></li>
<li><a name="wp1062511"> </a><a href="pbconv.html#wp1089600">Establishing a Connection</a></li>
<li><a name="wp1062515"> </a><a href="pbconv.html#wp1062631">Sending and Receiving Messages</a></li>
<li><a name="wp1062519"> </a><a href="pbconv.html#wp1062763">Ending a Conversation</a></li>
<li><a name="wp1062523"> </a><a href="pbconv.html#wp1062836">Building Conversational Clients and Servers</a></li>
<li><a name="wp1062527"> </a><a href="pbconv.html#wp1062850">Understanding Conversational Communication Events</a></li>
</ul></div>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1062529"> </a>
Overview of Conversational Communication
</h2><p class="pBody"><a name="wp1062530"> </a>
Conversational communication is the Oracle Tuxedo system implementation of a human-like paradigm for exchanging messages between ATMI clients and servers. In this form of communication, a virtual connection is maintained between the client (initiator) and server (subordinate) and each side maintains information about the state of the conversation. The connection remains active until an event occurs to terminate it.
</p>
<p class="pBody"><a name="wp1073244"> </a>
During conversational communication, a <span style="font-style: italic">half-duplex</span> connection is established between the client and server. A half-duplex connection allows messages to be sent in only one direction at any given time. Control of the connection can be passed back and forth between the initiator and the subordinate. The process that has control can send messages; the process that does not have control can only receive messages.
</p>
<p class="pBody"><a name="wp1073241"> </a>
To understand how conversational communication works in an Oracle Tuxedo ATMI application, consider the following example from an online banking application. In this example, a bank customer requests checking account statements for the past two months.
</p>
<div class="pFigureTitle"><a name="wp1062533"> </a>
Figure&#160;7-1  Example of Conversational Communication in an Online Banking Application
</div>

 
 <p class="pGraphic"><a name="wp1062537"> </a>
</p>
<div class="figure" align="left"><img src="wwimages/conversation.jpg" alt="Example of Conversational Communication in an Online Banking Application" id="wp1062535" border="0" hspace="0" vspace="0"/></div><p class="pGraphic">

</p>
<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1062538"> </a>The customer requests the checking account statements for the past two months.</li>
<li><a name="wp1062539"> </a>The Account Records Storage System responds by sending the first month&#8217;s checking account statement followed by a <code class="cCode">More</code> prompt for accessing the remaining month&#8217;s statement.</li>
<li><a name="wp1062540"> </a>The customer requests the second month&#8217;s account statement by selecting the <code class="cCode">More</code> prompt.</li>
</ol></div>
<a name="wp1062541"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>The Account Records Storage System must maintain state information so it knows which account statement to return when the customer selects the <code class="cCode">More</code> prompt.</td>
</tr>
</table>

<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1062542"> </a>The Account Records Storage System sends the remaining month&#8217;s account statement.</li>
</ol></div>
<p class="pBody"><a name="wp1062543"> </a>
As with request/response communication, the Oracle Tuxedo system passes data using typed records. The record types must be recognized by the application. For more information on record types, refer to <a href="pbbuf.html#wp1266544">Overview of Typed Records</a>.
</p>
<p class="pBody"><a name="wp1062547"> </a>
Conversational clients and servers have the following characteristics: 
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1062548"> </a>The logical connection between them remains active until terminated.</li>
<li><a name="wp1062549"> </a>Any number of messages can be transmitted across a connection between them.</li>
<li><a name="wp1062550"> </a>Both clients and servers use the <code class="cCode">TPSEND</code> and <code class="cCode">TPRECV</code> routines to send and receive data in conversations.</li>
</ul></div>
<p class="pBody"><a name="wp1062551"> </a>
Conversational communication differs from request/response communication in the following ways:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1062552"> </a>A conversational client initiates a request for service using <code class="cCode">TPCONNECT</code> rather than <code class="cCode">TPCALL</code> or <code class="cCode">TPACALL</code>.</li>
<li><a name="wp1062553"> </a>A conversational client sends a service request to a conversational server.</li>
<li><a name="wp1062554"> </a>The configuration file reserves part of the conversational server for addressing conversational services.</li>
<li><a name="wp1062555"> </a>Conversational servers are prohibited from making calls using <code class="cCode">TPFORWAR</code>.</li>
</ul></div>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1062557"> </a>
Joining an Application
</h2><p class="pBody"><a name="wp1089595"> </a>
A conversational client must join an application via a call to <code class="cCode">TPINITIALIZE</code> before attempting to establish a connection to a service. For more information, refer to <span class="cHyperlink">
<a href="../pgc/pgclt.html">&#8220;Writing Clients&#8221; </a></span>in <em class="cEmphasis">Programming Oracle Tuxedo ATMI Applications Using C</em>.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1089600"> </a>
Establishing a Connection
</h2><p class="pBody"><a name="wp1062566"> </a>
The TPCONNECT<span class="cHyperlink">
<a href="../rf3cbl/rf3cbl.html"></a>(3cbl)</span> routine sets up a conversation:
</p>
<p class="pBody"><a name="wp1065595"> </a>
Use the following signature to call the <code class="cCode">TPCONNECT</code> routine.
</p>
<a name="wp1123941"> </a><div class="pPreformatted"><pre>01 TPSVCDEF-REC.<br />     COPY TPSVCDEF.</pre></div><a name="wp1123942"> </a><div class="pPreformatted"><pre>01 TPTYPE-REC.<br />     COPY TPTYPE.</pre></div><a name="wp1123943"> </a><div class="pPreformatted"><pre>01 DATA-REC.<br />     COPY User Data.</pre></div><a name="wp1123944"> </a><div class="pPreformatted"><pre>01 TPSTATUS-REC.<br />     COPY TPSTATUS.</pre></div><a name="wp1123945"> </a><div class="pPreformatted"><pre>CALL &quot;TPCONNECT&quot; USING TPSVCDEF-REC TPTYPE-REC DATA-REC TPSTATUS-REC.</pre></div><p class="pBody"><a name="wp1123949"> </a>
Refer to <span class="cHyperlink">
<a href="../pgc/pgserv.html">&#8220;Defining a Service&#8221; </a></span>for more information on the <code class="cCode">TPSVCDEF-REC</code> record, and to <a href="pbbuf.html#wp1266946">Defining Typed Records</a> for more information on the <code class="cCode">TPTYPE-REC</code> record. 
</p>
<p class="pBody"><a name="wp1123970"> </a>
At the same time the connection is being established, data can be sent through the <code class="cCode">DATA-REC</code> with the length of the data specified by <code class="cCode">LEN IN</code> <code class="cCode">TPTYPE-REC</code>. The <code class="cCode">REC-TYPE</code> and <code class="cCode">SUB-TYPE</code> of the data in <code class="cCode">DATA-REC</code> must be types recognized by the service being called. If no data is being sent, the value of <code class="cCode">REC-TYPE</code> is <code class="cCode">SPACES</code>, and <code class="cCode">DATA-REC</code> and <code class="cCode">LEN</code> are ignored. 
</p>
<p class="pBody"><a name="wp1062614"> </a>
The Oracle Tuxedo system returns a communication handle, <code class="cCode">COMM-HANDLE IN TPSVCDEF-REC</code>, when a connection is established with TPCONNECT or <code class="cCode">TPSVCSTART</code>. <code class="cCode">COMM-HANDLE</code> is used to identify subsequent message transmissions with a particular conversation. A client or conversational service can participate in more than one conversation simultaneously. The maximum number of simultaneous conversations is 64.
</p>
<p class="pBody"><a name="wp1062615"> </a>
In the event of a failure, <code class="cCode">TPCONNECT</code> sets <code class="cCode">TP-STATUS</code> to the appropriate error condition. For a list of possible error codes, refer to TPCO<span class="cHyperlink">
<a href="../rf3cbl/rf3cbl.html"></a>NNECT(3cbl)</span> in the <em class="cEmphasis">Oracle Tuxedo ATMI COBOL Function Reference</em>.
</p>
<p class="pBody"><a name="wp1062622"> </a>
The following example shows how to use the <code class="cCode">TPCONNECT</code> routine.
</p>
<div class="pCodeTitle"><a name="wp1124192"> </a>
Listing&#160;7-1	   Establishing a Conversational Connection
</div> <a name="wp1124193"> </a><div class="pPreformatted"><pre>&#160;&#160;&#160;&#160;. . .<br />* Prepare the record to send<br />&#160;&#160;MOVE &quot;HELLO&quot; TO DATA-REC.<br />&#160;&#160;MOVE 5 TO LEN.<br />&#160;&#160;MOVE &quot;STRING&quot; TO REC-TYPE.<br />*<br />&#160;&#160;SET TPBLOCK TO TRUE.<br />&#160;&#160;SET TPNOTRAN TO TRUE.<br />&#160;&#160;SET TPNOTIME TO TRUE.<br />&#160;&#160;SET TPSIGRSTRT TO TRUE.<br />&#160;&#160;SET TPSENDONLY TO TRUE.<br />*<br />&#160;&#160;CALL &quot;TPCONNECT&quot; USING TPSVCDEF-REC<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;TPTYPE-REC<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;DATA-REC<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;TPSTATUS-REC.<br />&#160;&#160;IF NOT TPOK<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<code class="cCodeEmphasis">error processing ...<br /></code>&#160;&#160;ELSE<br />&#160;&#160;&#160;&#160;&#160;&#160;COMM-HANDLE <code class="cCodeEmphasis">is valid</code>.</pre></div><p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1062631"> </a>
Sending and Receiving Messages
</h2><p class="pBody"><a name="wp1062632"> </a>
Once the Oracle Tuxedo system establishes a conversational connection, communication between the initiator and subordinate is accomplished using send and receive calls. The process with control of the connection can send messages using the TPSEN<span class="cHyperlink">
<a href="../rf3cbl/rf3cbl.html"></a>D(3cbl)</span> routine; the process without control can receive messages using the TPRECV(<span class="cHyperlink">
<a href="../rf3cbl/rf3cbl.html"></a>3cbl)</span> routine. 
</p>
<a name="wp1062633"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>Initially, the originator (that is, the client) decides which process has control using the <code class="cCode">TPSENDONLY</code> or <code class="cCode">TPRECVONLY</code> flag value of the <code class="cCode">TPCONNECT</code> call. <code class="cCode">TPSENDONLY</code> specifies that control is being retained by the originator; <code class="cCode">TPRECVONLY</code>, that control is being passed to the called service.</td>
</tr>
</table>

<h3 class="pHeading2"><a name="wp1062634"> </a>
Sending Messages
</h3>
<p class="pBody"><a name="wp1062635"> </a>
To send a message, use the TPSEN<span class="cHyperlink">
<a href="../rf3cbl/rf3cbl.html"></a>D(3cbl)</span> routine with the following signature:
</p>
<a name="wp1124304"> </a><div class="pPreformatted"><pre>01 <code class="cCodeEmphasis">TPSVCDEF-REC</code>.<br />     COPY TPSVCDEF.</pre></div><a name="wp1124305"> </a><div class="pPreformatted"><pre>01 <code class="cCodeEmphasis">TPTYPE-REC</code>.<br />     COPY TPTYPE.</pre></div><a name="wp1124306"> </a><div class="pPreformatted"><pre>01 <code class="cCodeEmphasis">DATA-REC</code>.<br />     COPY User Data.</pre></div><a name="wp1124307"> </a><div class="pPreformatted"><pre>01 <code class="cCodeEmphasis">TPSTATUS-REC</code>.<br />     COPY TPSTATUS.</pre></div><a name="wp1124308"> </a><div class="pPreformatted"><pre>CALL &quot;TPSEND&quot; USING <code class="cCodeEmphasis">TPSVCDEF-REC TPTYPE-REC USER-DATA-REC TPSTATUS-REC</code>.</pre></div><p class="pBody"><a name="wp1124312"> </a>
Refer to <span class="cHyperlink">
<a href="../pgc/pgserv.html">&#8220;Defining a Service&#8221; </a></span>in <em class="cEmphasis">Programming Oracle Tuxedo ATMI Applications Using C</em> for more information on the <code class="cCode">TPSVCDEF-REC</code> record, and refer to <a href="pbbuf.html#wp1266946">Defining Typed Records</a> for more information on the <code class="cCode">TPTYPE-REC</code> record.
</p>
<p class="pBody"><a name="wp1062686"> </a>
In the event of a failure, the <code class="cCode">TPSEND</code> routine sets <code class="cCode">TP-STATUS</code> to the appropriate error condition. For a list of possible error codes, refer to TPS<span class="cHyperlink">
<a href="../rf3cbl/rf3cbl.html"></a>END(3cbl)</span> in the <em class="cEmphasis">Oracle Tuxedo ATMI COBOL Function Reference</em>.
</p>
<p class="pBody"><a name="wp1062693"> </a>
You are not required to pass control each time you issue the <code class="cCode">TPSEND</code> routine. In some applications, the process authorized to issue <code class="cCode">TPSEND</code> calls can execute as many calls as required by the current task before turning over control to the other process. In other applications, however, the logic of the program may require the same process to maintain control of the connection throughout the life of the conversation.
</p>
<p class="pBody"><a name="wp1062694"> </a>
The following example shows how to invoke the <code class="cCode">TPSEND</code> routine.
</p>
<div class="pCodeTitle"><a name="wp1124548"> </a>
Listing&#160;7-2	   Sending Data in Conversational Mode
</div> <a name="wp1128052"> </a><div class="pPreformatted"><pre>&#160;&#160;&#160;. . .<br />&#160;&#160;&#160;SET TPNOBLOCK TO TRUE.<br />&#160;&#160;&#160;SET TPNOTIME TO TRUE.<br />&#160;&#160;&#160;SET TPSIGRSTRT TO TRUE.<br />&#160;&#160;&#160;SET TPRECVONLY TO TRUE.<br />*<br />&#160;&#160;&#160;CALL &quot;TPSEND&quot; USING TPSVCDEF-REC<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;TPTYPE-REC<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;DATA-REC<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;TPSTATUS-REC.<br />&#160;&#160;&#160;IF NOT TPOK<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;<code class="cCodeEmphasis">error processing . . .</code></pre></div><h3 class="pHeading2"><a name="wp1062702"> </a>
Receiving Messages
</h3>
<p class="pBody"><a name="wp1062703"> </a>
To receive data sent over an open connection, use the TPR<span class="cHyperlink">
<a href="../rf3cbl/rf3cbl.html"></a>ECV(3cbl)</span> routine with the following signature:
</p>
<a name="wp1124594"> </a><div class="pPreformatted"><pre>01 <code class="cCodeEmphasis">TPSVCDEF-REC</code>.<br />     COPY TPSVCDEF.</pre></div><a name="wp1124595"> </a><div class="pPreformatted"><pre>01 <code class="cCodeEmphasis">TPTYPE-REC</code>.<br />     COPY TPTYPE.</pre></div><a name="wp1124596"> </a><div class="pPreformatted"><pre>01 <code class="cCodeEmphasis">DATA-REC</code>.<br />     COPY User Data.</pre></div><a name="wp1124597"> </a><div class="pPreformatted"><pre>01 <code class="cCodeEmphasis">TPSTATUS-REC</code>.<br />     COPY TPSTATUS.</pre></div><a name="wp1124598"> </a><div class="pPreformatted"><pre>CALL &quot;TPRECV&quot; USING <code class="cCodeEmphasis">TPSVCDEF-REC TPTYPE-REC DATA-REC TPSTATUS-REC</code>.</pre></div><p class="pBody"><a name="wp1124602"> </a>
Refer to <span class="cHyperlink">
<a href="../pgc/pgserv.html">&#8220;Defining a Service&#8221; </a></span>for more information on the <code class="cCode">TPSVCDEF-REC</code> record. Refer to <a href="pbbuf.html#wp1266946">Defining Typed Records</a> for more information on the <code class="cCode">TPTYPE-REC</code> record.
</p>
<p class="pBody"><a name="wp1062754"> </a>
The following example shows how to use the <code class="cCode">TPRECV</code> routine. 
</p>
<div class="pCodeTitle"><a name="wp1124693"> </a>
Listing&#160;7-3	   Receiving Data in Conversation
</div> <a name="wp1124694"> </a><div class="pPreformatted"><pre>&#160;&#160;. . .<br />&#160;&#160;SET TPNOCHANGE TO TRUE.<br />&#160;&#160;SET TPBLOCK TO TRUE.<br />&#160;&#160;SET TPNOTIME TO TRUE.<br />&#160;&#160;SET TPSIGRSTRT TO TRUE.<br />*<br />&#160;&#160;MOVE LENGTH OF DATA-REC TO LEN.<br />*<br />&#160;&#160;CALL &quot;TPRECV&quot; USING TPSVCDEF-REC<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;TPTYPE-REC<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;DATA-REC<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;TPSTATUS-REC.<br />&#160;&#160;IF NOT TPOK<br />&#160;&#160;&#160;&#160;&#160;&#160;<code class="cCodeEmphasis">error processing . . .</code></pre></div><p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1062763"> </a>
Ending a Conversation
</h2><p class="pBody"><a name="wp1102727"> </a>
A connection can be taken down gracefully and a conversation ended normally through:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1102729"> </a>A successful call to <code class="cCode">TPRETURN</code> in a simple conversation.</li>
<li><a name="wp1102730"> </a>A series of successful calls to <code class="cCode">TPRETURN</code> in a complex conversation based on a hierarchy of connections.</li>
<li><a name="wp1066177"> </a>Global transactions, as described in <span class="cHyperlink">
<a href="../pgc/pgglob.html">&#8220;Writing Glo</a>bal Transactions&#8221; </span>in <em class="cEmphasis">Programming Oracle Tuxedo ATMI Applications Using C</em>.</li>
</ul></div>
<a name="wp1062765"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>The <code class="cCode">TPRETURN</code> routine is described in detail in <span class="cHyperlink">
<a href="../pgc/pgreq.html">&#8220;Writing Request/Response Clients and Servers&#8221;</a></span> in <em class="cEmphasis">Programming Oracle Tuxedo ATMI Applications Using C</em>. </td>
</tr>
</table>

<p class="pBody"><a name="wp1066330"> </a>
The following sections describe two scenarios for gracefully terminating conversations that do not include global transactions in which the <code class="cCode">TPRETURN</code> function is used.
</p>
<p class="pBody"><a name="wp1062769"> </a>
The first example shows how to terminate a simple conversation between two components. The second example illustrates a more complex scenario, with a hierarchical set of conversations.
</p>
<p class="pBody"><a name="wp1062774"> </a>
If you end a conversation with connections still open, the system returns an error. In this case, either <code class="cCode">TPCOMMIT</code> or <code class="cCode">TPRETURN</code> fails in a disorderly manner. 
</p>
<h3 class="pHeading2"><a name="wp1062775"> </a>
Example: Ending a Simple Conversation
</h3>
<p class="pBody"><a name="wp1062776"> </a>
<a href="pbconv.html#wp1124827">Figure&#160;7-2</a> shows a simple conversation between A and B that terminates gracefully.
</p>
<div class="pFigureTitle"><a name="wp1124827"> </a>
Figure&#160;7-2  Simple Conversation Terminating Gracefully
</div>

 
 <p class="pGraphic"><a name="wp1124831"> </a>
</p>
<div class="figure" align="left"><img src="wwimages/tpreturn3.gif" alt="Simple Conversation Terminating Gracefully" id="wp1124829"/></div><p class="pGraphic">

</p>
<p class="pBody"><a name="wp1062788"> </a>
The program flow is as follows:
</p>
<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1062789"> </a>A sets up the connection by calling <code class="cCode">TPCONNECT</code> with <code class="cCode">TPSENDONLY</code> set, indicating that process B is on the receiving end of the conversation.</li>
<li><a name="wp1066589"> </a>A turns control of the connection over to B by calling <code class="cCode">TPSEND</code> with <code class="cCode">TPRECVONLY</code> set, resulting in the generation of a <code class="cCode">TPEV_SENDONLY</code> event.</li>
<li><a name="wp1066620"> </a>The next call by B to <code class="cCode">TPRECV</code> sets <code class="cCode">TP-STATUS</code> to <code class="cCode">TPEEVENT</code>, and returns <code class="cCode">TPEV_SENDONLY</code> in <code class="cCode">TPEVENT</code>, indicating that control has passed to B.</li>
<li><a name="wp1066651"> </a>B calls <code class="cCode">TPRETURN</code> with <code class="cCode">TPRETURN-VAL IN TPSVCRET</code> set to <code class="cCode">TPSUCCESS</code>. This call generates a <code class="cCode">TPEV_SVCSUCC</code> event for A and gracefully brings down the connection. </li>
<li><a name="wp1066682"> </a>A calls <code class="cCode">TPRECV</code>, learns of the event, and recognizes that the conversation has been terminated. Data can be received on this call to <code class="cCode">TPRECV</code> even if the event is set to <code class="cCode">TPEV_SVCFAIL</code>. </li>
</ol></div>
<a name="wp1062794"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>In this example, A can be either a client or a server, but B must be a server.</td>
</tr>
</table>

<h3 class="pHeading2"><a name="wp1062795"> </a>
Example: Ending a Hierarchical Conversation
</h3>
<p class="pBody"><a name="wp1062796"> </a>
<a href="pbconv.html#wp1125084">Figure&#160;7-3</a> shows a hierarchical conversation that terminates gracefully. 
</p>
<div class="pFigureTitle"><a name="wp1125084"> </a>
Figure&#160;7-3  Connection Hierarchy
</div>

 
 <p class="pBody"><a name="wp1062810"> </a>
In the preceding example, service B is a member of a conversation that has initiated a connection to a second service called C. In other words, there are two active connections: A-to-B and B-to-C. If B is in control of both connections, a call to <code class="cCode">TPRETURN</code> has the following effect: the call fails, a <code class="cCode">TPEV_SVCERR</code> event is posted on all open connections, and the connections are closed in a disorderly manner. 
</p>
<p class="pBody"><a name="wp1062811"> </a>
In order to terminate both connections normally, an application must execute the following sequence:
</p>
<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1062812"> </a>B calls <code class="cCode">TPSEND</code> with the <code class="cCode">TPRECVONLY</code> flag set on the connection to C, transferring control of the B-to-C connection to C. </li>
<li><a name="wp1062813"> </a>C calls <code class="cCode">TPRETURN</code> with <code class="cCode">TPRETURN-VAL IN TPSVCRET</code> set to <code class="cCode">TPSUCCESS</code>, <code class="cCode">TPFAIL</code>, or <code class="cCode">TPEXIT</code>, as appropriate.</li>
<li><a name="wp1062814"> </a>B can then call <code class="cCode">TPRETURN</code>, posting an event (either <code class="cCode">TPEV_SVCSUCC</code> or <code class="cCode">TPEV_SVCFAIL</code>) for A.</li>
</ol></div>
<a name="wp1082302"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>It is legal for a conversational service to make request/response calls if it needs to do so to communicate with another service. Therefore, in the preceding example, the calls from B to C may be executed using <code class="cCode">TPCALL</code> or <code class="cCode">TPACALL</code> instead of <code class="cCode">TPCONNECT</code>. Conversational services are not permitted to make calls to <code class="cCode">TPFORWAR</code>.</td>
</tr>
</table>

<h3 class="pHeading2"><a name="wp1082308"> </a>
Executing a Disorderly Disconnect
</h3>
<p class="pBody"><a name="wp1062818"> </a>
The only way in which a disorderly disconnect can be executed is through a call to the TPDISCON(<span class="cHyperlink">
<a href="../rf3cbl/rf3cbl.html"></a>3cbl)</span> routine (which is equivalent to &#8220;pulling the plug&#8221; on a connection). This routine can be called only by the initiator of a conversation (that is, the client).
</p>
<a name="wp1062819"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>This is not the preferred method for bringing down a conversation. To bring down an application gracefully, the subordinate (the server) should call the <code class="cCode">TPRETURN</code> routine.</td>
</tr>
</table>

<p class="pBody"><a name="wp1062820"> </a>
Use the following signature to call the <code class="cCode">TPDISCON</code> routine:
</p>
<a name="wp1125372"> </a><div class="pPreformatted"><pre>01 <code class="cCodeEmphasis">TPSVCDEF-REC</code>.<br />     COPY TPSVCDEF.</pre></div><a name="wp1125373"> </a><div class="pPreformatted"><pre>01 <code class="cCodeEmphasis">TPSTATUS-REC</code>.<br />     COPY TPSTATUS.</pre></div><a name="wp1125374"> </a><div class="pPreformatted"><pre>CALL &quot;TPDISCON&quot; USING <code class="cCodeEmphasis">TPSVCDEF-REC TPSTATUS-REC</code>.</pre></div><p class="pBody"><a name="wp1062825"> </a>
The <code class="cCode">COMM-HANDLE</code> argument specifies the communication handle returned by the <code class="cCode">TPCONNECT</code> routine when the connection is established.
</p>
<p class="pBody"><a name="wp1062826"> </a>
The <code class="cCode">TPDISCON</code> routine generates a <code class="cCode">TPEV_DISCONIMM</code> event for the service at the other end of the connection, rendering the <code class="cCode">COMM-HANDLE</code> invalid. If a transaction is in progress, the system aborts it and data may be lost. 
</p>
<p class="pBody"><a name="wp1062827"> </a>
If <code class="cCode">TPDISCON</code> is called from a service that was not the originator of the connection identified by <code class="cCode">COMM-HANDLE</code>, the routine fails with an error code of <code class="cCode">TPEBADDESC</code>. 
</p>
<p class="pBody"><a name="wp1062828"> </a>
For a list and descriptions of all event and error codes, refer to TPDI<span class="cHyperlink">
<a href="../rf3cbl/rf3cbl.html"></a>SCON(3cbl)</span> in the <em class="cEmphasis">Oracle Tuxedo ATMI COBOL Function Reference</em>.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1062836"> </a>
Building Conversational Clients and Servers
</h2><p class="pBody"><a name="wp1062837"> </a>
Use the following commands to build conversational clients and servers:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1062841"> </a><code class="cCode">buildclient() </code>as described in &#8220;Building Clients&#8221; in <a href="../pgc/pgclt.html"><em class="cEmphasis">Programming Oracle Tuxedo ATMI Applications Using C</em></a></li>
<li><a name="wp1062845"> </a><code class="cCode">buildserver()</code> as described in &#8220;Building Servers&#8221; in <a href="../pgc/pgserv.html"><em class="cEmphasis">Programming Oracle Tuxedo ATMI Applications Using C</em></li>
</ul></div>
<p class="pBody"><a name="wp1062846"> </a>
For conversational and request/response services, you cannot:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1062847"> </a>Build both in the same server</li>
<li><a name="wp1062848"> </a>Assign the same name to both</li>
</ul></div>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1062850"> </a>
Understanding Conversational Communication Events
</h2><p class="pBody"><a name="wp1062851"> </a>
The Oracle Tuxedo system recognizes five events in conversational communication. All five events can be posted for <code class="cCode">TPRECV</code>; three can be posted for <code class="cCode">TPSEND</code>. 
</p>
<p class="pBody"><a name="wp1062852"> </a>
<a href="pbconv.html#wp1114257">Table&#160;7-1</a> lists the events, the routines for which they are returned, and a detailed description of each.
</p>
<p class="pGraphic"><a name="wp1127761"> </a>
</p>
<div align="left">
<table class="table" cellpadding="3" cellspacing="0" id="wp1114257table1062853"><caption><a name="wp1114257"> </a>
Table 7-1  <span style="font-style: normal; font-weight: bold; text-decoration: none; vertical-align: baseline">Conversational Communication Events</span>

</caption>

  <tr bgcolor="#CCCCCC" align="center" valign="top">    <th scope="col"><div class="pCellHeading"><a name="wp1062855"> </a>
Event
</div>
</th>
    <th scope="col"><div class="pCellHeading"><a name="wp1062857"> </a>
Received By
</div>
</th>
    <th scope="col"><div class="pCellHeading"><a name="wp1062859"> </a>
Description
</div>
</th>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062861"> </a>
<code class="cCode">TPEV_SENDONLY</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062863"> </a>
<code class="cCode">TPRECV</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062865"> </a>
Control of the connection has been passed; this process can now call <code class="cCode">TPSEND</code>.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062867"> </a>
<code class="cCode">TPEV_DISCONIMM</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062869"> </a>
<code class="cCode">TPSEND</code>,   <br /><code class="cCode">TPRECV</code>, <code class="cCode">TPRETURN</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062871"> </a>
The connection has been torn down and no further communication is possible. The <code class="cCode">TPDISCON</code> routine posts this event in the originator of the connection, and sends it to all open connections when <code class="cCode">TPRETURN</code> is called, as long as connections to subordinate services remain open. Connections are closed in a disorderly fashion. If a transaction exists, it is aborted.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="straddledcells" colspan="1" rowspan="2"><div class="pCellBody"><a name="wp1062873"> </a>
<code class="cCode">TPEV_SVCERR</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062875"> </a>
<code class="cCode">TPSEND</code> 
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062877"> </a>
Received by the originator of the connection, usually indicating that the subordinate program issued a <code class="cCode">TPRETURN</code> without having control of the connection. 
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062881"> </a>
<code class="cCode">TPRECV</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062883"> </a>
Received by the originator of the connection, indicating that the subordinate program issued a <code class="cCode">TPRETURN</code> with <code class="cCode">TPSUCCESS</code> or <code class="cCode">TPFAIL</code> and a valid data record, but an error occurred that prevented the call from completing.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="straddledcells" colspan="1" rowspan="2"><div class="pCellBody"><a name="wp1062885"> </a>
<code class="cCode">TPEV_SVCFAIL</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1097409"> </a>
<code class="cCode">TPSEND</code> 
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062889"> </a>
Received by the originator of the connection, indicating that the subordinate program issued a <code class="cCode">TPRETURN</code> without having control of the connection, and <code class="cCode">TPRETURN</code> was called with <code class="cCode">TPFAIL</code> or <code class="cCode">TPEXIT</code> and no data.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1097424"> </a>
<code class="cCode">TPRECV</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062895"> </a>
Received by the originator of the connection, indicating that the subordinate service finished unsuccessfully (<code class="cCode">TPRETURN</code> was called with <code class="cCode">TPFAIL</code> or <code class="cCode">TPEXIT</code>).
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062897"> </a>
<code class="cCode">TPEV_SVCSUCC</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1097429"> </a>
<code class="cCode">TPRECV</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1062901"> </a>
Received by the originator of the connection, indicating that the subordinate service finished successfully; that is, it called <code class="cCode">TPRETURN</code> with <code class="cCode">TPSUCCESS</code>.
</div>
</td>
</tr>
</table>
</div>
<p class="pGraphic">

</p>
 
<br/>
    <table id="SummaryNotReq2" width="100%" border="0" cellpadding="0" cellspacing="0">
      <tr> 
        <td>
&nbsp;
<a href="pbconv.html"><img id="LongDescNotReq7" src="/global_resources/images/backtop.gif" width="90" height="25" alt="Back to Top" title="Back to Top" border="0" /></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a accesskey="4" href="pbreq.html"><img id="LongDescNotReq8" src="/global_resources/images/prevtop.gif" border="0" alt="Previous" /></a>&nbsp;
<a accesskey="5" href="pbevb.html"><img id="LongDescNotReq9" src="/global_resources/images/nexttop.gif" border="0" alt="Next" /></a>
<script language="Javascript1.1" type="text/javascript">
Copyright();
</script>
<noscript><a href="http://edocs.bea.com/copyright.html">&copy; BEA Systems</a></noscript>
        </td>
      </tr>
    </table>

<!-- WebAnalytics BEGIN -->

<!--#include virtual="/global_resources/edocs_wt.html"-->
      
<!-- WebAnalytics END -->

  </body>
</html>
