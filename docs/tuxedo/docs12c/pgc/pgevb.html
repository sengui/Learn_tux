<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>

<!-- LOCALIZATION RELATED INFORMATION -->
<meta name="LOC_PROJ_ID" content="WLPF8.1" />
<meta name="LOC_OWNER" content="BEAJ" />
<meta name="LOC_STATUS" content="READY!" />
<meta name="LOC_COMMENT" content="LOC_COMMENT" />
<meta name="LOC_US_REV" content="1" />
<meta name="LOC_US_CHANGE" content="41824" />
<meta name="LOC_US_SRCFILE" content="//depot/tuxedo/tux12c/pgc/fm/pgevb.fm" />
<!-- LOCALIZATION RELATED INFORMATION -->

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta name="GENERATOR" content="Quadralay WebWorks AutoMap 2003 Platinum Edition for FrameMaker 8.6.6577.0" />
    <meta name="TEMPLATEBASE" content="BEA_WFP_Template_V1.04" />
    <meta name="LASTUPDATED" content="06/26/12 11:37:56" />
    <link rel="StyleSheet" href="/global_resources/edocs.css" type="text/css" media="all" />

<title>Writing Event-based Clients and Servers</title>

<!-- BEA scripts begin -->

<script language="Javascript" src="/global_resources/js/banner.js" type="text/javascript"></script>
<!-- This script outputs the banner required for edocs documentation. -->

<script language="Javascript" src="floatwin.js" type="text/javascript"></script>
<!-- This script opens a new small floating window and puts TOC<i>&lt;name&gt;</i>.html and IX<i>&lt;name&gt;</i>.html files in it and sets a generic popup window code to enable the display of some viewlets in the WebLogic Platform Tour. -->

<script language="Javascript1.1" src="/global_resources/js/footer.js" type="text/javascript"></script>
<!-- This script outputs the footer with the correct copyright date and link to copyright page.-->

<script language="Javascript1.1" src="/global_resources/js/googlesearch4.js" type="text/javascript"></script>
<!-- This script outputs the google search form. -->

<script language="Javascript1.1" src="/global_resources/js/note.js" type="text/javascript"></script>
<!-- This script outputs a note such as a BETA note. -->

<script language="JavaScript1.1" src="/global_resources/js/search.js" type="text/javascript"></script>
<!-- This script is not for online documents. It is only used by the QuestAgent Java Applet for CD search indexes. -->

<!-- BEA scripts end -->

  </head>

  <body>


<script language="Javascript1.1" type="text/javascript">
GoogleURL();
</script><noscript>This script outputs the google search URL required for search on edocs documentation.</noscript>

<script language="Javascript1.1" type="text/javascript">
Banner();
</script><noscript>This script outputs the banner required for edocs documentation.</noscript>

<script language="Javascript1.1" type="text/javascript">
GoogleSearchCollection();
</script><noscript>This script outputs the google search parameters required for search on edocs documentation.</noscript>

<!-- page title -->
<h1 class="booktitle">Programming an Oracle Tuxedo ATMI Application Using C
</h1>
<!-- page title end -->

    <table id="SummaryNotReq1" width="100%" border="0" align="left" cellpadding="2%" cellspacing="0">
      <tr> 
        <td>
&nbsp;&nbsp;&nbsp;&nbsp;
<a accesskey="4" href="pgconv.html"><img id="LongDescNotReq1" src="/global_resources/images/doc_nav_prev.gif" border="0" alt="Previous" /></a>&nbsp;
<a accesskey="5" href="pgglob.html"><img id="LongDescNotReq2" src="/global_resources/images/doc_nav_next.gif" border="0" alt="Next" /></a>&nbsp;
<img id="LongDescNotReq3" src="/global_resources/images/doc_nav_dots.gif" border="0" alt="" />&nbsp;
<a accesskey="1" href="javascript:OpenWindowToc();" onmouseover="window.status='Table of Contents'; return true" onfocus="window.status='Table of Contents'; return true" onmouseout="window.status=''; return true" onblur="window.status=''; return true" title="Open TOC in new window">      <img id="LongDescNotReq4" src="/global_resources/images/doc_nav_contents.gif" alt="Open TOC in new window" border="0" /></a>&nbsp;
&nbsp;
<a href="../pdf/pgc.pdf" target="pdf"><img id="LongDescNotReq5" src="/global_resources/images/doc_nav_pdf.gif" width="59" height="44" alt="View as PDF - New Window" title="View as PDF - New Window" border="0" /></a>&nbsp;
<a href="http://www.adobe.com/products/acrobat/alternate.html" target="_blank"><img id="LongDescNotReq6" src="/global_resources/images/get_reader.gif" width="52" height="44" alt="Get Adobe Reader - New Window" title="Get Adobe Reader - New Window" border="0" /></a>
<a name="link_group_0"></a>
	</td>
      </tr>
    </table>

<a name="skipnav" title="Content starts here"><img src="/global_resources/images/_.gif" alt="Content starts here" border="0" height="1" width="1" /></a>



<h1 class="pChapHead"><a name="wp1114675"> </a>
Writing Event-based Clients and Servers
</h1>
<p class="pBody"><a name="wp1107834"> </a>
This topic includes the following sections:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1080980"> </a><a href="pgevb.html#wp1081014">Overview of Events</a></li>
<li><a name="wp1080984"> </a><a href="pgevb.html#wp1081079">Defining the Unsolicited Message Handler</a></li>
<li><a name="wp1080988"> </a><a href="pgevb.html#wp1081106">Sending Unsolicited Messages</a></li>
<li><a name="wp1080992"> </a><a href="pgevb.html#wp1081203">Checking for Unsolicited Messages</a></li>
<li><a name="wp1081000"> </a><a href="pgevb.html#wp1081229">Subscribing to Events</a></li>
<li><a name="wp1081004"> </a><a href="pgevb.html#wp1081383">Unsubscribing from Events</a></li>
<li><a name="wp1081008"> </a><a href="pgevb.html#wp1081416">Posting Events</a></li>
<li><a name="wp1111470"> </a><a href="pgevb.html#wp1112708">Example of Event Subscription</a></li>
</ul></div>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1081014"> </a>
Overview of Events
</h2><p class="pBody"><a name="wp1081015"> </a>
Event-based communication provides a method for an Oracle Tuxedo system process to be notified when a specific situation (event) occurs.
</p>
<p class="pBody"><a name="wp1081016"> </a>
The Oracle Tuxedo system supports two types of event-based communication:
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1081017"> </a>Unsolicited events</li>
<li><a name="wp1081018"> </a>Brokered events</li>
</ul></div>
<h3 class="pHeading2"><a name="wp1081019"> </a>
Unsolicited Events
</h3>
<p class="pBody"><a name="wp1081020"> </a>
Unsolicited events are messages used to communicate with client programs that are not waiting for and/or expecting a message. 
</p>
<h3 class="pHeading2"><a name="wp1081021"> </a>
Brokered Events
</h3>
<p class="pBody"><a name="wp1081022"> </a>
Brokered events enable a client and a server to communicate transparently with one another via an &#8220;anonymous&#8221; broker that receives and distributes messages. Such brokering is another client/server communication paradigm that is fundamental to the Oracle Tuxedo system.
</p>
<p class="pBody"><a name="wp1081023"> </a>
The EventBroker is an Oracle Tuxedo subsystem that receives and filters event posting messages, and distributes them to subscribers. A <em class="cEmphasis">poster</em> is an Oracle Tuxedo system process that detects when a specific event has occurred and reports (posts) it to the EventBroker. A <em class="cEmphasis">subscriber</em> is an Oracle Tuxedo system process with a standing request to be notified whenever a specific event has been posted.
</p>
<p class="pBody"><a name="wp1081024"> </a>
The Oracle Tuxedo system does not impose a fixed ratio of service requesters to service providers; an arbitrary number of posters can post a message buffer for an arbitrary number of subscribers. The posters simply post events, without knowing which processes receive the information or how the information is handled. Subscribers are notified of specified events, without knowing who posted the information. In this way, the EventBroker provides complete location transparency.
</p>
<p class="pBody"><a name="wp1081025"> </a>
Typically, EventBroker applications are designed to handle exception events. An application designer must decide which events in the application constitute exception events and need to be monitored. In a banking application, for example, it might be useful to post an event whenever an unusually large amount of money is withdrawn, but it would not be particularly useful to post an event for every withdrawal transaction. In addition, not all users would need to subscribe to that event; perhaps only the branch manager would need to be notified.
</p>
<h4 class="pHeading3"><a name="wp1081026"> </a>
Notification Actions
</h4>
<p class="pBody"><a name="wp1081027"> </a>
The EventBroker may be configured such that whenever an event is posted, the EventBroker invokes one or more notification actions for clients and/or servers that have subscribed. <a href="pgevb.html#wp686070">Table&#160;8-1</a> lists the types of notification actions that the EventBroker can take.
</p>
<p class="pGraphic"><a name="wp1081049"> </a>
</p>
<div align="left">
<table class="table" cellpadding="3" cellspacing="0" id="wp686070table1081028"><caption><a name="wp686070"> </a>
Table 8-1  <span style="font-style: normal; font-weight: bold; text-decoration: none; vertical-align: baseline">EventBroker Notification Actions</span>

</caption>

  <tr bgcolor="#CCCCCC" align="center" valign="top">    <th scope="col"><div class="pCellHeading"><a name="wp1081030"> </a>
Notification Action
</div>
</th>
    <th scope="col"><div class="pCellHeading"><a name="wp1081032"> </a>
Description
</div>
</th>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081034"> </a>
Unsolicited notification message
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081036"> </a>
Clients may receive event notification messages in their unsolicited message handling routine, just as if they were sent by the <a href="pgevb.html#wp1081164">tpnotify()</a> function.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081038"> </a>
Service call
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081040"> </a>
Servers may receive event notification messages as input to service routines, just as if they were sent by the <a href="pgreq.html#wp1055487">tpacall()</a> function.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081042"> </a>
Reliable queue
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081044"> </a>
Event notification messages may be stored in an Oracle Tuxedo system reliable queue, using the <a href="../rf3c/rf3c.html">tpenqueue(3c)</a> function. Event notification buffers are stored until requests for buffer contents are issued. An Oracle Tuxedo system client or server process may call the <a href="../rf3c/rf3c.html">tpdequeue(3c)</a> function to retrieve these notification buffers, or alternately <a href="../rf5/rf5.html">TMQFORWARD(5)</a> may be configured to automatically dispatch an Oracle Tuxedo system service routine that retrieves a notification buffer.
</div>
<div class="pCellBody"><a name="wp1081047"> </a>
For more information on /Q, see <em class="cEmphasis">Using the ATMI /Q Component</em>.
</div>
</td>
</tr>
</table>
</div>
<p class="pGraphic">

</p>
<p class="pBody"><a name="wp1081050"> </a>
In addition, the application administrator may create an <a href="../rf5/rf5.html">EVENT_MIB(5)</a> entry (by using the Oracle Tuxedo administrative API) that performs the following notification actions: 
</p>
<div class="pSmartList1Bullet"><ul>
<li><a name="wp1081051"> </a>Invokes a system command</li>
<li><a name="wp1081052"> </a>Writes a message to the system&#8217;s log file on disk</li>
</ul></div>
<a name="wp1081053"> </a><table class="Note">
<tr>
<td valign="top"><strong>Note:</strong></td>
<td>Only the Oracle Tuxedo application administrator is allowed to create an <a href="../rf5/rf5.html">EVENT_MIB(5)</a> entry.</td>
</tr>
</table>

<p class="pBody"><a name="wp1081056"> </a>
For information on the <a href="../rf5/rf5.html">EVENT_MIB(5)</a>, refer to the <em class="cEmphasis">File Formats, Data Descriptions, MIBs, and System Processes Reference</em>.
</p>
<h4 class="pHeading3"><a name="wp1081058"> </a>
EventBroker Servers
</h4>
<p class="pBody"><a name="wp1081059"> </a>
<code class="cCode">TMUSREVT</code> is the Oracle Tuxedo system-supplied server that acts as an EventBroker for <em class="cEmphasis">user events</em>. <code class="cCode">TMUSREVT</code> processes event report message buffers, and then filters and distributes them. The Oracle Tuxedo application administrator must boot one or more of these servers to activate event brokering.
</p>
<p class="pBody"><a name="wp1081060"> </a>
<code class="cCode">TMSYSEVT</code> is the Oracle Tuxedo system-supplied server that acts as an EventBroker for <em class="cEmphasis">system-defined events</em>. <code class="cCode">TMSYSEVT</code> and <code class="cCode">TMUSREVT</code> are similar, but separate servers are provided to allow the application administrator the ability to have different replication strategies for processing notifications of these two types of events. Refer to <em class="cEmphasis">Setting Up an Oracle Tuxedo Application</em> for additional information.
</p>
<h4 class="pHeading3"><a name="wp1081064"> </a>
System-defined Events
</h4>
<p class="pBody"><a name="wp1081065"> </a>
The Oracle Tuxedo system itself detects and posts certain predefined events related to system warnings and failures. These tasks are performed by the EventBroker. For example, system-defined events include configuration changes, state changes, connection failures, and machine partitioning. For a complete list of system-defined events detected by the EventBroker, see <a href="../rf5/rf5.html">EVENTS(5)</a> in the <em class="cEmphasis">File Formats, Data Descriptions, MIBs, and System Processes Reference</em>.
</p>
<p class="pBody"><a name="wp1081069"> </a>
System-defined events are defined in advance by the Oracle Tuxedo system code and do not require posting. The name of a system-defined event, unlike that of an application-defined event, always begins with a dot (&#8220;.&#8221;). Names of application-defined events may not begin with a leading dot. 
</p>
<p class="pBody"><a name="wp1081070"> </a>
Clients and servers can subscribe to system-defined events. These events, however, should be used mainly by application administrators, not by every client in the application.
</p>
<p class="pBody"><a name="wp1081071"> </a>
When incorporating the EventBroker into your application, remember that it is not intended to provide a mechanism for high-volume distribution to many subscribers. Do not attempt to post an event for every activity that occurs, and do not expect all clients and servers to subscribe. If you overload the EventBroker, system performance may be adversely affected and notifications may be dropped. To minimize the possibility of overload, the application administrator should carefully tune the operating system IPC resources, as explained in <em class="cEmphasis">Installing the Oracle Tuxedo System</em>.
</p>
<h4 class="pHeading3"><a name="wp1081072"> </a>
Programming Interface for the EventBroker
</h4>
<p class="pBody"><a name="wp1081073"> </a>
EventBroker programming interfaces are available for all Oracle Tuxedo system server and client processes, including Workstation, in both C and COBOL. 
</p>
<p class="pBody"><a name="wp1081074"> </a>
The programmer&#8217;s job is to code the following sequence:
</p>
<div class="pSmartList1"><ol type="1" class="pSmartList1">
<li><a name="wp1081075"> </a>A client or server <em class="cEmphasis">posts</em> a buffer to an application-defined event name.</li>
<li><a name="wp1081076"> </a>The posted buffer is transmitted to any number of processes that have <em class="cEmphasis">subscribed</em> to the event.</li>
</ol></div>
<p class="pBody"><a name="wp1081077"> </a>
Subscribers may be notified in a variety of ways (as discussed in &#8220;Notification Actions&#8221;), and events may be filtered. Notification and filtering are configured through the programming interface, as well as through the Oracle Tuxedo system administrative API.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1081079"> </a>
Defining the Unsolicited Message Handler
</h2><p class="pBody"><a name="wp1081080"> </a>
To define the unsolicited message handler function, use the <a href="../rf3c/rf3c.html">tpsetunsol(3c)</a> function with the following signature:
</p>
<a name="wp1111563"> </a><div class="pPreformatted"><pre>int<br />tpsetunsol(*<code class="cCodeEmphasis">myfunc</code>)</pre></div><p class="pBody"><a name="wp1115431"> </a>
If you are running on Windows-based operating systems you must declare unsolicited message handler functions as:
</p>
<a name="wp1115432"> </a><div class="pPreformatted"><pre>  void _TMDLLENTRY CustomerUnsolFunc(char *data, long len, long flags)</pre></div><p class="pBody"><a name="wp1115433"> </a>
The <code class="cCode">_TMDLLENTRY</code> macro is required for Windows-based operating systems to obtain the proper calling conventions between the Tuxedo libraries and your code.
</p>
<p class="pBody"><a name="wp1115429"> </a>
On Unix systems, the <code class="cCode">_TMDLLENTRY</code> macro is not required because it expands to the null string.
</p>
<p class="pBody"><a name="wp1111564"> </a>
<a href="pgevb.html#wp686141">Table&#160;8-2</a> describes the single argument that can be passed to the <code class="cCode">tpsetunsol()</code> function.
</p>
<p class="pGraphic"><a name="wp1111577"> </a>
<em class="cEmphasis"></em></p>
<div align="left">
<table class="table" cellpadding="3" cellspacing="0" id="wp686141table1111565"><caption><a name="wp686141"> </a>
Table 8-2  <b class="cBold">tpsetunsol( ) Function Argument</b>

</caption>

  <tr bgcolor="#CCCCCC" align="center" valign="top">    <th scope="col"><div class="pCellHeading"><a name="wp1111567"> </a>
Argument
</div>
</th>
    <th scope="col"><div class="pCellHeading"><a name="wp1111569"> </a>
Description
</div>
</th>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1111571"> </a>
<code class="cCodeEmphasis">myfunc</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1111573"> </a>
Pointer to a function that conforms to the prototype of a call-back function. In order to conform, the function must accept the following three parameters:
</div>
<div class="pSmartList1TableBullet"><ul class="SmartList1TableBullet">
<li><a name="wp1111574"> </a><code class="cCodeEmphasis">data</code>&#8212;points to the typed buffer that contains the unsolicited message</li>
<li><a name="wp1111575"> </a><code class="cCodeEmphasis">len</code>&#8212;length of the buffer</li>
<li><a name="wp1111576"> </a><code class="cCodeEmphasis">flags</code>&#8212;currently not used</li>
</ul></div>
</td>
</tr>
</table>
</div>
<p class="pGraphic">
<em class="cEmphasis"></em>
</p>
<p class="pBody"><a name="wp1111578"> </a>
When a client receives an unsolicited notification, the system dispatches the call-back function with the message. To minimize task disruption, you should code the unsolicited message handler function to perform only minimal processing tasks, so it can return quickly to the waiting process.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1081106"> </a>
Sending Unsolicited Messages
</h2><p class="pBody"><a name="wp1081107"> </a>
The Oracle Tuxedo system allows unsolicited messages to be sent to client processes without disturbing the processing of request/response calls or conversational communications. 
</p>
<p class="pBody"><a name="wp1092714"> </a>
Unsolicited messages can be sent to client processes by name, using <a href="../rf3c/rf3c.html">tpbroadcast(3c)</a>, or by an identifier received with a previously processed message, using <a href="../rf3c/rf3c.html">tpnotify(3c)</a>. Messages sent via <code class="cCode">tpbroadcast</code>() can originate either in a service or in another client. Messages sent via <code class="cCode">tpnotify</code>() can originate only in a service.
</p>
<h3 class="pHeading2"><a name="wp1081110"> </a>
Broadcasting Messages by Name
</h3>
<p class="pBody"><a name="wp1081111"> </a>
The <a href="../rf3c/rf3c.html">tpbroadcast(3c)</a> function allows a message to be sent to registered clients of the application. It can be called by a service or another client. Registered clients are those that have successfully made a call to <a href="pgclt.html#wp1030381">tpinit()</a> and have not yet made a call to <a href="pgclt.html#wp1030538">tpterm()</a>. 
</p>
<p class="pBody"><a name="wp1081112"> </a>
Use the following signature to call the <code class="cCode">tpbroadcast</code>() function:
</p>
<a name="wp1111810"> </a><div class="pPreformatted"><pre>int<br />tpbroadcast(char *<em class="cEmphasis">lmid, char *usrname, char *cltname, char *data, long len, long flags</em>)</pre></div><p class="pBody"><a name="wp1081115"> </a>
<a href="pgevb.html#wp686122">Table&#160;8-3</a> describes the arguments to the <code class="cCode">tpbroadcast()</code> function.
</p>
<p class="pGraphic"><a name="wp1081116"> </a>
<em class="cEmphasis"></em></p>
<div align="left">
<table class="table" cellpadding="3" cellspacing="0" id="wp686122table1081117"><caption><a name="wp686122"> </a>
Table 8-3  tpbroadcast( ) Function Arguments

</caption>

  <tr bgcolor="#CCCCCC" align="center" valign="top">    <th scope="col"><div class="pCellHeading"><a name="wp1081119"> </a>
Argument
</div>
</th>
    <th scope="col"><div class="pCellHeading"><a name="wp1081121"> </a>
Description
</div>
</th>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081123"> </a>
<code class="cCodeEmphasis">lmid</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081125"> </a>
Pointer to the logical machine identifier for the client. A value of NULL acts as a wildcard, so that a message can be directed to groups of clients.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081127"> </a>
<code class="cCodeEmphasis">usrname</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081129"> </a>
Pointer to the username of the client process, if one exists. A value of NULL acts as a wildcard, so that a message can be directed to groups of clients.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081131"> </a>
<code class="cCodeEmphasis">cltname</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081133"> </a>
Pointer to the client name of the client process, if one exists. A value of NULL acts as a wildcard, so that a message can be directed to groups of clients.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081135"> </a>
<code class="cCodeEmphasis">data</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081137"> </a>
Pointer to the content of a message.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081139"> </a>
<code class="cCodeEmphasis">len</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081141"> </a>
Size of the message buffer. If <code class="cCodeEmphasis">data</code> points to a self-defining buffer type, for example, <code class="cCode">FML</code>, then <code class="cCodeEmphasis">len</code> can be set to 0.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081143"> </a>
<code class="cCodeEmphasis">flags</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1081145"> </a>
Flag options. Refer to <a href="../rf3c/rf3c.html">tpbroadcast(3c)</a> in the <em class="cEmphasis">Oracle Tuxedo ATMI C Function Reference</em> for information on available flags.
</div>
</td>
</tr>
</table>
</div>
<p class="pGraphic">
<em class="cEmphasis"></em>
</p>
<p class="pBody"><a name="wp1081156"> </a>
<a href="pgevb.html#wp1111917">Listing&#160;8-1</a> illustrates a call to <code class="cCode">tpbroadcast</code>() for which all clients are targeted. The message to be sent is contained in a <code class="cCode">STRING</code> buffer.
</p>
<div class="pCodeTitle"><a name="wp1111917"> </a>
Listing&#160;8-1	   Using tpbroadcast( )
</div> <a name="wp1115825"> </a><div class="pPreformatted"><pre>char *strbuf;<br /> <br /> if ((strbuf = tpalloc(&quot;STRING&quot;, NULL, 0)) == NULL) {<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<em class="cEmphasis">error routine<br /></em>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}<br /> <br /> (void) strcpy(strbuf, &quot;hello, world&quot;);<br /> <br /> if (tpbroadcast(NULL, NULL, NULL, strbuf, 0, TPSIGRSTRT) == -1)<br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<em class="cEmphasis">&#160;&#160;&#160;&#160;error routine</em></pre></div><h3 class="pHeading2"><a name="wp1081164"> </a>
Broadcasting Messages by Identifier
</h3>
<p class="pBody"><a name="wp1081165"> </a>
The <a href="../rf3c/rf3c.html">tpnotify(3c)</a> function is used to broadcast a message using an identifier received with a previously processed message. It can be called only from a service.
</p>
<p class="pBody"><a name="wp1081166"> </a>
Use the following signature to call the <code class="cCode">tpnotify</code>() function:
</p>
<a name="wp1112018"> </a><div class="pPreformatted"><pre>int<br />tpnotify(CLIENTID *<em class="cEmphasis">clientid, char *data, long len, long flags</em>)</pre></div><p class="pBody"><a name="wp1112019"> </a>
<a href="pgevb.html#wp686181">Table&#160;8-4</a> describes the arguments to the <code class="cCode">tpnotify()</code> function.
</p>
<p class="pGraphic"><a name="wp1112047"> </a>
<em class="cEmphasis"></em></p>
<div align="left">
<table class="table" cellpadding="3" cellspacing="0" id="wp686181table1112020"><caption><a name="wp686181"> </a>
Table 8-4  tpnotify( ) Function Arguments

</caption>

  <tr bgcolor="#CCCCCC" align="center" valign="top">    <th scope="col"><div class="pCellHeading"><a name="wp1112022"> </a>
Argument
</div>
</th>
    <th scope="col"><div class="pCellHeading"><a name="wp1112024"> </a>
Description
</div>
</th>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112026"> </a>
<code class="cCodeEmphasis">clientid</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112028"> </a>
Pointer to a <code class="cCode">CLIENTID</code> structure that is saved from the <code class="cCode">TPSVCINFO</code> structure that accompanied the request to this service. 
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112030"> </a>
<code class="cCodeEmphasis">data</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112032"> </a>
Pointer to the content of the message.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112034"> </a>
<code class="cCodeEmphasis">len</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112036"> </a>
Size of the message buffer. If <code class="cCodeEmphasis">data</code> points to a self-defining buffer type, for example, <code class="cCode">FML</code>, then <code class="cCodeEmphasis">len</code> can be set to 0.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112038"> </a>
<code class="cCodeEmphasis">flags</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112045"> </a>
Flag options. Refer to <a href="../rf3c/rf3c.html">tpnotify(3c)</a> in the <em class="cEmphasis">Oracle Tuxedo ATMI C Function Reference</em> for information on available flags.
</div>
</td>
</tr>
</table>
</div>
<p class="pGraphic">
<em class="cEmphasis"></em>
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1081203"> </a>
Checking for Unsolicited Messages
</h2><p class="pBody"><a name="wp1081204"> </a>
To check for unsolicited messages while running the client in &#8220;dip-in&#8221; notification mode, use the <a href="../rf3c/rf3c.html">tpchkunsol(3c)</a> function with the following signature:
</p>
<a name="wp1112096"> </a><div class="pPreformatted"><pre>int<br />tpchkunsol()</pre></div><p class="pBody"><a name="wp1112097"> </a>
The function takes no arguments.
</p>
<p class="pBody"><a name="wp1081208"> </a>
If any messages are pending, the system invokes the unsolicited message handling function that was specified using <a href="pgevb.html#wp1081079">tpsetunsol()</a>. Upon completion, the function returns either the number of unsolicited messages that were processed or <code class="cCode">-1</code> on error.
</p>
<p class="pBody"><a name="wp1081209"> </a>
If you issue this function when the client is running in <code class="cCode">SIGNAL</code>-based, thread-based notification mode, or is ignoring unsolicited messages, the function has no impact and returns immediately.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1081229"> </a>
Subscribing to Events
</h2><p class="pBody"><a name="wp1081230"> </a>
The <a href="../rf3c/rf3c.html">tpsubscribe(3c)</a> function enables an Oracle Tuxedo system ATMI client or server to subscribe to an event. 
</p>
<p class="pBody"><a name="wp1081231"> </a>
A subscriber can be notified through an unsolicited notification message, a service call, a reliable queue, or other notification methods configured by the application administrator. (For information about configuring alternative notification methods, refer to <em class="cEmphasis">Setting Up an Oracle Tuxedo Application</em>.)
</p>
<p class="pBody"><a name="wp1081235"> </a>
Use the following signature to call the <code class="cCode">tpsubscribe()</code> function:
</p>
<a name="wp1112299"> </a><div class="pPreformatted"><pre>long handle<br />tpsubscribe (char *<code class="cCodeEmphasis">eventexpr</code>, char *<code class="cCodeEmphasis">filter</code>, TPEVCTL *<code class="cCodeEmphasis">ctl</code>, long <code class="cCodeEmphasis">flags</code>)</pre></div><p class="pBody"><a name="wp1112300"> </a>
<a href="pgevb.html#wp686247">Table&#160;8-5</a> describes the arguments to the <code class="cCode">tpsubscribe()</code> function.
</p>
<p class="pGraphic"><a name="wp1112354"> </a>
</p>
<div align="left">
<table class="table" cellpadding="3" cellspacing="0" id="wp686247table1112301"><caption><a name="wp686247"> </a>
Table 8-5  tpsubscribe( ) Function Arguments

</caption>

  <tr bgcolor="#CCCCCC" align="center" valign="top">    <th scope="col"><div class="pCellHeading"><a name="wp1112303"> </a>
Argument
</div>
</th>
    <th scope="col"><div class="pCellHeading"><a name="wp1112305"> </a>
Description
</div>
</th>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112307"> </a>
<code class="cCodeEmphasis">eventexpr</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112309"> </a>
Pointer to a set of one or more events to which a process can subscribe. Consists of a NULL-terminated string of up to 255 characters containing a regular expression. Regular expressions are of the form specified in <a href="../rf3c/rf3c.html">tpsubscribe(3c)</a>, as described in the <em class="cEmphasis">Oracle Tuxedo ATMI C Function Reference</em>). For example, if <code class="cCodeEmphasis">eventexpr</code> is set to:
</div>
<div class="pSmartList1TableBullet"><ul class="SmartList1TableBullet">
<li><a name="wp1112316"> </a><code class="cCode">&quot;\\..*&quot;</code>&#8212;the caller is subscribing to all system-defined events.</li>
<li><a name="wp1112317"> </a><code class="cCode">&quot;\\.SysServer.*&quot;</code>&#8212;the caller is subscribing to all system-defined events related to servers.</li>
<li><a name="wp1112318"> </a><code class="cCode">&quot;[A-Z].*&quot;</code>&#8212;the caller is subscribing to all user events starting with any uppercase letter between A and Z.</li>
<li><a name="wp1112319"> </a><code class="cCode">&quot;.*(ERR|err).*&quot;</code>&#8212;the caller is subscribing to all user events with names that contain either <code class="cCode">err</code> or <code class="cCode">ERR</code>, such as the <code class="cCode">account_error</code> and <code class="cCode">ERROR_STATE</code> events, respectively.</li>
</ul></div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112321"> </a>
<code class="cCodeEmphasis">filter</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112323"> </a>
Pointer to a string containing a Boolean filter rule that must be evaluated successfully before the EventBroker posts the event. Upon receiving an event to be posted, the EventBroker applies the filter rule, if one exists, to the posted event&#8217;s data. If the data passes the filter rule, the EventBroker invokes the notification method specified; otherwise, the EventBroker ignores the notification method. The caller can subscribe to the same event multiple times with different filter rules.
</div>
<p class="pBody"><a name="wp1112324"> </a>
By using the event-filtering capability, subscribers can discriminate among the events about which they are notified. For example, a poster can post an event for withdrawals greater than $10,000, but a subscriber may want to specify a higher threshold for being notified, such as $50,000. Or, a subscriber may want to be notified of large withdrawals made by specific customers.
</p>
<div class="pCellBody"><a name="wp1112325"> </a>
Filter rules are specific to the typed buffers to which they are applied. For more information on filter rules, refer to <a href="../rf3c/rf3c.html">tpsubscribe(3c)</a> in the <em class="cEmphasis">Oracle Tuxedo ATMI C Function Reference</em>.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112333"> </a>
<code class="cCodeEmphasis">ctl</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112335"> </a>
Pointer to a flag for controlling how a subscriber is notified of an event. Valid values include:
</div>
<div class="pSmartList1TableBullet"><ul class="SmartList1TableBullet">
<li><a name="wp1112338"> </a>NULL&#8212;sends unsolicited messages. Refer to <a href="pgevb.html#wp1112467">Notification via Unsolicited Message</a> for more information.</li>
<li><a name="wp1112340"> </a>Pointer to a valid <code class="cCode">TPEVCTL</code> structure&#8212;sends information based on the <code class="cCode">TPEVCTL</code> structure. Refer to <a href="pgevb.html#wp1112474">Notification via Service Call or Reliable Queue</a> for more information.</li>
</ul></div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112345"> </a>
<code class="cCodeEmphasis">flags</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112347"> </a>
Flag options. For more information on available flag options, refer to <a href="../rf3c/rf3c.html">tpsubscribe(3c)</a> in the <em class="cEmphasis">Oracle Tuxedo ATMI C Function Reference</em>.
</div>
</td>
</tr>
</table>
</div>
<p class="pGraphic">

</p>
<p class="pBody"><a name="wp1081336"> </a>
You can subscribe to both system- and application-defined events using the <code class="cCode">tpsubscribe</code>() function.
</p>
<p class="pBody"><a name="wp1081337"> </a>
For purposes of subscriptions (and for <code class="cCode">MIB</code> updates), service routines executed in an Oracle Tuxedo system server process are considered to be trusted code. 
</p>
<h4 class="pHeading3"><a name="wp1112467"> </a>
Notification via Unsolicited Message
</h4>
<p class="pBody"><a name="wp1112468"> </a>
If a subscriber is an Oracle Tuxedo system client process and <code class="cCodeEmphasis">ctl</code> is NULL, when the event to which the client has subscribed is posted, the EventBroker sends an unsolicited message to the subscriber as follows. When an event name is posted that evaluates successfully against <code class="cCodeEmphasis">eventexpr</code>, the EventBroker tests the posted data against the associated filter rule. If the data passes the filter rule (or if there is no filter rule for the event), then the subscriber receives an unsolicited notification along with any data posted with the event.
</p>
<p class="pBody"><a name="wp1112469"> </a>
In order to receive unsolicited notifications, the client must register an unsolicited message handling routine using the <a href="pgevb.html#wp1081079">tpsetunsol()</a> function.
</p>
<p class="pBody"><a name="wp1112471"> </a>
ATMI clients receiving event notification via unsolicited messages should remove their subscriptions from the EventBroker list of active subscriptions before exiting. This is done using the <a href="pgevb.html#wp1081383">tpunsubscribe()</a> function.
</p>
<h4 class="pHeading3"><a name="wp1112474"> </a>
Notification via Service Call or Reliable Queue
</h4>
<p class="pBody"><a name="wp1112475"> </a>
Event notification via <em class="cEmphasis">service call</em> enables you to program actions that can be taken in response to specific conditions in your application without human intervention. Event notification via <em class="cEmphasis">reliable queue</em> ensures that event data is not lost. It also provides the subscriber the flexibility of retrieving the event data at any time.
</p>
<p class="pBody"><a name="wp1112476"> </a>
If the subscriber (either a client or a server process) wants event notifications sent to service routines or to stable-storage queues, then the <code class="cCodeEmphasis">ctl</code> parameter of <code class="cCode">tpsubscribe</code>() must point to a valid <code class="cCode">TPEVCTL</code> structure. 
</p>
<p class="pBody"><a name="wp1112477"> </a>
The <code class="cCode">TPEVCTL</code> structure contains the following elements: 
</p>
<a name="wp1112478"> </a><div class="pPreformatted"><pre>long   <code class="cCodeEmphasis">flags</code>;<br />char   <code class="cCodeEmphasis">name1</code>[127];<br />char   <code class="cCodeEmphasis">name2</code>[127];<br />TPQCTL <em class="cEmphasis">qctl</em>;</pre></div><p class="pBody"><a name="wp1112479"> </a>
<a href="pgevb.html#wp686293">Table&#160;8-6</a> summarizes the <code class="cCode">TPEVCTL</code> typed buffer data structure. 
</p>
<p class="pGraphic"><a name="wp1112513"> </a>
</p>
<div align="left">
<table class="table" cellpadding="3" cellspacing="0" id="wp686293table1112480"><caption><a name="wp686293"> </a>
Table 8-6  TPEVCTL Typed Buffer Format

</caption>

  <tr bgcolor="#CCCCCC" align="center" valign="top">    <th scope="col"><div class="pCellHeading"><a name="wp1112482"> </a>
Field
</div>
</th>
    <th scope="col"><div class="pCellHeading"><a name="wp1112484"> </a>
Description
</div>
</th>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112486"> </a>
<code class="cCodeEmphasis">flags</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112488"> </a>
Flag options. For more information on flags, refer to <a href="../rf3c/rf3c.html">tpsubscribe(3c)</a> in the <em class="cEmphasis">Oracle Tuxedo ATMI C Function Reference</em>. 
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112496"> </a>
<code class="cCodeEmphasis">name1</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112498"> </a>
Character string of 127 characters or fewer.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112500"> </a>
<code class="cCodeEmphasis">name2</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112502"> </a>
Character string of 127 characters or fewer.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112504"> </a>
<code class="cCodeEmphasis">qctl</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112506"> </a>
<code class="cCode">TPQCTL</code> structure. For more information, refer to <a href="../rf3c/rf3c.html">tpsubscribe(3c)</a> in the <em class="cEmphasis">Oracle Tuxedo ATMI C Function Reference</em>.
</div>
</td>
</tr>
</table>
</div>
<p class="pGraphic">

</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1081383"> </a>
Unsubscribing from Events
</h2><p class="pBody"><a name="wp1081384"> </a>
The <a href="../rf3c/rf3c.html">tpunsubscribe(3c)</a> function enables an Oracle Tuxedo system ATMI client or server to unsubscribe from an event. 
</p>
<p class="pBody"><a name="wp1081385"> </a>
Use the following signature to call the <code class="cCode">tpunsubscribe()</code> function:
</p>
<a name="wp1112579"> </a><div class="pPreformatted"><pre>int<br />tpunsubscribe (long <em class="cEmphasis">subscription</em>, long <em class="cEmphasis">flags</em>)</pre></div><p class="pBody"><a name="wp1112580"> </a>
<a href="pgevb.html#wp686322">Table&#160;8-7</a> describes the arguments to the <code class="cCode">tpunsubscribe()</code> function.
</p>
<p class="pGraphic"><a name="wp1112601"> </a>
</p>
<div align="left">
<table class="table" cellpadding="3" cellspacing="0" id="wp686322table1112581"><caption><a name="wp686322"> </a>
Table 8-7  tpunsubscribe( ) Function Arguments

</caption>

  <tr bgcolor="#CCCCCC" align="center" valign="top">    <th scope="col"><div class="pCellHeading"><a name="wp1112583"> </a>
Argument
</div>
</th>
    <th scope="col"><div class="pCellHeading"><a name="wp1112585"> </a>
Description
</div>
</th>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112587"> </a>
<code class="cCodeEmphasis">subscription</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112590"> </a>
Subscription handle returned by a call to <a href="pgevb.html#wp1081229">tpsubscribe()</a>.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112592"> </a>
<code class="cCodeEmphasis">flags</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112594"> </a>
Flag options. For more information on available flag options, refer to <a href="../rf3c/rf3c.html">tpunsubscribe(3c)</a> in the <em class="cEmphasis">Oracle Tuxedo ATMI C Function Reference</em>.
</div>
</td>
</tr>
</table>
</div>
<p class="pGraphic">

</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1081416"> </a>
Posting Events
</h2><p class="pBody"><a name="wp1081417"> </a>
The <a href="../rf3c/rf3c.html">tppost(3c)</a> function enables an Oracle Tuxedo ATMI client or server to post an event.
</p>
<p class="pBody"><a name="wp1081418"> </a>
Use the following signature to call the <code class="cCode">tppost()</code> function:
</p>
<a name="wp1112670"> </a><div class="pPreformatted"><pre>tppost(char *<code class="cCodeEmphasis">eventname</code>, char *<code class="cCodeEmphasis">data</code>, long <code class="cCodeEmphasis">len</code>, long <code class="cCodeEmphasis">flags</code>)</pre></div><p class="pBody"><a name="wp1112671"> </a>
<a href="pgevb.html#wp686363">Table&#160;8-8</a> describes the arguments to the <code class="cCode">tppost()</code> function.
</p>
<p class="pGraphic"><a name="wp1112700"> </a>
</p>
<div align="left">
<table class="table" cellpadding="3" cellspacing="0" id="wp686363table1112672"><caption><a name="wp686363"> </a>
Table 8-8  tppost( ) Function Arguments

</caption>

  <tr bgcolor="#CCCCCC" align="center" valign="top">    <th scope="col"><div class="pCellHeading"><a name="wp1112674"> </a>
Argument
</div>
</th>
    <th scope="col"><div class="pCellHeading"><a name="wp1112676"> </a>
Description
</div>
</th>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112678"> </a>
<code class="cCodeEmphasis">eventname</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112680"> </a>
Pointer to an event name containing up to 31 characters plus NULL. The first character cannot be a dot (&#8220;.&#8221;) because the dot is reserved as the first character in names of Oracle Tuxedo system-defined events. When defining event names, keep in mind that subscribers can use wildcard capabilities to subscribe to multiple events with a single function call. Using the same prefix for a category of related event names can be helpful.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112682"> </a>
<code class="cCodeEmphasis">data</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112685"> </a>
Pointer to a buffer previously allocated using the <a href="pgbuf.html#wp1262143">tpalloc()</a> function.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112687"> </a>
<code class="cCodeEmphasis">len</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112689"> </a>
Size of data buffer that should be posted with the event. If <code class="cCodeEmphasis">data</code> points to a buffer of a type that does not require a length to be specified (for example, an FML fielded buffer) or if you set it to NULL, the <code class="cCodeEmphasis">len</code> argument is ignored and the event is posted with no data.
</div>
</td>
</tr>
  <tr align="left" valign="top">    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112691"> </a>
<code class="cCodeEmphasis">flags</code>
</div>
</td>
    <td class="table" scope="row"><div class="pCellBody"><a name="wp1112693"> </a>
Flag options. For more information on available flag options, refer to <a href="../rf3c/rf3c.html">tppost(3c)</a> in the <em class="cEmphasis">Oracle Tuxedo ATMI C Function Reference</em>.
</div>
</td>
</tr>
</table>
</div>
<p class="pGraphic">

</p>
<p class="pBody"><a name="wp1112701"> </a>
<a href="pgevb.html#wp1112703">Listing&#160;8-2</a> illustrates an event posting taken from the Oracle Tuxedo system sample application <code class="cCode">bankapp</code>. This example is part of the <code class="cCode">WITHDRAWAL</code> service. One of the functions of the <code class="cCode">WITHDRAWAL</code> service is checking for withdrawals greater than $10,000 and posting an event called <code class="cCode">BANK_TLR_WITHDRAWAL</code>.
</p>
<div class="pCodeTitle"><a name="wp1112703"> </a>
Listing&#160;8-2	   Posting an Event with tppost( )
</div> <a name="wp1112704"> </a><div class="pPreformatted"><pre>.<br />.<br />.<br />/* Event logic related */<br />static float evt_thresh = 10000.00 ; /* default for event threshold */<br />static char  emsg[200] ;  /* used by event posting logic */<br />.<br />.<br />.<br />/* Post a BANK_TLR_WITHDRAWAL event ? */<br />if (amt &lt; evt_thresh) {<br />&#160;&#160;&#160;&#160;&#160;/* no event to post */<br />&#160;&#160;&#160;&#160;&#160;tpreturn(TPSUCCESS, 0,transb-&gt;data , 0L, 0);<br />}<br />/* prepare to post the event */<br />if ((Fchg (transf, EVENT_NAME, 0, &quot;BANK_TLR_WITHDRAWAL&quot;, (FLDLEN)0) == -1) ||<br />(Fchg (transf, EVENT_TIME, 0, gettime(), (FLDLEN)0) == -1) ||<br />(Fchg (transf, AMOUNT, 0, (char *)&amp;amt, (FLDLEN)0) == -1)) {<br />&#160;&#160;&#160;&#160;&#160;(void)sprintf (emsg, &quot;Fchg failed for event fields: %s&quot;,<br />&#160;&#160;&#160;&#160;&#160;Fstrerror(Ferror)) ;<br />}<br />/* post the event */<br />else if (tppost (&quot;BANK_TLR_WITHDRAWAL&quot;, /* event name */<br />(char *)transf, /* data */<br />0L,   /* len */<br />TPNOTRAN | TPSIGRSTRT) == -1) {<br />/* If event broker is not reachable, ignore the error */<br />&#160;&#160;&#160;&#160;&#160;if (tperrno != TPENOENT)<br />&#160;&#160;&#160;&#160;&#160;(void)sprintf (emsg, &quot;tppost failed: %s&quot;, tpstrerror (tperrno));<br />}</pre></div><p class="pBody"><a name="wp1112706"> </a>
This example simply posts the event to the EventBroker to indicate a noteworthy occurrence in the application. Subscription to the event by interested clients, who can then take action as required, is done independently.
</p>
<p>&nbsp;</p>
<hr noshade="noshade"/>
<h2 class="pHeading1"><a name="wp1112708"> </a>
Example of Event Subscription
</h2><p class="pBody"><a name="wp1112709"> </a>
The following example illustrates a portion of a <code class="cCode">bankapp</code> application server that subscribes to <code class="cCode">BANK_TLR_.*</code> events, which includes the <code class="cCode">BANK_TLR_WITHDRAWAL</code> event shown in the previous example, as well as any other event names beginning with <code class="cCode">BANK_TLR_</code>. When a matching event is posted, the application notifies the subscriber via a call to a service named <code class="cCode">WATCHDOG</code>.
</p>
<div class="pCodeTitle"><a name="wp1112711"> </a>
Listing&#160;8-3	   Subscribing to an Event with tpsubscribe( )
</div> <a name="wp1112712"> </a><div class="pPreformatted"><pre>.<br />.<br />.<br />/* Event Subscription handles */<br />static long sub_ev_largeamt = 0L ;<br />.<br />.<br />.<br />/* Preset default for option &#39;w&#39; - watchdog threshold */<br />(void)strcpy (amt_expr, &quot;AMOUNT &gt; 10000.00&quot;) ;<br />.<br />.<br />.<br />/*<br /> * Subscribe to the events generated<br /> * when a &quot;large&quot; amount is transacted.<br /> */<br />evctl.flags = TPEVSERVICE ;<br />(void)strcpy (evctl.name1, &quot;WATCHDOG&quot;) ;<br />/* Subscribe */<br />sub_ev_largeamt = tpsubscribe (&quot;BANK_TLR_.*&quot;,amt_expr,&amp;evctl,TPSIGRSTRT) ;<br />if (sub_ev_largeamt == -1L) {<br />&#160;&#160;&#160;&#160;&#160;(void)userlog (&quot;ERROR: tpsubscribe for event BANK_TLR_.* failed: %s&quot;,<br />&#160;&#160;&#160;&#160;&#160;tpstrerror(tperrno)) ;<br />&#160;&#160;&#160;&#160;&#160;return -1 ;<br />}<br />.<br />.<br />.<br />{<br />/* Unsubscribe to the subscribed events */<br />if (tpunsubscribe (sub_ev_largeamt, TPSIGRSTRT) == -1)<br />&#160;&#160;&#160;&#160;(void)userlog (&quot;ERROR: tpunsubscribe to event BANK_TLR_.* failed: %s&quot;,<br />&#160;&#160;&#160;&#160;tpstrerror(tperrno)) ;<br />&#160;&#160;&#160;&#160;return ;<br />}<br />/*<br />* Service called when a BANK_TLR_.* event is posted.<br />*/<br />void<br />#if defined(__STDC__) || defined(__cplusplus)<br />WATCHDOG(TPSVCINFO *transb)<br />#else<br />WATCHDOG(transb)<br />TPSVCINFO *transb;<br />#endif<br />{<br />FBFR *transf; /* fielded buffer of decoded message  */<br />/* Set pointr to TPSVCINFO data buffer  */<br />transf = (FBFR *)transb-&gt;data;<br />/* Print the log entry  to stdout */<br />(void)fprintf (stdout, &quot;%20s|%28s|%8ld|%10.2f\n&quot;,<br />Fvals (transf, EVENT_NAME, 0),<br />Fvals (transf, EVENT_TIME, 0),<br />Fvall (transf, ACCOUNT_ID, 0),<br />*( (float *)CFfind (transf, AMOUNT, 0, NULL, FLD_FLOAT)) );<br />/* No data should be returned by the event subscriber&#39;s svc routine */<br />tpreturn(TPSUCCESS, 0,NULL, 0L, 0);<br />}</pre></div>
 
<br/>
    <table id="SummaryNotReq2" width="100%" border="0" cellpadding="0" cellspacing="0">
      <tr> 
        <td>
&nbsp;
<a href="pgevb.html"><img id="LongDescNotReq7" src="/global_resources/images/backtop.gif" width="90" height="25" alt="Back to Top" title="Back to Top" border="0" /></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a accesskey="4" href="pgconv.html"><img id="LongDescNotReq8" src="/global_resources/images/prevtop.gif" border="0" alt="Previous" /></a>&nbsp;
<a accesskey="5" href="pgglob.html"><img id="LongDescNotReq9" src="/global_resources/images/nexttop.gif" border="0" alt="Next" /></a>
<script language="Javascript1.1" type="text/javascript">
Copyright();
</script>
<noscript><a href="http://edocs.bea.com/copyright.html">&copy; BEA Systems</a></noscript>
        </td>
      </tr>
    </table>

<!-- WebAnalytics BEGIN -->

<!--#include virtual="/global_resources/edocs_wt.html"-->
      
<!-- WebAnalytics END -->

  </body>
</html>
